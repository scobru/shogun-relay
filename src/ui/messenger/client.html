<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1.0"
    />
    <title>Pan Pot</title>
    <style>
      :root {
        --primary-color: #4285f4;
        --primary-dark: #3367d6;
        --secondary-color: #c084fc;
        --light-bg: #f3f4f6;
        --dark-bg: #0f0f0f;
        --dark-card: #1a1a1a;
        --darker-bg: #080808;
        --text-light: #f5f5f5;
        --text-dark: #374151;
        --secondary-text: #a0a0a0;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          "Segoe UI",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background-color: var(--dark-bg);
        color: var(--text-light);
        margin: 0 auto;
        padding: 20px;
        max-width: 900px;
        line-height: 1.6;
      }

      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4em;
      }

      .container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px 0;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 30px;
        padding: 20px 25px;
        background-color: var(--dark-card);
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border-left: 4px solid var(--primary-color);
        position: relative;
        transition:
          all 0.3s ease,
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .app-header:hover {
        box-shadow:
          0 12px 25px rgba(0, 0, 0, 0.25),
          0 0 15px rgba(66, 133, 244, 0.1);
        transform: translateY(-2px);
      }

      .app-header img {
        height: 100px;
        width: auto;
        margin-right: 20px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        transition:
          transform 0.5s ease,
          filter 0.5s ease;
      }

      .app-header:hover img {
        filter: drop-shadow(0 4px 6px rgba(66, 133, 244, 0.3));
        transform: scale(1.03);
      }

      .app-header .title-group {
        display: flex;
        flex-direction: column;
      }

      .app-header h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        letter-spacing: 1px;
        transition:
          color 0.3s ease,
          text-shadow 0.3s ease;
      }

      .app-header:hover h1 {
        color: var(--primary-color);
        text-shadow: 0 2px 10px rgba(66, 133, 244, 0.2);
      }

      .app-header h2 {
        font-size: 1rem;
        font-weight: 500;
        margin: 0;
        color: var(--secondary-color);
        letter-spacing: 0.5px;
        transition: color 0.3s ease;
      }

      .app-header:hover h2 {
        color: #d8a6ff;
      }

      .encryption-badge {
        background-color: rgba(16, 185, 129, 0.15);
        color: var(--success);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        margin-left: auto;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .app-header:hover .encryption-badge {
        background-color: rgba(16, 185, 129, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .encryption-badge svg {
        width: 18px;
        height: 18px;
        margin-right: 6px;
        color: var(--success);
      }

      #chat,
      #privateChat {
        border: 1px solid rgba(55, 65, 81, 0.3);
        background-color: var(--dark-card);
        height: 400px;
        overflow-y: scroll;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) var(--dark-card);
        transition: all 0.3s ease;
      }

      #chat:hover,
      #privateChat:hover {
        box-shadow:
          0 6px 16px rgba(0, 0, 0, 0.2),
          0 0 10px rgba(66, 133, 244, 0.05);
        border-color: rgba(66, 133, 244, 0.2);
      }

      #chat::-webkit-scrollbar,
      #privateChat::-webkit-scrollbar {
        width: 6px;
      }

      #chat::-webkit-scrollbar-track,
      #privateChat::-webkit-scrollbar-track {
        background: var(--dark-card);
      }

      #chat::-webkit-scrollbar-thumb,
      #privateChat::-webkit-scrollbar-thumb {
        background-color: var(--primary-color);
        border-radius: 20px;
      }

      .message {
        margin: 8px 0;
        background-color: #2a2a2a;
        padding: 12px 15px;
        border-radius: 12px;
        border-bottom-left-radius: 2px;
        max-width: 85%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        word-break: break-word;
        animation: fadeIn 0.3s ease-in-out;
        border-left: 2px solid var(--primary-color);
        transition: all 0.2s ease;
      }

      .message:hover {
        background-color: #303030;
        box-shadow:
          0 4px 8px rgba(0, 0, 0, 0.15),
          0 0 4px rgba(66, 133, 244, 0.1);
        transform: translateY(-1px);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .system-message {
        background-color: #242424 !important;
        color: var(--secondary-text) !important;
        text-align: center !important;
        font-style: italic !important;
        padding: 8px 15px !important;
        margin: 10px auto !important;
        border-radius: 20px !important;
        max-width: 90% !important;
        font-size: 0.9em;
        border-left: none !important;
        transition: all 0.2s ease;
      }

      .system-message:hover {
        background-color: #2a2a2a !important;
        color: var(--text-light) !important;
      }

      .private-message {
        margin: 8px 0;
        background-color: rgba(59, 130, 246, 0.1);
        padding: 12px 15px;
        border-radius: 12px;
        border-bottom-right-radius: 2px;
        border-left: none;
        border-right: 2px solid var(--info);
        max-width: 85%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        word-break: break-word;
        transition: all 0.2s ease;
      }

      .private-message:hover {
        background-color: rgba(59, 130, 246, 0.15);
        box-shadow:
          0 4px 8px rgba(0, 0, 0, 0.15),
          0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
      }

      .user {
        font-weight: 600;
        color: var(--secondary-color);
        margin-right: 5px;
      }

      .time {
        color: var(--secondary-text);
        font-size: 0.75em;
        margin-right: 5px;
      }

      .encrypted-badge {
        display: inline-block;
        background-color: rgba(16, 185, 129, 0.2);
        color: var(--success);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.7em;
        margin-left: 5px;
        vertical-align: middle;
        transition: all 0.2s ease;
      }

      .encrypted-badge:hover {
        background-color: rgba(16, 185, 129, 0.3);
        transform: translateY(-1px);
      }

      .private-badge {
        display: inline-block;
        background-color: rgba(59, 130, 246, 0.2);
        color: var(--info);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.7em;
        margin-left: 5px;
        vertical-align: middle;
        transition: all 0.2s ease;
      }

      .private-badge:hover {
        background-color: rgba(59, 130, 246, 0.3);
        transform: translateY(-1px);
      }

      #peers {
        margin: 10px 0;
        padding: 6px 12px;
        font-size: 0.85em;
        color: var(--text-light);
        background-color: var(--dark-card);
        border-radius: 20px;
        display: inline-block;
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }

      #peers:hover {
        background-color: #252525;
        border-color: rgba(66, 133, 244, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }

      #status {
        margin-bottom: 15px;
        color: var(--success);
        font-weight: 500;
        transition: color 0.3s ease;
      }

      input,
      textarea {
        background-color: rgba(26, 26, 26, 0.8);
        color: var(--text-light);
        border: 1px solid #374151;
        padding: 12px 16px;
        margin-right: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-family: inherit;
        font-size: 1em;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        transform: translateY(-1px);
      }

      input:hover,
      textarea:hover {
        border-color: rgba(66, 133, 244, 0.5);
        background-color: rgba(30, 30, 30, 0.8);
      }

      #chatForm input,
      #privateMessageForm input {
        width: calc(100% - 110px);
      }

      button {
        padding: 10px 16px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: inherit;
        font-size: 1em;
        position: relative;
        overflow: hidden;
      }

      button:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
      }

      button:active {
        transform: translateY(1px);
      }

      button:disabled {
        background-color: #6b7280;
        cursor: not-allowed;
        opacity: 0.6;
        transform: none !important;
        box-shadow: none !important;
      }

      button:after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
      }

      button:focus:not(:active)::after {
        animation: ripple 1s ease-out;
      }

      @keyframes ripple {
        0% {
          opacity: 0.5;
          transform: scale(0, 0) translate(-50%, -50%);
        }
        100% {
          opacity: 0;
          transform: scale(20, 20) translate(-50%, -50%);
        }
      }

      .mode-selector {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
      }

      .mode-selector button {
        padding: 12px 20px;
        width: 180px;
        font-size: 1.05em;
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .mode-selector button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(66, 133, 244, 0.3);
      }

      #shareLink {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1200;
        width: 90%;
        max-width: 500px;
        padding: 30px;
        background-color: var(--dark-card);
        border: 1px solid rgba(66, 133, 244, 0.2);
        border-radius: 16px;
        box-shadow:
          0 15px 35px rgba(0, 0, 0, 0.5),
          0 0 15px rgba(66, 133, 244, 0.2);
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: var(--secondary-text);
        cursor: pointer;
        padding: 5px;
        font-size: 1.2em;
        line-height: 1;
        transition:
          color 0.2s ease,
          transform 0.2s ease;
      }

      .close-button:hover {
        color: var(--text-light);
        transform: rotate(90deg);
      }

      .hidden {
        display: none !important;
      }

      h2,
      h3 {
        margin-top: 0;
        color: var(--text-light);
        font-weight: 600;
      }

      h3 {
        margin-bottom: 15px;
        font-size: 1.3em;
        color: var(--primary-color);
      }

      #roomInfo {
        margin-bottom: 15px;
        font-weight: 500;
        background-color: var(--dark-card);
        padding: 10px 15px;
        border-radius: 10px;
        display: inline-block;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      #roomInfo:hover {
        border-color: rgba(66, 133, 244, 0.3);
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.15),
          0 0 8px rgba(66, 133, 244, 0.1);
        transform: translateY(-2px);
      }

      #currentRoomId {
        color: var(--secondary-color);
        font-family: monospace;
        padding: 3px 6px;
        background-color: rgba(192, 132, 252, 0.1);
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      #roomInfo:hover #currentRoomId {
        background-color: rgba(192, 132, 252, 0.2);
      }

      #encryptionStatus {
        color: var(--success);
        font-weight: 500;
        margin-bottom: 15px;
        padding: 8px 15px;
        background-color: rgba(16, 185, 129, 0.1);
        border-radius: 20px;
        display: inline-block;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      #encryptionStatus:hover {
        background-color: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.3);
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.1),
          0 0 8px rgba(16, 185, 129, 0.1);
        transform: translateY(-2px);
      }

      .error {
        color: var(--danger);
        background-color: rgba(239, 68, 68, 0.1);
        padding: 10px 15px;
        margin: 10px 0;
        border-radius: 10px;
        font-weight: 500;
        border-left: 3px solid var(--danger);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .error:hover {
        background-color: rgba(239, 68, 68, 0.15);
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.15),
          0 0 8px rgba(239, 68, 68, 0.1);
        transform: translateY(-1px);
      }

      .share-title {
        font-size: 1.4em;
        margin-bottom: 10px;
        color: var(--primary-color);
      }

      .share-description {
        margin-bottom: 15px;
        color: var(--secondary-text);
      }

      .share-warning {
        margin: 15px 0;
        padding: 10px 15px;
        background-color: rgba(245, 158, 11, 0.1);
        border-left: 3px solid var(--warning);
        border-radius: 8px;
        font-size: 0.85em;
        color: var(--secondary-text);
        transition: all 0.3s ease;
      }

      .share-warning:hover {
        background-color: rgba(245, 158, 11, 0.15);
        color: var(--text-light);
        transform: translateY(-1px);
      }

      .qr-badge {
        position: absolute;
        top: -12px;
        right: -12px;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      #qrcode-container:hover .qr-badge {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      #qrcode-container {
        position: relative;
        background-color: white;
        border-radius: 12px;
        padding: 15px;
        margin: 20px auto;
        max-width: 220px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      #qrcode-container:hover {
        transform: translateY(-3px);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.2),
          0 0 10px rgba(66, 133, 244, 0.2);
      }

      canvas {
        margin: 10px auto;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .qr-code-text {
        margin-top: 10px;
        font-size: 0.9em;
        color: var(--text-dark);
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
      }

      .share-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: center;
      }

      #copyLink {
        background-color: var(--info);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      #copyLink svg {
        width: 18px;
        height: 18px;
      }

      #copyLink:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
      }

      #shareLinkInput {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid rgba(75, 85, 99, 0.4);
        background-color: rgba(31, 41, 55, 0.7);
        color: white;
        font-family: monospace;
        font-size: 0.95em;
        text-align: center;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      #shareLinkInput:hover,
      #shareLinkInput:focus {
        border-color: rgba(66, 133, 244, 0.5);
        background-color: rgba(31, 41, 55, 0.9);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      #joinForm {
        background-color: var(--dark-card);
        padding: 25px;
        border-radius: 16px;
        margin-bottom: 25px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }

      #joinForm:hover {
        border-color: rgba(66, 133, 244, 0.2);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.2),
          0 0 10px rgba(66, 133, 244, 0.1);
        transform: translateY(-2px);
      }

      #userSetup {
        background-color: var(--dark-card);
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 25px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }

      #userSetup:hover {
        border-color: rgba(66, 133, 244, 0.2);
        box-shadow:
          0 8px 20px rgba(0, 0, 0, 0.2),
          0 0 10px rgba(66, 133, 244, 0.1);
        transform: translateY(-2px);
      }

      #chatForm,
      #privateMessageForm {
        display: flex;
        margin-top: 15px;
      }

      .user-list {
        background-color: var(--dark-card);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }

      .user-list:hover {
        border-color: rgba(66, 133, 244, 0.2);
        box-shadow:
          0 6px 15px rgba(0, 0, 0, 0.15),
          0 0 8px rgba(66, 133, 244, 0.1);
      }

      .user-item {
        padding: 8px 12px;
        margin-bottom: 5px;
        background-color: rgba(31, 41, 55, 0.6);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .user-item:hover {
        background-color: rgba(66, 133, 244, 0.2);
        transform: translateY(-1px);
      }

      .user-item.selected {
        background-color: rgba(66, 133, 244, 0.3);
        border-left: 3px solid var(--primary-color);
      }

      .tab-header {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(55, 65, 81, 0.3);
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        color: var(--secondary-text);
      }

      .tab:hover {
        color: var(--text-light);
        border-color: rgba(66, 133, 244, 0.3);
      }

      .tab.active {
        color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 600;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 999;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        color: white;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      @media (max-width: 600px) {
        body {
          padding: 10px;
        }

        .app-header {
          padding: 15px;
          flex-direction: column;
          text-align: center;
        }

        .app-header img {
          margin-right: 0;
          margin-bottom: 10px;
        }

        .encryption-badge {
          margin: 10px auto 0;
        }

        .mode-selector {
          flex-direction: column;
          gap: 10px;
        }

        .mode-selector button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="app-header">
        <img src="./shogun.svg" alt="Shogun Logo" />
        <div class="title-group">
          <h1>PAN POT</h1>
          <h2>P2P encrypted communication</h2>
        </div>
        <div class="encryption-badge">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            viewBox="0 0 16 16"
          >
            <path
              d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"
            />
          </svg>
          Encrypted
        </div>
      </div>

      <!-- Selezione della modalità -->
      <div class="mode-selector" id="modeSelector">
        <button id="createRoomBtn">Create New Room</button>
        <button id="joinRoomBtn">Join Room</button>
      </div>

      <!-- Form per unirsi ad una stanza -->
      <div id="joinForm" class="hidden">
        <input
          type="text"
          id="roomId"
          placeholder="Inserisci l'ID della stanza"
          style="width: 70%"
        />
        <button id="joinRoomSubmit">Join</button>
      </div>

      <!-- Link da condividere per la stanza creata -->
      <div id="shareLink" class="hidden">
        <button
          class="close-button"
          id="closeShareLink"
          onclick="hideSharePanel()"
        >
          &times;
        </button>
        <h3 class="share-title">Invite people to this room</h3>
        <p class="share-description">
          Invite other people to this room by sharing the link below or scanning
          the QR code.
        </p>
        <input
          type="text"
          id="shareLinkInput"
          readonly
          onclick="this.select();"
        />
        <div class="share-warning">
          <span
            >⚠️ Attention: The link contains the encryption key. Share it only
            with who you want to participate in the chat.</span
          >
        </div>
        <div id="qrcode-container">
          <span class="qr-badge">Scan</span>
          <!-- QR code will be generated here -->
        </div>
        <div class="share-actions">
          <button id="copyLink" onclick="copyShareLink()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
              />
            </svg>
            Copy Link
          </button>
        </div>
      </div>

      <!-- Informazioni sulla stanza corrente e stato crittografia -->
      <div id="roomInfo" class="hidden">
        Room: <span id="currentRoomId"></span>
        <button
          id="showShareOptions"
          class="share-button"
          onclick="showSharePanel()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            viewBox="0 0 16 16"
          >
            <path
              d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"
            />
          </svg>
          Share
        </button>
      </div>
      <div id="encryptionStatus" class="hidden">
        🔒 End-to-end encrypted messages
      </div>

      <div id="status">Select an option</div>
      <div id="peers" class="hidden">Connected peers: 0</div>

      <!-- Configurazione identità utente -->
      <div id="userSetup" class="hidden">
        <input
          type="text"
          id="username"
          placeholder="Username"
          required
          style="width: 60%"
        />
        <button id="setUsername">Set Username</button>
      </div>

      <!-- Tabs per chat della stanza e messaggi privati -->
      <div id="chatTabs" class="tab-container hidden">
        <button class="tab-button active" onclick="showTab('roomChatTab')">
          Room Chat
        </button>
        <button class="tab-button" onclick="showTab('privateChatTab')">
          Private Messages
        </button>
      </div>

      <!-- Tab content per la chat della stanza -->
      <div id="roomChatTab" class="tab-content" style="display: block">
        <!-- Area dove verranno visualizzati i messaggi della stanza -->
        <div id="chat"></div>

        <!-- Form per l'invio dei messaggi della stanza -->
        <form id="chatForm">
          <input type="text" id="message" placeholder="Message" required />
          <button type="submit">Send</button>
        </form>
      </div>

      <!-- Tab content per i messaggi privati -->
      <div id="privateChatTab" class="tab-content">
        <h3>Users in the room</h3>
        <div id="userList" class="user-list">
          <div class="user-item">No users available</div>
        </div>

        <div id="privateChat"></div>

        <form id="privateMessageForm">
          <input
            type="text"
            id="privateMessage"
            placeholder="Private message"
            required
            disabled
          />
          <button type="submit" disabled>Send</button>
        </form>
      </div>
    </div>

    <!-- Includi GunDB e le sue estensioni -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
    <!-- Includi QRCode.js per la generazione di QR code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shogun-core/dist/browser/shogun-core.js"></script>

    <script>
      // Ottieni il contatore dei peer
      let peerCount = 0;

      // Funzioni globali per gestire il pannello di condivisione
      window.showSharePanel = function () {
        console.log("Attivazione pannello di condivisione");

        // Usa l'approccio diretto per mostrare il pannello
        showDirectlySharePanel();
      };

      // Funzione alternativa per mostrare il pannello direttamente
      function showDirectlySharePanel() {
        console.log("Show ");

        // Ottieni riferimenti agli elementi
        var sharePanel = document.getElementById("shareLink");
        var overlay = document.getElementById("shareOverlay");

        // Debugging
        console.log("Pannello ottenuto:", sharePanel);
        console.log("Overlay ottenuto:", overlay);

        if (!sharePanel) {
          console.error("Elemento pannello non trovato!");
          return;
        }

        // Rimuovi la classe hidden
        sharePanel.classList.remove("hidden");

        // Prima mostra l'overlay
        overlay.style.display = "flex";
        overlay.innerHTML =
          "<div style='padding: 20px; background-color: rgba(255,255,255,0.8); color: black; border-radius: 10px;'>Caricamento pannello...</div>";

        // Poi mostra il pannello
        setTimeout(function () {
          // Imposta tutti i parametri di visibilità
          sharePanel.style.display = "block";
          sharePanel.style.visibility = "visible";
          sharePanel.style.opacity = "1";
          sharePanel.style.zIndex = "2000";

          console.log("Pannello mostrato:", sharePanel.style.display);
          console.log("Classi pannello:", sharePanel.className);

          // Aggiorna il link
          var shareLinkInput = document.getElementById("shareLinkInput");
          if (shareLinkInput) {
            shareLinkInput.value = window.location.href;
          }

          // Genera il QR code
          try {
            window.generateQRCode(window.location.href);
            console.log("QR code generato");
          } catch (e) {
            console.error("Errore generazione QR:", e);
          }

          // Pulisci l'overlay
          overlay.innerHTML = "";
        }, 300);
      }

      window.hideSharePanel = function () {
        var sharePanel = document.getElementById("shareLink");
        var overlay = document.getElementById("shareOverlay");

        sharePanel.style.display = "none";
        overlay.style.display = "none";

        // Non aggiungiamo la classe hidden qui, altrimenti sarà difficile mostrarlo di nuovo
      };

      window.copyShareLink = function () {
        const shareLinkInput = document.getElementById("shareLinkInput");
        shareLinkInput.select();
        document.execCommand("copy");

        // Feedback visivo
        const copyButton = document.getElementById("copyLink");
        const originalText = copyButton.innerHTML;
        copyButton.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copiato!';

        setTimeout(() => {
          copyButton.innerHTML = originalText;
        }, 2000);
      };

      // Genera un ID univoco per questo peer
      const peerId =
        localStorage.getItem("chatPeerId") ||
        Math.random().toString(36).substring(2, 15);
      // Salva l'ID del peer nel localStorage
      localStorage.setItem("chatPeerId", peerId);

      // Cache per evitare duplicazione dei messaggi
      const processedMessages = new Set();
      const processedPrivateMessages = new Set();

      // Variabili globali
      let gun;
      let chat;
      let users;
      let privateMessages;
      let currentRoomId = "";
      let encryptionKey = ""; // Chiave per crittografare/decrittografare i messaggi
      let username = localStorage.getItem("chatUsername") || ""; // Recupera il nome utente dal localStorage
      let selectedUser = null; // Utente selezionato per i messaggi privati

      // Controlla se c'è un room ID e encryption key nell'URL
      const urlParams = parseUrlHash();

      if (urlParams.roomId) {
        // Se c'è un room ID nell'URL, uniamoci subito a quella stanza
        document.getElementById("modeSelector").style.display = "none";
        joinRoom(urlParams.roomId, urlParams.key);
      }

      // Funzione per cambiare tab
      function showTab(tabId) {
        const tabs = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabs.length; i++) {
          tabs[i].style.display = "none";
        }

        const buttons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < buttons.length; i++) {
          buttons[i].classList.remove("active");
        }

        document.getElementById(tabId).style.display = "block";

        // Attiva il pulsante corrispondente
        const index = tabId === "roomChatTab" ? 0 : 1;
        buttons[index].classList.add("active");
      }

      // Funzione per analizzare i parametri dall'hash dell'URL
      function parseUrlHash() {
        const hash = window.location.hash.substring(1);
        const parts = hash.split("&");
        const params = {};

        if (parts[0] && !parts[0].includes("=")) {
          // Formato semplice: #roomId oppure #roomId&key=xyz
          params.roomId = parts[0];

          // Cerca se c'è un parametro key
          const keyParam = parts.find((p) => p.startsWith("key="));
          if (keyParam) {
            params.key = keyParam.split("=")[1];
          }
        } else {
          // Formato con parametri: #roomId=abc&key=xyz
          parts.forEach((part) => {
            const keyValue = part.split("=");
            if (keyValue.length === 2) {
              params[keyValue[0]] = keyValue[1];
            }
          });
        }

        return params;
      }

      // Funzione per generare QR code
      window.generateQRCode = function (text) {
        console.log("Generazione QR code per:", text);
        const container = document.getElementById("qrcode-container");
        if (!container) {
          console.error("Contenitore QR code non trovato!");
          return;
        }

        // Pulisci il contenitore
        container.innerHTML = '<span class="qr-badge">Scannerizza</span>';

        try {
          // Genera il QR code
          QRCode.toCanvas(
            text,
            {
              width: 200,
              margin: 1,
              color: {
                dark: "#4CAF50",
                light: "#ffffff",
              },
            },
            function (error, canvas) {
              if (error) {
                console.error("Errore nella generazione del QR code:", error);
                container.innerHTML +=
                  '<div class="error">Errore nella generazione del QR code</div>';
                return;
              }
              container.appendChild(canvas);

              // Aggiungi un testo di spiegazione
              const explanation = document.createElement("div");
              explanation.className = "qr-code-text";
              explanation.textContent =
                "Scansiona questo QR code per unirti alla stanza";
              container.appendChild(explanation);

              console.log("QR code generato con successo!");
            }
          );
        } catch (e) {
          console.error("Eccezione durante generazione QR:", e);
          container.innerHTML +=
            '<div class="error">Impossibile generare il QR code: ' +
            e.message +
            "</div>";
        }
      };

      // Event listener per i pulsanti di selezione modalità
      document
        .getElementById("createRoomBtn")
        .addEventListener("click", createNewRoom);
      document
        .getElementById("joinRoomBtn")
        .addEventListener("click", function () {
          document.getElementById("modeSelector").style.display = "none";
          document.getElementById("joinForm").classList.remove("hidden");
          document.getElementById("status").textContent =
            "Inserisci l'ID della stanza per unirti";
        });

      document
        .getElementById("joinRoomSubmit")
        .addEventListener("click", function () {
          const roomId = document.getElementById("roomId").value.trim();
          if (roomId) {
            joinRoom(roomId);
          } else {
            alert("Per favore inserisci un ID stanza valido.");
          }
        });

      document
        .getElementById("copyLink")
        .addEventListener("click", function () {
          const shareLinkInput = document.getElementById("shareLinkInput");
          shareLinkInput.select();
          document.execCommand("copy");
          document.getElementById("copyLink").textContent = "Copiato!";
          setTimeout(() => {
            document.getElementById("copyLink").textContent = "Copia Link";
          }, 2000);
        });

      // Event listener per impostare il nome utente
      document
        .getElementById("setUsername")
        .addEventListener("click", function () {
          setUsername();
        });

      // Funzione per impostare il nome utente
      function setUsername() {
        const newUsername = document.getElementById("username").value.trim();

        if (!newUsername) {
          alert("Per favore inserisci un nome utente.");
          return;
        }

        // Verifica se l'username è già in uso
        let duplicateCount = 0;
        let usernameTaken = false;

        users.map().once((userData) => {
          if (
            userData &&
            userData.name === newUsername &&
            userData.id !== peerId
          ) {
            usernameTaken = true;
            duplicateCount++;
          }
        });

        // Se l'username è già in uso, aggiungi un numero
        if (usernameTaken) {
          username = `${newUsername}#${duplicateCount + 1}`;
          alert(
            `Il nome utente "${newUsername}" è già in uso. Ti è stato assegnato "${username}"`
          );
        } else {
          username = newUsername;
        }

        // Salva il nome utente nel localStorage
        localStorage.setItem("chatUsername", username);

        // Salva l'utente nel nodo degli utenti
        if (users) {
          users.get(peerId).put({
            id: peerId,
            name: username,
            online: true,
            lastSeen: Date.now(),
          });

          // Verifica che l'utente sia registrato correttamente
          setTimeout(() => {
            users.get(peerId).once((data) => {
              if (data && data.name === username) {
                console.log("Utente registrato correttamente:", data);
              } else {
                console.warn(
                  "L'utente potrebbe non essere stato registrato correttamente:",
                  data
                );
                // Riprova a registrare l'utente
                users.get(peerId).put({
                  id: peerId,
                  name: username,
                  online: true,
                  lastSeen: Date.now(),
                });
              }
            });
          }, 2000);
        } else {
          console.error("Il nodo users non è stato inizializzato");
        }

        // Disabilita l'input e il pulsante del nome utente
        document.getElementById("username").disabled = true;
        document.getElementById("setUsername").disabled = true;
        document.getElementById("setUsername").textContent =
          "Nome Utente Impostato";

        // Abilita i form di messaggi
        document.getElementById("message").disabled = false;
        document.getElementById("chatForm").querySelector("button").disabled =
          false;

        // Invia un messaggio di sistema per informare che l'utente è entrato
        try {
          const timestamp = Date.now();
          const systemMsgId = `system_${timestamp}`;
          const systemMsg = `${username} è entrato nella chat`;

          if (encryptionKey) {
            // Messaggio di sistema crittografato
            (async function () {
              const messageData = {
                user: "Sistema",
                text: systemMsg,
                timestamp: timestamp,
                system: true,
              };

              const encrypted = await SEA.encrypt(messageData, encryptionKey);

              chat.get(systemMsgId).put({
                encrypted: encrypted,
              });
            })();
          } else {
            // Messaggio di sistema in chiaro
            chat.get(systemMsgId).put({
              user: "Sistema",
              text: systemMsg,
              timestamp: timestamp,
              system: true,
            });
          }
        } catch (e) {
          console.error("Errore nell'invio del messaggio di sistema:", e);
        }
      }

      // Funzione per generare una chiave di crittografia casuale
      function generateEncryptionKey() {
        // Genera una stringa casuale di 32 caratteri (più sicura di una password semplice)
        const chars =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let key = "";
        for (let i = 0; i < 32; i++) {
          key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return key;
      }

      // Funzione per creare una nuova stanza
      function createNewRoom() {
        // Genera un ID casuale per la stanza
        const roomId = Math.random().toString(36).substring(2, 12);

        // Genera una chiave di crittografia per la stanza
        const key = generateEncryptionKey();

        currentRoomId = roomId;
        encryptionKey = key;

        // Aggiungi l'ID stanza e la chiave all'URL
        window.location.hash = `${roomId}&key=${key}`;

        // Inizializza la chat per questa stanza
        initializeChat(roomId);

        // Mostra il link da condividere
        document.getElementById("modeSelector").style.display = "none";
        document.getElementById("shareLink").style.display = "block";
        document.getElementById("shareLinkInput").value = window.location.href;

        // Genera il QR code
        generateQRCode(window.location.href);

        // Aggiorna lo stato
        document.getElementById("status").textContent =
          "Hai creato una nuova stanza crittografata!";
        document.getElementById("roomInfo").classList.remove("hidden");
        document.getElementById("currentRoomId").textContent = roomId;
        document.getElementById("encryptionStatus").classList.remove("hidden");

        // Mostra l'interfaccia della chat
        showChatInterface();
      }

      // Funzione per unirsi a una stanza esistente
      function joinRoom(roomId, key) {
        currentRoomId = roomId;

        if (key) {
          // Se abbiamo una chiave, la usiamo per la crittografia
          encryptionKey = key;
          document
            .getElementById("encryptionStatus")
            .classList.remove("hidden");
        } else {
          // Nessuna chiave fornita, i messaggi non saranno decrittografati
          encryptionKey = "";
          document.getElementById("encryptionStatus").classList.add("hidden");
          document.getElementById("encryptionStatus").textContent =
            "⚠️ Chiave di crittografia mancante, impossibile decifrare i messaggi";
          document.getElementById("encryptionStatus").style.color = "#f44336";
        }

        // Aggiorna l'URL con l'ID stanza e la chiave se disponibile
        if (key) {
          window.location.hash = `${roomId}&key=${key}`;
        } else {
          window.location.hash = roomId;
        }

        // Inizializza la chat per questa stanza
        initializeChat(roomId);

        // Aggiorna lo stato
        document.getElementById("status").textContent =
          "Connessione alla stanza...";
        document.getElementById("joinForm").classList.add("hidden");
        document.getElementById("roomInfo").classList.remove("hidden");
        document.getElementById("currentRoomId").textContent = roomId;

        // Prepara il QR code e il link per la condivisione anche per chi si unisce alla stanza
        document.getElementById("shareLinkInput").value = window.location.href;
        try {
          generateQRCode(window.location.href);
        } catch (error) {
          console.error("Errore generazione QR code:", error);
        }

        // Mostra l'interfaccia della chat
        showChatInterface();

        // Debug - verifica che gli elementi siano effettivamente visibili
        console.log("Elementi visibili dopo joinRoom:");
        console.log(
          "- userSetup visible:",
          !document.getElementById("userSetup").classList.contains("hidden")
        );
        console.log(
          "- username disabled:",
          document.getElementById("username").disabled
        );
        console.log(
          "- setUsername disabled:",
          document.getElementById("setUsername").disabled
        );
      }

      // Funzione per mostrare l'interfaccia della chat
      function showChatInterface() {
        document.getElementById("userSetup").classList.remove("hidden");
        document.getElementById("chatTabs").classList.remove("hidden");
        document.getElementById("roomChatTab").style.display = "block";
        document.getElementById("peers").classList.remove("hidden");

        // Recupera il nome utente dal localStorage se esiste
        if (username) {
          document.getElementById("username").value = username;
          document.getElementById("username").disabled = true;
          document.getElementById("setUsername").disabled = true;
          document.getElementById("setUsername").textContent =
            "Nome Utente Impostato";

          // Abilita i form di messaggi
          document.getElementById("message").disabled = false;
          document.getElementById("chatForm").querySelector("button").disabled =
            false;

          // Registra l'utente nel nodo degli utenti
          if (users) {
            users.get(peerId).put({
              id: peerId,
              name: username,
              online: true,
              lastSeen: Date.now(),
            });
          }
        } else {
          // Se non c'è un nome utente, assicuriamoci che il campo username e il pulsante siano abilitati
          document.getElementById("username").disabled = false;
          document.getElementById("setUsername").disabled = false;

          // Disabilita i form di messaggi finché non viene impostato un nome utente
          document.getElementById("message").disabled = true;
          document.getElementById("chatForm").querySelector("button").disabled =
            true;

          // Evidenzia il campo username per attirare l'attenzione dell'utente
          document.getElementById("username").style.borderColor =
            "var(--primary-color)";
          document.getElementById("username").style.boxShadow =
            "0 0 0 2px rgba(99, 102, 241, 0.3)";

          // Mostra un messaggio di status
          document.getElementById("status").textContent =
            "Per favore imposta un nome utente per iniziare a chattare";
        }
      }

      // Funzione per inizializzare la chat con Gun per una stanza specifica
      function initializeChat(roomId) {
        // Inizializza Gun con storage locale e WebRTC per P2P

        const gunInstance = new Gun({
          peers: [
            "http://localhost:8765/gun",
          ],
          localStorage: false,
          radisk:false
        });

        const config = {
          gun: gunInstance,
        };

        console.log("Inizializzazione chat con configurazione:", config);

        // Chiudi l'istanza precedente di Gun se esiste
        if (gun) {
          try {
            gun.user().leave();
          } catch (e) {
            console.log("Nessun utente da disconnettere");
          }
        }

        const shogun = window.initShogunBrowser(config);
        gun = shogun.gun;

        // Aggiungi logging per debug
        gun.on("hi", (peer) => {
          console.log("Peer connesso:", peer);
          updatePeerCount();
          // Aggiorna lo stato quando almeno un peer si connette
          document.getElementById("status").textContent =
            "Connesso alla stanza";
          document.getElementById("status").style.color = "var(--success)";
        });

        gun.on("bye", (peer) => {
          console.log("Peer disconnesso:", peer);
          updatePeerCount();
        });

        // Seleziona il nodo per la chat della stanza specifica
        chat = gun.get(`chat-room-${roomId}`);
        console.log("Nodo chat creato:", `chat-room-${roomId}`);

        // Verifica la connessione dopo un breve ritardo
        setTimeout(() => {
          const gunPeers = gun?._.opt?.peers || {};
          const activePeers = Object.entries(gunPeers).filter(([id, peer]) => {
            return peer && peer.wire && peer.wire.hied !== "bye";
          });

          if (activePeers.length === 0) {
            document.getElementById("status").textContent =
              "Nessun peer connesso. Riprovo...";
            document.getElementById("status").style.color = "var(--warning)";
          }
        }, 5000);

        // Seleziona il nodo per gli utenti della stanza
        users = gun.get(`users-${roomId}`);
        console.log("Nodo utenti creato:", `users-${roomId}`);

        // Seleziona il nodo per i messaggi privati
        privateMessages = gun.get(`private-messages-${roomId}`);
        console.log(
          "Nodo messaggi privati creato:",
          `private-messages-${roomId}`
        );

        // Ascolta in tempo reale i nuovi messaggi della stanza
        chat.map().on(function (data, key) {
          console.log("Nuovo messaggio ricevuto:", key, data);
          if (data) {
            processMessage(data, key);
          }
        });

        // Ascolta la lista degli utenti
        users.map().on(function (userData, userId) {
          console.log("Utente aggiornato:", userId, userData);
          if (userData && userData.name) {
            updateUserList(userData, userId);
          }
        });

        // Ascolta i messaggi privati
        privateMessages.map().on(function (data, key) {
          console.log("Nuovo messaggio privato ricevuto:", key, data);
          if (data) {
            processPrivateMessage(data, key);
          }
        });

        // Registra l'utente corrente se è già impostato
        if (username) {
          users.get(peerId).put({
            id: peerId,
            name: username,
            online: true,
            lastSeen: Date.now(),
          });
        }
      }

      // Funzione per aggiornare la lista degli utenti
      function updateUserList(userData, userId) {
        // Non mostrare sé stessi nella lista
        if (userId === peerId) return;

        const userList = document.getElementById("userList");

        // Controlla se l'utente è già nella lista
        let userElement = document.querySelector(
          `.user-item[data-id="${userId}"]`
        );

        if (!userElement) {
          // Se l'utente non esiste, crea un nuovo elemento
          userElement = document.createElement("div");
          userElement.className = "user-item";
          userElement.setAttribute("data-id", userId);
          userElement.addEventListener("click", function () {
            selectUserForPrivateMessage(userId, userData.name);
          });

          userList.appendChild(userElement);
        }

        // Aggiorna lo stato online/offline
        const onlineStatus = userData.online ? "🟢" : "⚪";
        userElement.textContent = `${onlineStatus} ${userData.name}`;

        // Rimuovi il messaggio "Nessun utente disponibile" se ci sono utenti
        const noUsersMessage = userList.querySelector(
          ".user-item:not([data-id])"
        );
        if (noUsersMessage && userList.children.length > 1) {
          userList.removeChild(noUsersMessage);
        }
      }

      // Funzione per selezionare un utente per i messaggi privati
      function selectUserForPrivateMessage(userId, userName) {
        selectedUser = {
          id: userId,
          name: userName,
        };

        // Evidenzia l'utente selezionato
        const userItems = document.querySelectorAll(".user-item");
        userItems.forEach((item) => item.classList.remove("selected"));

        const selectedItem = document.querySelector(
          `.user-item[data-id="${userId}"]`
        );
        if (selectedItem) {
          selectedItem.classList.add("selected");
        }

        // Pulisci la chat privata e carica i messaggi con questo utente
        document.getElementById("privateChat").innerHTML = "";
        loadPrivateMessages(userId);

        // Abilita l'invio di messaggi privati
        document.getElementById("privateMessage").disabled = false;
        document
          .getElementById("privateMessageForm")
          .querySelector("button").disabled = false;
        document.getElementById("privateMessage").placeholder =
          `Messaggio per ${userName}`;
      }

      // Funzione per caricare i messaggi privati con un utente specifico
      function loadPrivateMessages(userId) {
        // Identifica la conversazione tra i due utenti (ordina gli ID per garantire consistenza)
        const conversationId = [peerId, userId].sort().join("_");

        // Carica i messaggi di questa conversazione
        privateMessages
          .get(conversationId)
          .map()
          .on(function (data, key) {
            if (data) {
              processPrivateMessage(data, key, conversationId);
            }
          });
      }

      // Funzione per elaborare un messaggio privato
      async function processPrivateMessage(data, key, conversationIdParam) {
        // Creare un ID completo per identificare il messaggio in modo univoco
        const conversationId =
          conversationIdParam ||
          (data.from && data.to ? [data.from, data.to].sort().join("_") : "");
        const fullKey = `${conversationId}_${key}`;

        // Evita di processare messaggi già visti
        if (processedPrivateMessages.has(fullKey)) return;
        processedPrivateMessages.add(fullKey);

        try {
          // Verifica se il messaggio è per/da questo utente
          if (data.to === peerId || data.from === peerId) {
            let decryptedContent;

            // Prova a decrittografare il messaggio
            if (data.encrypted && encryptionKey) {
              decryptedContent = await SEA.decrypt(
                data.encrypted,
                encryptionKey
              );
            }

            if (decryptedContent) {
              // Determinare il nome dell'utente con cui stiamo chattando
              const otherUserId = data.from === peerId ? data.to : data.from;
              const direction = data.from === peerId ? "sent" : "received";

              // Ottieni il nome dell'utente
              users.get(otherUserId).once(function (userData) {
                const otherUserName = userData
                  ? userData.name
                  : "Utente sconosciuto";

                // Se questo è l'utente selezionato, o è un messaggio che abbiamo inviato a qualcuno
                if (
                  selectedUser &&
                  (selectedUser.id === otherUserId || data.from === peerId)
                ) {
                  addPrivateMessage(
                    data.from === peerId ? "Tu" : otherUserName,
                    decryptedContent.text,
                    decryptedContent.timestamp,
                    direction
                  );
                }
              });
            }
          }
        } catch (error) {
          console.error("Errore nel processare il messaggio privato:", error);
        }
      }

      // Funzione per elaborare un messaggio (crittografato o meno)
      async function processMessage(data, key) {
        console.log("Processando messaggio:", key, data);

        // Se non c'è un payload, ignora
        if (!data) {
          console.log("Messaggio vuoto, ignorato");
          return;
        }

        // Verifica se il messaggio è già stato elaborato
        if (processedMessages.has(key)) {
          console.log("Messaggio già elaborato:", key);
          return;
        }

        try {
          // Controlla se il messaggio è crittografato
          if (data.encrypted && encryptionKey) {
            console.log("Tentativo di decrittazione del messaggio");
            const decrypted = await SEA.decrypt(data.encrypted, encryptionKey);
            console.log("Risultato decrittazione:", decrypted);

            if (
              decrypted &&
              decrypted.user &&
              decrypted.text &&
              decrypted.timestamp
            ) {
              console.log("Messaggio decrittato con successo");
              addMessage(
                decrypted.user,
                decrypted.text,
                decrypted.timestamp,
                key,
                true,
                decrypted.system || false
              );
              processedMessages.add(key);
            } else {
              console.error(
                "Messaggio decrittato ma mancano dati necessari:",
                decrypted
              );
            }
          } else if (data.user && data.text && data.timestamp) {
            console.log("Messaggio in chiaro ricevuto");
            addMessage(
              data.user,
              data.text,
              data.timestamp,
              key,
              false,
              data.system || false
            );
            processedMessages.add(key);
          } else {
            console.error("Messaggio non valido:", data);
          }
        } catch (error) {
          console.error("Errore nel processare il messaggio:", error);

          // Mostra un messaggio di errore nella chat
          const chatDiv = document.getElementById("chat");
          const errorDiv = document.createElement("div");
          errorDiv.className = "error";
          errorDiv.textContent = `Errore nel processare un messaggio: ${error.message}`;
          chatDiv.appendChild(errorDiv);

          // Aggiungi alla cache per evitare duplicazioni di errori
          processedMessages.add(key);
        }
      }

      // Funzione per aggiornare il conteggio dei peer
      function updatePeerCount() {
        // Ottieni i peer connessi da Gun
        const gunPeers = gun?._.opt?.peers || {};

        // Filtra i peer attivi (elimina quelli disconnessi)
        const activePeers = Object.entries(gunPeers).filter(([id, peer]) => {
          return peer && peer.wire && peer.wire.hied !== "bye";
        });

        peerCount = activePeers.length;

        // Aggiorna l'interfaccia
        document.getElementById("peers").textContent =
          `Connected peers: ${peerCount}`;
        console.log(
          "Active peers:",
          activePeers.map((p) => p[0])
        );
      }

      // Aggiorna il contatore dei peer ogni secondo
      setInterval(() => {
        if (gun) updatePeerCount();
      }, 1000);

      // Funzione per aggiungere un messaggio all'interfaccia
      function addMessage(user, text, timestamp, id, isEncrypted, isSystem) {
        // Crea un identificatore univoco per questo messaggio
        const messageId = id || `${user}_${timestamp}_${text.substring(0, 10)}`;

        // Controlla se il messaggio è già stato elaborato
        if (processedMessages.has(messageId)) {
          return; // Salta questo messaggio se è già stato elaborato
        }

        // Aggiungi alla cache dei messaggi elaborati - adesso questo viene fatto nel processMessage
        // per evitare duplicazioni durante l'elaborazione asincrona

        const chatDiv = document.getElementById("chat");
        const messageDiv = document.createElement("div");

        // Stile diverso per messaggi di sistema
        if (user === "Sistema" || isSystem) {
          messageDiv.className = "message system-message";
          messageDiv.style.backgroundColor = "#2c3e50";
          messageDiv.style.color = "#ecf0f1";
          messageDiv.style.textAlign = "center";
          messageDiv.style.fontStyle = "italic";
        } else {
          messageDiv.className = "message";
        }

        messageDiv.setAttribute("data-id", messageId);

        const time = new Date(timestamp).toLocaleTimeString();
        let html;

        if (user === "Sistema" || isSystem) {
          html = `<span class="time">[${time}]</span> ${text}`;
        } else {
          html = `<span class="time">[${time}]</span> <span class="user">${user}: </span>${text}`;
        }

        // Aggiungi badge di crittografia se il messaggio è crittografato
        if (isEncrypted && !(user === "Sistema" || isSystem)) {
          html += `<span class="encrypted-badge">🔒</span>`;
        }

        messageDiv.innerHTML = html;

        chatDiv.appendChild(messageDiv);
        // Auto-scroll in fondo alla chat
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }

      // Funzione per aggiungere un messaggio privato all'interfaccia
      function addPrivateMessage(user, text, timestamp, direction) {
        const privateChatDiv = document.getElementById("privateChat");
        const messageDiv = document.createElement("div");
        messageDiv.className = "private-message";

        const time = new Date(timestamp).toLocaleTimeString();
        let html = `<span class="time">[${time}]</span> <span class="user">${user}: </span>${text}`;
        html += `<span class="private-badge">🔐</span>`;

        messageDiv.innerHTML = html;

        // Aggiungere stile diverso per messaggi inviati/ricevuti
        if (direction === "sent") {
          messageDiv.style.marginLeft = "20px";
          messageDiv.style.borderLeftColor = "#4CAF50";
        } else {
          messageDiv.style.marginRight = "20px";
          messageDiv.style.borderLeftColor = "#0066cc";
        }

        privateChatDiv.appendChild(messageDiv);
        // Auto-scroll in fondo alla chat privata
        privateChatDiv.scrollTop = privateChatDiv.scrollHeight;
      }

      // Gestione dell'invio dei messaggi della stanza
      document
        .getElementById("chatForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!chat) {
            console.error("Chat non inizializzata!");
            alert("Devi prima creare o unirti a una stanza!");
            return;
          }

          if (!username) {
            console.error("Username non impostato!");
            alert(
              "Per favore imposta un nome utente prima di inviare messaggi."
            );
            return;
          }

          const text = document.getElementById("message").value.trim();
          if (!text) return;

          // Crea un ID univoco per il messaggio
          const timestamp = Date.now();
          const msgId = `${peerId}_${timestamp}`;

          try {
            console.log("Invio messaggio:", { text, timestamp, msgId });

            if (encryptionKey) {
              // Crea un oggetto con i dati del messaggio
              const messageData = {
                user: username,
                text: text,
                timestamp: timestamp,
                from: peerId,
              };

              console.log("Crittazione messaggio con chiave:", encryptionKey);
              // Crittografa il messaggio
              const encrypted = await SEA.encrypt(messageData, encryptionKey);
              console.log("Messaggio crittografato:", encrypted);

              // Aggiungi immediatamente il messaggio all'interfaccia
              addMessage(username, text, timestamp, msgId, true, false);
              processedMessages.add(msgId);

              // Salva solo la versione crittografata
              chat.get(msgId).put(
                {
                  encrypted: encrypted,
                },
                (ack) => {
                  console.log("Messaggio salvato:", ack);
                }
              );
            } else {
              console.log("Invio messaggio in chiaro");
              // Aggiungi immediatamente il messaggio all'interfaccia
              addMessage(username, text, timestamp, msgId, false, false);
              processedMessages.add(msgId);

              // Senza chiave, salva in chiaro
              chat.get(msgId).put(
                {
                  user: username,
                  text: text,
                  timestamp: timestamp,
                  from: peerId,
                },
                (ack) => {
                  console.log("Messaggio salvato:", ack);
                }
              );
            }

            // Pulisce il campo del messaggio
            document.getElementById("message").value = "";
          } catch (error) {
            console.error("Errore durante l'invio del messaggio:", error);
            alert("Errore durante l'invio del messaggio: " + error.message);
          }
        });

      // Gestione dell'invio dei messaggi privati
      document
        .getElementById("privateMessageForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!selectedUser) {
            alert("Seleziona un utente a cui inviare il messaggio privato.");
            return;
          }

          if (!username) {
            alert(
              "Per favore imposta un nome utente prima di inviare messaggi."
            );
            return;
          }

          const text = document.getElementById("privateMessage").value.trim();
          if (!text) return;

          // Crea un ID univoco per il messaggio
          const timestamp = Date.now();
          const msgId = `${peerId}_${timestamp}`;

          try {
            // Crea l'oggetto con i dati del messaggio
            const messageData = {
              text: text,
              timestamp: timestamp,
            };

            let encrypted;
            if (encryptionKey) {
              // Crittografa il messaggio con la chiave della stanza
              encrypted = await SEA.encrypt(messageData, encryptionKey);
            }

            // Identifica la conversazione tra i due utenti (ordina gli ID per garantire consistenza)
            const conversationId = [peerId, selectedUser.id].sort().join("_");

            // Mostra subito il messaggio nell'interfaccia
            addPrivateMessage("Tu", text, timestamp, "sent");

            // Registra questo ID nel set dei messaggi privati processati prima dell'invio
            const fullMsgId = `${conversationId}_${msgId}`;
            processedPrivateMessages.add(fullMsgId);

            // Salva il messaggio nel nodo dei messaggi privati
            privateMessages.get(conversationId).get(msgId).put({
              from: peerId,
              to: selectedUser.id,
              encrypted: encrypted,
              timestamp: timestamp,
            });

            // Pulisce il campo del messaggio
            document.getElementById("privateMessage").value = "";
          } catch (error) {
            console.error(
              "Errore durante l'invio del messaggio privato:",
              error
            );
            alert("Errore durante l'invio del messaggio privato crittografato");
          }
        });

      // Limita la dimensione della cache per evitare problemi di memoria
      setInterval(() => {
        // Mantieni solo gli ultimi 100 messaggi nella cache
        if (processedMessages.size > 100) {
          const toRemove = Array.from(processedMessages).slice(
            0,
            processedMessages.size - 100
          );
          toRemove.forEach((id) => processedMessages.delete(id));
        }

        // Stessa cosa per i messaggi privati
        if (processedPrivateMessages.size > 100) {
          const toRemove = Array.from(processedPrivateMessages).slice(
            0,
            processedPrivateMessages.size - 100
          );
          toRemove.forEach((id) => processedPrivateMessages.delete(id));
        }
      }, 60000); // Controlla ogni minuto
    </script>

    <script>
      // Assicuriamoci che il DOM sia completamente caricato prima di interagire con esso
      document.addEventListener("DOMContentLoaded", function () {
        // Verifica se i listener sono stati aggiunti correttamente
        console.log("DOM caricato completamente");

        // Aggiungi gestori di eventi aggiuntivi per sicurezza
        var shareBtnElement = document.getElementById("showShareOptions");
        if (shareBtnElement) {
          shareBtnElement.addEventListener("click", function () {
            console.log("Click su pulsante condividi rilevato");
            window.showSharePanel();
          });
        }

        var closeBtnElement = document.getElementById("closeShareLink");
        if (closeBtnElement) {
          closeBtnElement.addEventListener("click", function () {
            window.hideSharePanel();
          });
        }

        var copyBtnElement = document.getElementById("copyLink");
        if (copyBtnElement) {
          copyBtnElement.addEventListener("click", function () {
            window.copyShareLink();
          });
        }
      });
    </script>

    <!-- Aggiungiamo un overlay per rendere più evidente il pannello di condivisione -->
    <div class="overlay" id="shareOverlay" onclick="hideSharePanel()">
      <div>Caricamento in corso...</div>
    </div>

    <script>
      // Funzione di debug per forzare l'apertura del pannello
      function forceShowPanel() {
        console.log("Forza visualizzazione pannello");

        // Prendiamo riferimenti agli elementi
        var sharePanel = document.getElementById("shareLink");
        var overlay = document.getElementById("shareOverlay");

        if (!sharePanel) {
          console.error("Elemento shareLink non trovato!");
          alert("Elemento shareLink non trovato!");
          return;
        }

        // Semplificazione estrema: crea un nuovo pannello da zero
        var newPanel = document.createElement("div");
        newPanel.id = "emergencyPanel";
        newPanel.style.position = "fixed";
        newPanel.style.top = "50%";
        newPanel.style.left = "50%";
        newPanel.style.transform = "translate(-50%, -50%)";
        newPanel.style.backgroundColor = "#111827";
        newPanel.style.color = "white";
        newPanel.style.padding = "20px";
        newPanel.style.borderRadius = "10px";
        newPanel.style.zIndex = "9999";
        newPanel.style.width = "80%";
        newPanel.style.maxWidth = "400px";
        newPanel.style.border = "3px solid red";

        // Aggiungi contenuto minimo
        newPanel.innerHTML = `
          <h3 style="margin-bottom: 15px;">Condividi stanza</h3>
          <p style="margin-bottom: 15px;">Usa questo link per invitare altri alla chat:</p>
          <input type="text" id="emergencyLinkInput" value="${window.location.href}" 
            style="width: 100%; padding: 10px; margin-bottom: 15px; background-color: #374151; color: white; border: 1px solid #4b5563; border-radius: 5px;"
            onclick="this.select();" readonly>
          <div style="display: flex; justify-content: space-between;">
            <button id="emergencyCopyBtn" style="padding: 8px 16px; background-color: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
              Copia Link
            </button>
            <button id="emergencyCloseBtn" style="padding: 8px 16px; background-color: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
              Chiudi
            </button>
          </div>
        `;

        // Mostra l'overlay
        overlay.style.display = "flex";

        // Aggiungi il pannello al body
        document.body.appendChild(newPanel);

        // Aggiungi event listener
        document
          .getElementById("emergencyCopyBtn")
          .addEventListener("click", function () {
            var input = document.getElementById("emergencyLinkInput");
            input.select();
            document.execCommand("copy");
            this.textContent = "Copiato!";
            setTimeout(() => {
              this.textContent = "Copia Link";
            }, 2000);
          });

        document
          .getElementById("emergencyCloseBtn")
          .addEventListener("click", function () {
            document.body.removeChild(newPanel);
            overlay.style.display = "none";
          });

        console.log("Pannello di emergenza creato e mostrato");
      }
    </script>
  </body>
</html>
