services:
  shogun-relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shogun-relay-stack
    ports:
      - "8765:8765" # Relay Server
      - "5001:5001" # IPFS API
      - "8080:8080" # IPFS Gateway
      - "4001:4001" # IPFS Swarm
    volumes:
      # Persist IPFS data
      - ipfs-data:/data/ipfs
      # Persist relay data
      - relay-data:/app/relay/data
      # Mount logs for debugging
      - ./logs:/var/log/supervisor
    environment:
      - NODE_ENV=production
      - IPFS_PATH=/data/ipfs
      - DATA_DIR=/app/relay/data
      - ADMIN_PASSWORD=shogun2025
      - RELAY_HOST=localhost
      - RELAY_PORT=8765
      - RELAY_STORE=true
      - RELAY_PATH=public
      - RELAY_QR=true
      - RELAY_NAME=OP1
      - RELAY_PEERS=wss://ruling-mastodon-improved.ngrok-free.app/gun
      - RELAY_PROTECTED=false
      - IPFS_API_URL=http://127.0.0.1:5001
      - IPFS_GATEWAY_URL=http://127.0.0.1:8080
      - IPFS_API_TOKEN=shogun2025
      - IPFS_API_KEY=shogun2025
      - DISABLE_RADISK=false
      # Relay GunDB User (owns subscription data)
      - RELAY_GUN_USERNAME=shogun-relay
      - RELAY_GUN_PASSWORD=shogun2025
      # x402 Payment Configuration
      - X402_PAY_TO_ADDRESS=0xYourWalletAddressHere
      - X402_NETWORK=base-sepolia
      - X402_SETTLEMENT_MODE=direct
      # Required for direct settlement (private key of wallet that will execute transferWithAuthorization)
      # This wallet needs ETH for gas fees
      - X402_PRIVATE_KEY=your_private_key_here
      # Optional: Custom RPC URL
      # - X402_RPC_URL=https://your-rpc-url
      # On-Chain Registry Configuration
      # Private key for on-chain operations (registration, staking, deals)
      - RELAY_PRIVATE_KEY=0x_your_private_key_here
      # Chain ID: 84532 = Base Sepolia (testnet), 8453 = Base Mainnet
      - REGISTRY_CHAIN_ID=84532
      # Relay Storage Limits (global IPFS storage limit)
      - RELAY_MAX_STORAGE_GB=10
      - RELAY_STORAGE_WARNING_THRESHOLD=80
      # Holster Relay (WebSocket enhancement)
      - HOLSTER_RELAY_HOST=0.0.0.0
      # - HOLSTER_RELAY_PORT=8766
      - HOLSTER_RELAY_STORAGE=true
      - HOLSTER_RELAY_STORAGE_PATH=/app/relay/holster-data
      - HOLSTER_MAX_CONNECTIONS=100
      # Network Federation
      - AUTO_REPLICATION=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - shogun-network

volumes:
  ipfs-data:
    driver: local
  relay-data:
    driver: local

networks:
  shogun-network:
    driver: bridge
