services:
  shogun-relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shogun-relay-stack
    ports:
      - "8765:8765" # Relay Server
      - "5001:5001" # IPFS API
      - "8080:8080" # IPFS Gateway
      - "4001:4001" # IPFS Swarm
    volumes:
      # Persist IPFS data (repository, pins, blocks)
      - ipfs-data:/data/ipfs
      # Persist GunDB data (SQLite DB or radata files)
      - relay-data:/app/relay/data
      # Persist relay keys (SEA keypair for relay user)
      - relay-keys:/app/keys
      # Persist Holster data (if Holster is enabled)
      - holster-data:/app/relay/holster-data
      # Mount logs for debugging (optional, can be removed in production)
      - ./logs:/var/log/supervisor
    environment:
      - NODE_ENV=production
      - IPFS_PATH=/data/ipfs
      - DATA_DIR=/app/relay/data
      - ADMIN_PASSWORD=shogun2025
      - RELAY_HOST=localhost
      - RELAY_PORT=8765
      - RELAY_STORE=true
      - RELAY_PATH=public
      - RELAY_QR=true
      - RELAY_NAME=shogun-relay
      - RELAY_PEERS=
      - RELAY_PROTECTED=false
      - IPFS_API_URL=http://127.0.0.1:5001
      - IPFS_GATEWAY_URL=http://127.0.0.1:8080
      - IPFS_API_TOKEN=shogun2025
      - IPFS_API_KEY=shogun2025
      - DISABLE_RADISK=false
      # Relay GunDB User (owns subscription data) - REQUIRED: RELAY_SEA_KEYPAIR or RELAY_SEA_KEYPAIR_PATH
      # Example: RELAY_SEA_KEYPAIR='{"pub":"...","priv":"...","epub":"...","epriv":"..."}'
      # Or: RELAY_SEA_KEYPAIR_PATH=/app/keys/relay-keypair.json
      # ============================================================================
      # X402 PAYMENT CONFIGURATION (Multi-Chain)
      # ============================================================================
      - X402_PAY_TO_ADDRESS=0xYourWalletAddressHere
      - X402_NETWORKS=base-sepolia,base
      - X402_DEFAULT_NETWORK=base-sepolia
      - X402_SETTLEMENT_MODE=direct
      # Required for direct settlement
      - X402_PRIVATE_KEY=your_private_key_here
      # Optional: Network-specific RPC overrides
      # - X402_BASE_SEPOLIA_RPC=https://your-rpc-url
      # - X402_BASE_RPC=https://your-rpc-url
      # ============================================================================
      # BRIDGE CONFIGURATION (Multi-Chain)
      # ============================================================================
      - BRIDGE_ENABLED=true
      - BRIDGE_NETWORKS=base-sepolia,base
      - BRIDGE_DEFAULT_NETWORK=base-sepolia
      # ============================================================================
      # DEALS CONFIGURATION (Multi-Chain)
      # ============================================================================
      - DEALS_NETWORKS=base-sepolia,base
      - DEALS_DEFAULT_NETWORK=base-sepolia
      # ============================================================================
      # On-Chain Registry Configuration
      # ============================================================================
      # Private key for on-chain operations (registration, staking, deals)
      - RELAY_PRIVATE_KEY=0x_your_private_key_here
      # Chain ID: 84532 = Base Sepolia (testnet), 8453 = Base Mainnet
      - REGISTRY_CHAIN_ID=84532
      # Relay Storage Limits (global IPFS storage limit)
      - RELAY_MAX_STORAGE_GB=10
      - RELAY_STORAGE_WARNING_THRESHOLD=80
      # Holster Relay (WebSocket enhancement)
      - HOLSTER_RELAY_HOST=0.0.0.0
      # - HOLSTER_RELAY_PORT=8766
      - HOLSTER_RELAY_STORAGE=true
      - HOLSTER_RELAY_STORAGE_PATH=/app/relay/holster-data
      - HOLSTER_MAX_CONNECTIONS=100
      # Network Federation
      - AUTO_REPLICATION=true
      - BRIDGE_VALID_CHAIN_IDS=84532,42161
      - CORS_ORIGINS=https://shogun-deals.vercel.app,https://shogun-l2.vercel.app
      - CORS_CREDENTIALS=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - shogun-network

volumes:
  # IPFS repository - contains all IPFS data (blocks, pins, config)
  ipfs-data:
    driver: local
  # GunDB data - contains gun.db (SQLite) or radata/ directory
  # This is critical for preserving subscription data, reputation, and all GunDB state
  relay-data:
    driver: local
  # Relay keys - contains relay SEA keypair (RELAY_SEA_KEYPAIR_PATH)
  # Important: Without this, the relay user will be recreated on each deploy
  relay-keys:
    driver: local
  # Holster data - contains Holster relay state (if HOLSTER_RELAY_STORAGE=true)
  holster-data:
    driver: local

networks:
  shogun-network:
    driver: bridge
