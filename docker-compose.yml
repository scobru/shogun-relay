services:
  shogun-relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shogun-relay-stack
    ports:
      - "8765:8765" # Relay Server
      - "5001:5001" # IPFS API
      - "8080:8080" # IPFS Gateway
      - "4001:4001" # IPFS Swarm
      - "6881:6881" # BitTorrent/WebTorrent peer connections (Anna's Archive)
      - "6881:6881/udp" # BitTorrent UDP (DHT)
    volumes:
      # Persist IPFS data (repository, pins, blocks)
      - ipfs-data:/data/ipfs
      # Persist GunDB data (SQLite DB or radata files)
      - relay-data:/app/relay/data
      # Persist relay keys (SEA keypair for relay user)
      - relay-keys:/app/keys
      # Persist Holster data (if Holster is enabled)
      - holster-data:/app/relay/holster-data
      # Mount logs for debugging (optional, can be removed in production)
      - ./logs:/var/log/supervisor
    environment:
      # ============================================================================
      # SERVER/RELAY IDENTITY
      # ============================================================================
      - NODE_ENV=production
      - RELAY_HOST=localhost
      - RELAY_PORT=8765
      - RELAY_NAME=shogun-relay
      - RELAY_PATH=public
      - RELAY_STORE=true
      - RELAY_QR=true
      - RELAY_PROTECTED=false
      # ============================================================================
      # AUTHENTICATION
      # ============================================================================
      - ADMIN_PASSWORD=shogun2025
      # Relay GunDB User - REQUIRED: RELAY_SEA_KEYPAIR or RELAY_SEA_KEYPAIR_PATH
      # Example: RELAY_SEA_KEYPAIR='{"pub":"...","priv":"...","epub":"...","epriv":"..."}'
      # Or: RELAY_SEA_KEYPAIR_PATH=/app/keys/relay-keypair.json
      # ============================================================================
      # MODULE ENABLED FLAGS (true/false to enable/disable modules)
      # ============================================================================
      - IPFS_ENABLED=${IPFS_ENABLED:-true}
      - HOLSTER_ENABLED=${HOLSTER_ENABLED:-false}
      - X402_ENABLED=${X402_ENABLED:-false}
      - REGISTRY_ENABLED=${REGISTRY_ENABLED:-false}
      - DEALS_ENABLED=${DEALS_ENABLED:-false}
      - DEAL_SYNC_ENABLED=${DEAL_SYNC_ENABLED:-false}
      - WORMHOLE_ENABLED=${WORMHOLE_ENABLED:-false}
      - TORRENT_ENABLED=${TORRENT_ENABLED:-true}
      # ============================================================================
      # GUNDB/STORAGE
      # ============================================================================
      - DATA_DIR=/app/relay/data
      - DISABLE_RADISK=false
      - RELAY_PEERS=
      # ============================================================================
      # IPFS
      # ============================================================================
      - IPFS_PATH=/data/ipfs
      - IPFS_API_URL=http://127.0.0.1:5001
      - IPFS_GATEWAY_URL=http://127.0.0.1:8080
      - IPFS_API_TOKEN=shogun2025
      - IPFS_API_KEY=shogun2025
      # ============================================================================
      # HOLSTER
      # ============================================================================
      - HOLSTER_RELAY_HOST=0.0.0.0
      # - HOLSTER_RELAY_PORT=8766
      - HOLSTER_RELAY_STORAGE=true
      - HOLSTER_RELAY_STORAGE_PATH=/app/relay/holster-data
      - HOLSTER_MAX_CONNECTIONS=100
      # ============================================================================
      # BLOCKCHAIN/WALLET (shared key for on-chain operations)
      # ============================================================================
      - RELAY_PRIVATE_KEY=0x_your_private_key_here
      # ============================================================================
      # X402 PAYMENT
      # ============================================================================
      - X402_PAY_TO_ADDRESS=0xYourWalletAddressHere
      - X402_PRIVATE_KEY=your_private_key_here
      - X402_SETTLEMENT_MODE=direct
      - X402_NETWORKS=base-sepolia,base
      - X402_DEFAULT_NETWORK=base-sepolia
      # Optional RPC overrides:
      # - X402_BASE_SEPOLIA_RPC=https://your-rpc-url
      # ============================================================================
      # REGISTRY
      # ============================================================================
      - REGISTRY_NETWORKS=base-sepolia,base
      - REGISTRY_DEFAULT_NETWORK=base-sepolia
      # ============================================================================
      # DEALS
      # ============================================================================
      - DEALS_NETWORKS=base-sepolia,base
      - DEALS_DEFAULT_NETWORK=base-sepolia
      # ============================================================================
      # TORRENT MANAGER
      # ============================================================================
      - TORRENT_DATA_DIR=/app/relay/data/torrents
      - TORRENT_MAX_TB=${TORRENT_MAX_TB:-0.05}
      # ============================================================================
      # STORAGE LIMITS
      # ============================================================================
      - RELAY_MAX_STORAGE_GB=10
      - RELAY_STORAGE_WARNING_THRESHOLD=80
      # ============================================================================
      # NETWORK/SECURITY
      # ============================================================================
      - AUTO_REPLICATION=true
      - CORS_ORIGINS=https://shogun-deals.vercel.app,https://shogun-l2.vercel.app
      - CORS_CREDENTIALS=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - shogun-network

volumes:
  # IPFS repository - contains all IPFS data (blocks, pins, config)
  ipfs-data:
    driver: local
  # GunDB data - contains gun.db (SQLite) or radata/ directory
  # This is critical for preserving subscription data, reputation, and all GunDB state
  relay-data:
    driver: local
  # Relay keys - contains relay SEA keypair (RELAY_SEA_KEYPAIR_PATH)
  # Important: Without this, the relay user will be recreated on each deploy
  relay-keys:
    driver: local
  # Holster data - contains Holster relay state (if HOLSTER_RELAY_STORAGE=true)
  holster-data:
    driver: local

networks:
  shogun-network:
    driver: bridge
