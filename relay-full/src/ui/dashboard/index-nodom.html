<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shogun Relay Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    
    <!-- DaisyUI + Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    
    <style>
      /* Custom theme adjustments */
      :root {
        --font-family: 'Inter', sans-serif;
      }
      
      body {
        font-family: var(--font-family);
      }
      
      /* Custom animations for smooth transitions */
      .tab-content {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Toast animations */
      @keyframes slideInRight {
        from { 
          opacity: 0; 
          transform: translateX(100%); 
        }
        to { 
          opacity: 1; 
          transform: translateX(0); 
        }
      }
      
      @keyframes slideOutRight {
        from { 
          opacity: 1; 
          transform: translateX(0); 
        }
        to { 
          opacity: 0; 
          transform: translateX(100%); 
        }
      }
      
      /* Loading spinner enhancement */
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-base-100 min-h-screen">
    <div id="app" class="min-h-screen"></div>

    <script type="module">
      import { h, setEffect } from "./nodom.js";
      import {
        initGun,
        checkAuth,
        loadFiles,
        updateIpfsStatus,
        updateServerStatus,
        handleDebugCommand,
        getIsLoading,
        setIsLoading,
        getActiveTab,
        setActiveTab,
        handleLogout,
        initTheme,
        initializeFileEventListeners,
        initializePeers,
      } from "./app-nodom.js";
      import {
        Header,
        Navbar,
        ToastContainer,
        LoadingOverlay,
        DashboardHeader,
        StatsGrid,
        ServerInfoCard,
        EnhancedTabs,
      } from "./components-nodom.js";
      import {
        FilesTabContent,
        UploadTabContent,
        NetworkTabContent,
        SettingsTabContent,
      } from "./tabs-nodom.js";

      // Main application component
      function App() {
        // Create main container with DaisyUI layout
        const container = h("div", { class: "min-h-screen bg-base-100" });

        // Initialize app components
        const toastContainer = ToastContainer();
        const loadingOverlay = LoadingOverlay();
        const header = Header();
        const navbar = Navbar();
        
        // Main content area
        const mainContent = h("div", { class: "container mx-auto px-4 py-6 max-w-7xl" });
        
        const dashboardHeader = DashboardHeader();
        const statsGrid = StatsGrid();
        const serverInfoCard = ServerInfoCard();

        // Create tabs container with DaisyUI card styling
        const tabsContainer = h("div", { 
          class: "card bg-base-100 shadow-xl",
          role: "region",
          "aria-label": "Main dashboard navigation and content"
        });

        // Create enhanced tabs with accessibility
        const enhancedTabs = EnhancedTabs();

        // Tab content components with proper ARIA attributes
        const filesTabContent = FilesTabContent();
        const uploadTabContent = UploadTabContent();
        const networkTabContent = NetworkTabContent();
        const settingsTabContent = SettingsTabContent();

        // Add ARIA attributes to tab panels
        filesTabContent.setAttribute('role', 'tabpanel');
        filesTabContent.setAttribute('id', 'files-panel');
        filesTabContent.setAttribute('aria-labelledby', 'tab-files');
        filesTabContent.classList.add('p-6');

        uploadTabContent.setAttribute('role', 'tabpanel');
        uploadTabContent.setAttribute('id', 'upload-panel');
        uploadTabContent.setAttribute('aria-labelledby', 'tab-upload');
        uploadTabContent.classList.add('p-6');

        networkTabContent.setAttribute('role', 'tabpanel');
        networkTabContent.setAttribute('id', 'network-panel');
        networkTabContent.setAttribute('aria-labelledby', 'tab-network');
        networkTabContent.classList.add('p-6');

        settingsTabContent.setAttribute('role', 'tabpanel');
        settingsTabContent.setAttribute('id', 'settings-panel');
        settingsTabContent.setAttribute('aria-labelledby', 'tab-settings');
        settingsTabContent.classList.add('p-6');

        // Add components to tabs container
        tabsContainer.appendChild(enhancedTabs);
        tabsContainer.appendChild(filesTabContent);
        tabsContainer.appendChild(uploadTabContent);
        tabsContainer.appendChild(networkTabContent);
        tabsContainer.appendChild(settingsTabContent);

        // Initialize first tab as visible
        setTimeout(() => {
          const activeTab = getActiveTab();
          if (activeTab === 'files') {
            filesTabContent.style.display = 'block';
          }
        }, 100);

        // Add components to main content
        mainContent.appendChild(dashboardHeader);
        mainContent.appendChild(statsGrid);
        mainContent.appendChild(serverInfoCard);
        mainContent.appendChild(tabsContainer);

        // Add components to main container
        container.appendChild(toastContainer);
        container.appendChild(loadingOverlay);
        container.appendChild(header);
        container.appendChild(navbar);
        container.appendChild(mainContent);

        // Setup event listeners
        setupEventListeners();

        return container;
      }

      // Setup global event listeners
      function setupEventListeners() {
        // Debug button event listener
        document.addEventListener("click", (e) => {
          if (e.target && e.target.id === "debug-command-btn") {
            e.preventDefault();

            // Toggle log container visibility
            const logContainer = document.getElementById("log-container");
            if (logContainer) {
              logContainer.style.display =
                logContainer.style.display === "none" ? "block" : "none";

              // Execute debug command when showing the panel
              if (logContainer.style.display === "block") {
                handleDebugCommand();
              }
            }
          }
        });

        // Refresh all data button
        document.addEventListener("click", (e) => {
          if (e.target && e.target.id === "refresh-all") {
            e.preventDefault();
            refreshAllData();
          }
        });

        // Setup token refresh check every minute
        setInterval(async () => {
          await checkAuth();
        }, 60 * 1000);
      }

      // Function to refresh all data
      async function refreshAllData() {
        try {
          setIsLoading(true);
          console.log("Global data refresh...");

          // Force Gun ping to test connection
          const gun = window.gunInstance;
          if (gun) {
            gun.get("_ping").put({ timestamp: Date.now() });
          }

          // Update server status, files and IPFS status
          await Promise.all([
            updateServerStatus(),
            loadFiles(),
            updateIpfsStatus(),
            initializePeers(),
          ]);

          console.log("Data refresh complete");
        } catch (error) {
          console.error(`Data refresh error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      }

      // Initialize the application
      async function initApp() {
        try {
          console.log("Initializing NoDom app...");

          // Show initial loading
          setIsLoading(true);

          // Initialize theme
          initTheme();
          
          // Initialize file event listeners to prevent duplicates
          initializeFileEventListeners();

          // Check authentication
          const isAuthenticated = await checkAuth();
          if (!isAuthenticated) {
            // Redirect to login page if not authenticated
            window.location.href = "/login";
            return;
          }

          // Initialize Gun
          const gun = initGun();

          let authToken = localStorage.getItem("authToken");

          gun.on("out", function (msg) {
            if (msg.put) {
              msg.token = authToken;
              // o
              msg.auth = { token: authToken };
              msg.headers = {
                token: authToken,
              };
            }
            this.to.next(msg);
          });

          // Initialize server data
          await Promise.all([
            updateServerStatus(),
            loadFiles(),
            updateIpfsStatus(),
            initializePeers(),
          ]);

          // Render app
          const app = App();
          document.getElementById("app").appendChild(app);

          console.log("NoDom app initialized successfully");
        } catch (error) {
          console.error("Error initializing app:", error);
          document.getElementById(
            "app"
          ).innerHTML = `<div style="text-align: center; margin-top: 100px; color: var(--error-color);">
                        Error initializing app: ${error.message}
                    </div>`;
        } finally {
          setIsLoading(false);
        }
      }

      // Initialize app when DOM is ready
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
