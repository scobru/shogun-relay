<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shogun Key Pair Generator & User Management</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      h1,
      h2,
      h3 {
        color: #2c3e50;
      }

      .container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .key-container,
      .output-container {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
        overflow-wrap: break-word;
      }

      .button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .button.secondary {
        background-color: #2196f3;
      }

      .button.secondary:hover {
        background-color: #0b7dda;
      }

      .button.danger {
        background-color: #f44336;
      }

      .button.danger:hover {
        background-color: #d32f2f;
      }

      .warning {
        color: #856404;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 20px;
      }

      .success {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 20px;
      }

      .error {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 20px;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 8px 0;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 4px 4px 0 0;
        margin-right: 5px;
      }

      .tab.active {
        background-color: #fff;
        border-color: #ddd;
        border-bottom-color: #fff;
        margin-bottom: -1px;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Shogun User Management & Key Tools</h1>

    <div class="tabs">
      <div class="tab active" data-tab="keypair">Generate Key Pair</div>
      <div class="tab" data-tab="user">User Management</div>
      <div class="tab" data-tab="token">Token Management</div>
      <div class="tab" data-tab="test">Test Connectivity</div>
    </div>

    <!-- Key Pair Tab -->
    <div class="tab-content active" id="keypair-tab">
      <div class="container">
        <h2>Key Pair Generator</h2>

        <div class="warning">
          <strong>Important Security Notice:</strong> The key pair generated
          here is meant for development and testing purposes. In production
          environments, key pairs should be generated securely on the client
          device. Never share your private keys!
        </div>

        <p>
          This tool generates a cryptographic key pair that can be used with
          Gun.js and Shogun applications. The key pair consists of a public key
          (pub) and a private key (priv).
        </p>

        <div>
          <button id="generateBtn" class="button">Generate New Key Pair</button>
          <button id="downloadBtn" class="button secondary" disabled>
            Download Key Pair
          </button>
        </div>

        <h3>Generated Key Pair:</h3>
        <div id="keyOutput" class="key-container">
          <p>No key pair generated yet. Click the Generate button above.</p>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div class="tab-content" id="user-tab">
      <div class="container">
        <h2>User Registration & Login</h2>

        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" placeholder="Enter username" />
        </div>

        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter password" />
        </div>

        <div class="form-group">
          <label for="email">Email (optional):</label>
          <input type="email" id="email" placeholder="Enter email" />
        </div>

        <div>
          <button id="registerBtn" class="button">Register User</button>
          <button id="loginBtn" class="button secondary">Login User</button>
        </div>

        <h3>User Operation Result:</h3>
        <div id="userOutput" class="output-container">
          <p>No user operation performed yet.</p>
        </div>
      </div>
    </div>

    <!-- Token Management Tab -->
    <div class="tab-content" id="token-tab">
      <div class="container">
        <h2>Token Management</h2>

        <div class="form-group">
          <label for="currentToken">Current Token:</label>
          <textarea
            id="currentToken"
            rows="3"
            placeholder="Your API token will appear here"
            readonly
          ></textarea>
        </div>

        <div>
          <button id="createTokenBtn" class="button">Create New Token</button>
          <button id="preAuthorizeBtn" class="button secondary" disabled>
            Pre-Authorize Token
          </button>
          <button id="testTokenBtn" class="button secondary" disabled>
            Test Token
          </button>
        </div>

        <div class="form-group">
          <label for="tokenName">Token Name (for creation):</label>
          <input
            type="text"
            id="tokenName"
            placeholder="Enter a name for the token"
          />
        </div>

        <h3>Token Operation Result:</h3>
        <div id="tokenOutput" class="output-container">
          <p>No token operation performed yet.</p>
        </div>
      </div>
    </div>

    <!-- Test Connectivity Tab -->
    <div class="tab-content" id="test-tab">
      <div class="container">
        <h2>Test Gun Connectivity</h2>

        <div>
          <button id="testGunBtn" class="button">Test Gun Connection</button>
          <button id="testWriteBtn" class="button secondary" disabled>
            Test Write With Token
          </button>
          <button id="configureRelayBtn" class="button danger">
            Configure Relay Auth
          </button>
        </div>

        <div class="form-group">
          <label for="relayEnabled">Relay Enabled:</label>
          <input type="checkbox" id="relayEnabled" checked />
        </div>

        <div class="form-group">
          <label for="onchainMembership">Onchain Membership:</label>
          <input type="checkbox" id="onchainMembership" />
        </div>

        <h3>Test Result:</h3>
        <div id="testOutput" class="output-container">
          <p>No test performed yet.</p>
        </div>
      </div>
    </div>

    <!-- Include Gun for SEA (Security, Encryption, Authorization) functionality -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Tab Functionality
        const tabs = document.querySelectorAll(".tab");
        const tabContents = document.querySelectorAll(".tab-content");

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // Remove active class from all tabs and contents
            tabs.forEach((t) => t.classList.remove("active"));
            tabContents.forEach((content) =>
              content.classList.remove("active")
            );

            // Add active class to clicked tab and corresponding content
            tab.classList.add("active");
            const tabId = tab.getAttribute("data-tab");
            document.getElementById(`${tabId}-tab`).classList.add("active");
          });
        });

        // Key Pair Generation
        const generateBtn = document.getElementById("generateBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const keyOutput = document.getElementById("keyOutput");

        let currentKeyPair = null;

        generateBtn.addEventListener("click", async function () {
          try {
            keyOutput.innerHTML = "<p>Generating key pair...</p>";

            // Use Gun SEA to generate a key pair
            const pair = await SEA.pair();

            currentKeyPair = pair;

            const formattedJson = JSON.stringify(pair, null, 2);
            keyOutput.innerHTML = `<pre>${formattedJson}</pre>`;

            downloadBtn.disabled = false;
          } catch (error) {
            keyOutput.innerHTML = `<div class="error">Error generating key pair: ${error.message}</div>`;
            console.error("Error generating key pair:", error);
          }
        });

        downloadBtn.addEventListener("click", function () {
          if (!currentKeyPair) return;

          try {
            // Create a blob with the JSON data
            const jsonData = JSON.stringify(currentKeyPair, null, 2);
            const blob = new Blob([jsonData], { type: "application/json" });

            // Create a temporary link element and trigger the download
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `gundb-keypair-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error("Error downloading key pair:", error);
            alert("Error downloading key pair: " + error.message);
          }
        });

        // User Management
        const registerBtn = document.getElementById("registerBtn");
        const loginBtn = document.getElementById("loginBtn");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const emailInput = document.getElementById("email");
        const userOutput = document.getElementById("userOutput");
        const currentTokenTextarea = document.getElementById("currentToken");
        const preAuthorizeBtn = document.getElementById("preAuthorizeBtn");
        const testTokenBtn = document.getElementById("testTokenBtn");

        // Initialize Gun connection
        const gun = Gun({
          peers: ["http://localhost:8765/gun"],
          localStorage: false,
        });

        let currentUser = null;
        let currentToken = null;

        // Function to apply token to Gun instance
        function applyTokenToGun(token) {
          if (!token) return;
          
          // Store token for persistence
          localStorage.setItem('gunAuthToken', token);
          
          // Update current token
          currentToken = token;
          
          // Apply token to all outgoing messages
          Gun.on('opt', function(ctx) {
            if (ctx.once) return;
            
            ctx.on('out', function(msg) {
              msg.headers = msg.headers || {};
              msg.headers.Authorization = `Bearer ${token}`;
              msg.headers.token = token;
              this.to.next(msg);
            });
          });
        }

        // Check for existing token in localStorage
        const savedToken = localStorage.getItem('gunAuthToken');
        if (savedToken) {
          currentToken = savedToken;
          currentTokenTextarea.value = savedToken;
          applyTokenToGun(savedToken);
          preAuthorizeBtn.disabled = false;
          testTokenBtn.disabled = false;
          userOutput.innerHTML = `<div class="success">Restored saved token from localStorage</div>`;
          
          // Automatically pre-authorize the token if needed
          (async function() {
            try {
              const response = await axios.post(
                "http://localhost:8765/api/auth/pre-authorize-token",
                { token: savedToken },
                {
                  headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                    Authorization: `Bearer thisIsTheTokenForReals`,
                    token: "thisIsTheTokenForReals",
                  },
                }
              );
              
              if (response.data && response.data.success) {
                userOutput.innerHTML += `<div class="success">Token automatically pre-authorized</div>`;
                console.log("Token automatically pre-authorized until:", new Date(response.data.expiresAt));
              }
            } catch (error) {
              console.error("Auto pre-authorization error:", error);
              userOutput.innerHTML += `<div class="warning">Token might need manual pre-authorization</div>`;
            }
          })();
        }

        registerBtn.addEventListener("click", async function () {
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();
          const email = emailInput.value.trim();

          if (!username || !password) {
            userOutput.innerHTML = `<div class="error">Username and password are required</div>`;
            return;
          }

          userOutput.innerHTML = `<p>Registering user ${username}...</p>`;

          try {
            // First try to register through Gun
            await new Promise((resolve, reject) => {
              gun.user().create(username, password, (ack) => {
                if (ack.err && !ack.err.includes("already created")) {
                  reject(new Error(ack.err));
                } else {
                  resolve(ack);
                }
              });
            });

            // Auth the user to set permissions correctly
            await new Promise((resolve, reject) => {
              gun.user().auth(username, password, (ack) => {
                if (ack.err) {
                  reject(new Error(ack.err));
                } else {
                  currentUser = ack;
                  resolve(ack);
                }
              });
            });

            // Set default permissions properly - as a string instead of an array to avoid validation errors
            gun.user().get("profile").get("permissions").put("user");

            // Then try to register through API to get a token
            try {
              const response = await axios.post(
                "http://localhost:8765/api/auth/register",
                {
                  username,
                  password,
                  email: email || undefined,
                },
                {
                  headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                    Authorization: `Bearer thisIsTheTokenForReals`,
                    token: "thisIsTheTokenForReals",
                  },
                }
              );

              if (response.data && response.data.success) {
                userOutput.innerHTML = `<div class="success">User ${username} registered successfully!</div>`;

                // Extract token
                let token;
                if (response.data.token && response.data.token.token) {
                  token = response.data.token.token;
                } else if (response.data.token) {
                  token = response.data.token;
                }

                if (token) {
                  currentToken = token;
                  const maskedToken =
                    token.substring(0, 6) +
                    "..." +
                    token.substring(token.length - 6);
                  currentTokenTextarea.value = token;
                  userOutput.innerHTML += `<p>API Token: ${maskedToken}</p>`;
                  
                  // Apply the token to Gun
                  applyTokenToGun(token);
                  
                  // Automatically pre-authorize the token
                  try {
                    const authResponse = await axios.post(
                      "http://localhost:8765/api/auth/pre-authorize-token",
                      { token: token },
                      {
                        headers: {
                          "Content-Type": "application/json",
                          Accept: "application/json",
                          Authorization: `Bearer thisIsTheTokenForReals`,
                          token: "thisIsTheTokenForReals",
                        },
                      }
                    );
                    
                    if (authResponse.data && authResponse.data.success) {
                      userOutput.innerHTML += `<div class="success">Token pre-authorized successfully!</div>`;
                      preAuthorizeBtn.disabled = false;
                      testTokenBtn.disabled = false;
                    }
                  } catch (authError) {
                    console.error("Token pre-authorization error:", authError);
                    userOutput.innerHTML += `<div class="warning">Token may need manual pre-authorization</div>`;
                  }
                } else {
                  userOutput.innerHTML += `<p>No token found in response</p>`;
                }
              } else {
                userOutput.innerHTML += `<div class="error">API Registration failed: ${
                  response.data?.error || "Unknown error"
                }</div>`;
              }
            } catch (error) {
              userOutput.innerHTML = `<div class="error">Registration error: ${error.message}</div>`;
              console.error("Registration error:", error);
            }
          } catch (error) {
            userOutput.innerHTML = `<div class="error">Registration error: ${error.message}</div>`;
            console.error("Registration error:", error);
          }
        });

        loginBtn.addEventListener("click", async function () {
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();

          if (!username || !password) {
            userOutput.innerHTML = `<div class="error">Username and password are required</div>`;
            return;
          }

          userOutput.innerHTML = `<p>Logging in as ${username}...</p>`;

          try {
            // First try to login through Gun
            await new Promise((resolve, reject) => {
              gun.user().auth(username, password, (ack) => {
                if (ack.err) {
                  reject(new Error(ack.err));
                } else {
                  currentUser = ack;
                  resolve(ack);
                }
              });
            });

            userOutput.innerHTML = `<div class="success">Gun login successful!</div>`;

            // Then try to login through API to get a token
            try {
              const response = await axios.post(
                "http://localhost:8765/api/auth/login",
                {
                  username,
                  password,
                },
                {
                  headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                    Authorization: `Bearer thisIsTheTokenForReals`,
                    token: "thisIsTheTokenForReals",
                  },
                }
              );

              if (response.data && response.data.success) {
                // Extract token
                let token;
                if (response.data.token && response.data.token.token) {
                  token = response.data.token.token;
                } else if (response.data.token) {
                  token = response.data.token;
                } else if (
                  response.data.tokens &&
                  response.data.tokens.length > 0
                ) {
                  token = response.data.tokens[0].token;
                }

                if (token) {
                  currentToken = token;
                  const maskedToken =
                    token.substring(0, 6) +
                    "..." +
                    token.substring(token.length - 6);
                  currentTokenTextarea.value = token;
                  userOutput.innerHTML += `<p>API Token: ${maskedToken}</p>`;
                  
                  // Apply the token to Gun
                  applyTokenToGun(token);
                  
                  // Automatically pre-authorize the token
                  try {
                    const authResponse = await axios.post(
                      "http://localhost:8765/api/auth/pre-authorize-token",
                      { token: token },
                      {
                        headers: {
                          "Content-Type": "application/json",
                          Accept: "application/json",
                          Authorization: `Bearer thisIsTheTokenForReals`,
                          token: "thisIsTheTokenForReals",
                        },
                      }
                    );
                    
                    if (authResponse.data && authResponse.data.success) {
                      userOutput.innerHTML += `<div class="success">Token pre-authorized successfully!</div>`;
                      preAuthorizeBtn.disabled = false;
                      testTokenBtn.disabled = false;
                    }
                  } catch (authError) {
                    console.error("Token pre-authorization error:", authError);
                    userOutput.innerHTML += `<div class="warning">Token may need manual pre-authorization</div>`;
                  }
                } else {
                  userOutput.innerHTML += `<p>No token found in response</p>`;
                }
              } else {
                userOutput.innerHTML += `<div class="error">API Login failed: ${
                  response.data?.error || "Unknown error"
                }</div>`;
              }
            } catch (apiError) {
              userOutput.innerHTML += `<div class="error">API Login error: ${apiError.message}</div>`;
              console.error("API Login error:", apiError);
            }
          } catch (error) {
            userOutput.innerHTML = `<div class="error">Login error: ${error.message}</div>`;
            console.error("Login error:", error);
          }
        });

        // Token Management
        const createTokenBtn = document.getElementById("createTokenBtn");
        const tokenNameInput = document.getElementById("tokenName");
        const tokenOutput = document.getElementById("tokenOutput");

        createTokenBtn.addEventListener("click", async function () {
          const tokenName =
            tokenNameInput.value.trim() || "Web Interface Token";

          tokenOutput.innerHTML = `<p>Creating token "${tokenName}"...</p>`;

          try {
            // Aggiungiamo log di debug
            console.log("Attempting to create token with name:", tokenName);

            const response = await axios.post(
              "http://localhost:8765/api/auth/tokens",
              { name: tokenName, expiresInDays: 30 },
              {
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                  Authorization: `Bearer thisIsTheTokenForReals`,
                },
              }
            );

            // Aggiungiamo log di debug
            console.log("Token creation response:", response.data);

            if (response.data && response.data.success) {
              tokenOutput.innerHTML = `<div class="success">Token created successfully!</div>`;

              // Extract token
              let token;
              if (response.data.token && response.data.token.token) {
                token = response.data.token.token;
              } else if (response.data.token) {
                token = response.data.token;
              }

              if (token) {
                currentToken = token;
                const maskedToken =
                  token.substring(0, 6) +
                  "..." +
                  token.substring(token.length - 6);
                currentTokenTextarea.value = token;
                tokenOutput.innerHTML += `<p>API Token: ${maskedToken}</p>`;
                
                // Apply the token to Gun
                applyTokenToGun(token);
                
                // Automatically pre-authorize the token
                try {
                  const authResponse = await axios.post(
                    "http://localhost:8765/api/auth/pre-authorize-token",
                    { token: token },
                    {
                      headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                        Authorization: `Bearer thisIsTheTokenForReals`,
                        token: "thisIsTheTokenForReals",
                      },
                    }
                  );
                  
                  if (authResponse.data && authResponse.data.success) {
                    userOutput.innerHTML += `<div class="success">Token pre-authorized successfully!</div>`;
                    preAuthorizeBtn.disabled = false;
                    testTokenBtn.disabled = false;
                  }
                } catch (authError) {
                  console.error("Token pre-authorization error:", authError);
                  userOutput.innerHTML += `<div class="warning">Token may need manual pre-authorization</div>`;
                }
              }
            } else {
              tokenOutput.innerHTML = `<div class="error">Token creation failed: ${
                response.data?.error || "Unknown error"
              }</div>`;
            }
          } catch (error) {
            // Miglioriamo il messaggio d'errore per includere i dettagli della risposta
            console.error("Token creation error:", error);
            let errorMessage = error.message;

            if (error.response) {
              console.error("Error response data:", error.response.data);
              console.error("Error response status:", error.response.status);

              errorMessage += ` (Status: ${error.response.status})`;
              if (error.response.data && error.response.data.error) {
                errorMessage += ` - ${error.response.data.error}`;
              }
            }

            tokenOutput.innerHTML = `<div class="error">Token creation error: ${errorMessage}</div>`;
          }
        });

        preAuthorizeBtn.addEventListener("click", async function () {
          if (!currentToken) {
            tokenOutput.innerHTML = `<div class="error">No token available to pre-authorize</div>`;
            return;
          }

          tokenOutput.innerHTML = `<p>Pre-authorizing token...</p>`;

          try {
            const response = await axios.post(
              "http://localhost:8765/api/auth/pre-authorize-token",
              { token: currentToken },
              {
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                  Authorization: `Bearer thisIsTheTokenForReals`,
                  token: "thisIsTheTokenForReals",
                },
              }
            );

            if (response.data && response.data.success) {
              tokenOutput.innerHTML = `<div class="success">Token pre-authorized successfully!</div>`;
              const expiryDate = new Date(response.data.expiresAt);
              tokenOutput.innerHTML += `<p>Token authorized until: ${expiryDate.toLocaleString()}</p>`;
              testTokenBtn.disabled = false;
              
              // Make sure the token is applied to Gun
              applyTokenToGun(currentToken);
            } else {
              tokenOutput.innerHTML = `<div class="error">Token pre-authorization failed: ${
                response.data?.error || "Unknown error"
              }</div>`;
            }
          } catch (error) {
            tokenOutput.innerHTML = `<div class="error">Token pre-authorization error: ${error.message}</div>`;
            console.error("Token pre-authorization error:", error);
          }
        });

        testTokenBtn.addEventListener("click", function () {
          if (!currentToken) {
            tokenOutput.innerHTML = `<div class="error">No token available to test</div>`;
            return;
          }

          // Switch to test tab
          tabs.forEach((t) => t.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));
          document
            .querySelector('.tab[data-tab="test"]')
            .classList.add("active");
          document.getElementById("test-tab").classList.add("active");

          // Enable write test
          document.getElementById("testWriteBtn").disabled = false;
        });

        // Test Functionality
        const testGunBtn = document.getElementById("testGunBtn");
        const testWriteBtn = document.getElementById("testWriteBtn");
        const configureRelayBtn = document.getElementById("configureRelayBtn");
        const relayEnabledCheckbox = document.getElementById("relayEnabled");
        const onchainMembershipCheckbox =
          document.getElementById("onchainMembership");
        const testOutput = document.getElementById("testOutput");

        testGunBtn.addEventListener("click", function () {
          testOutput.innerHTML = `<p>Testing Gun connection...</p>`;

          try {
            // Create a test Gun instance
            const testGun = Gun({
              peers: ["http://localhost:8765/gun"],
              localStorage: false,
            });

            // Add a timeout to check if Gun responds
            let responded = false;

            // Set up listener on a test path
            testGun.get("connection-test").once((data) => {
              responded = true;
              testOutput.innerHTML = `<div class="success">Gun connection successful!</div>`;
              testOutput.innerHTML += `<p>Data received: ${JSON.stringify(
                data || {}
              )}</p>`;
            });

            // Check relay status
            axios
              .get("http://localhost:8765/api/relay/status", {
                headers: {
                  Authorization: `Bearer thisIsTheTokenForReals`,
                  token: "thisIsTheTokenForReals",
                },
              })
              .then((response) => {
                testOutput.innerHTML += `<p>Relay Status: ${JSON.stringify(
                  response.data
                )}</p>`;

                // Update checkboxes based on actual relay config
                if (response.data && response.data.config) {
                  relayEnabledCheckbox.checked =
                    response.data.config.enabled === true ||
                    response.data.config.enabled === "true";
                  onchainMembershipCheckbox.checked =
                    response.data.config.onchainMembership === true ||
                    response.data.config.onchainMembership === "true";
                }
              })
              .catch((error) => {
                testOutput.innerHTML += `<div class="error">Relay status check failed: ${error.message}</div>`;
              });

            // Set a timeout
            setTimeout(() => {
              if (!responded) {
                testOutput.innerHTML = `<div class="error">Gun connection timed out or failed</div>`;
              }
            }, 5000);
          } catch (error) {
            testOutput.innerHTML = `<div class="error">Gun connection error: ${error.message}</div>`;
            console.error("Gun connection error:", error);
          }
        });

        testWriteBtn.addEventListener("click", function () {
          if (!currentToken) {
            testOutput.innerHTML = `<div class="error">No token available for test</div>`;
            return;
          }

          testOutput.innerHTML = `<p>Testing write operation with token...</p>`;

          try {
            // Use the main Gun instance but ensure it has the token
            applyTokenToGun(currentToken);
            
            // Create test data
            const testData = {
              test: "token-auth-test",
              timestamp: Date.now(),
            };

            testOutput.innerHTML += `<p>Writing data: ${JSON.stringify(
              testData
            )}</p>`;

            // Write to a test node
            gun.get("test-data").put(testData, (ack) => {
              if (ack.err) {
                testOutput.innerHTML = `<div class="error">Write failed: ${ack.err}</div>`;
              } else {
                testOutput.innerHTML = `<div class="success">Write successful!</div>`;

                // Try to read back the data
                setTimeout(() => {
                  gun.get("test-data").once((data) => {
                    testOutput.innerHTML += `<p>Data read back: ${JSON.stringify(
                      data
                    )}</p>`;

                    if (data && data.test === testData.test) {
                      testOutput.innerHTML += `<div class="success">Read verification successful - token authentication is working!</div>`;
                    } else {
                      testOutput.innerHTML += `<div class="error">Read verification failed - data doesn't match</div>`;
                    }
                  });
                }, 1000);
              }
            });
          } catch (error) {
            testOutput.innerHTML = `<div class="error">Test write error: ${error.message}</div>`;
            console.error("Test write error:", error);
          }
        });

        configureRelayBtn.addEventListener("click", async function () {
          const relayEnabled = relayEnabledCheckbox.checked;
          const onchainMembership = onchainMembershipCheckbox.checked;

          testOutput.innerHTML = `<p>Configuring relay: enabled=${relayEnabled}, onchainMembership=${onchainMembership}</p>`;

          try {
            const response = await axios.post(
              "http://localhost:8765/api/relay/auth/config",
              {
                relayEnabled,
                onchainMembership,
              },
              {
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                  Authorization: `Bearer thisIsTheTokenForReals`,
                  token: "thisIsTheTokenForReals",
                },
              }
            );

            if (response.data && response.data.success) {
              testOutput.innerHTML = `<div class="success">Relay configuration updated successfully!</div>`;
              testOutput.innerHTML += `<p>Current config: ${JSON.stringify(
                response.data.currentConfig
              )}</p>`;
              testOutput.innerHTML += `<p>Auth modes: ${response.data.authenticationModes.join(
                ", "
              )}</p>`;
            } else {
              testOutput.innerHTML = `<div class="error">Relay configuration failed: ${
                response.data?.error || "Unknown error"
              }</div>`;
            }
          } catch (error) {
            testOutput.innerHTML = `<div class="error">Relay configuration error: ${error.message}</div>`;
            console.error("Relay configuration error:", error);
          }
        });
      });
    </script>
  </body>
</html>
