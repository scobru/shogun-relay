<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Access-Control-Allow-Origin" content="*" />
  <title>Graph Visualizer</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles/wormhole.css" />
  <link rel="stylesheet" href="/visualGraph/vGmain.css" />
  <!-- Include centralized admin authentication -->
  <script src="/lib/admin-auth.js"></script>
</head>

<body class="min-h-screen bg-base-200 text-base-content">
  <div class="navbar bg-base-300">
    <div class="flex-1">
      <img src="/visualGraph/visualGraphIcon.svg" width="25" height="25" alt="" class="mr-2" />
      <h2 class="text-xl font-semibold">Visualization</h2>
    </div>
    <div class="flex-none">
      <span id="peerList" class="text-sm opacity-70"></span>
    </div>
  </div>

  <div class="container mx-auto p-4 flex flex-col gap-4 min-h-[calc(100vh-4rem)]">
    <!-- Input Controls -->
    <div class="card bg-base-300 shadow-xl">
      <div class="card-body p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="form-control">
            <label class="label" for="relayPeer">
              <span class="label-text">Relay Peer URL:</span>
            </label>
            <input id="relayPeer" type="text" class="input input-bordered w-full"
              placeholder="https://relay.shogun-eco.xyz/gun" value="https://relay.shogun-eco.xyz/gun" />
          </div>

          <div class="form-control">
            <label class="label" for="authToken">
              <span class="label-text">Auth Token:</span>
            </label>
            <input id="authToken" type="password" class="input input-bordered w-full"
              placeholder="Enter auth token (auto-loaded if saved)" />
          </div>

          <div class="form-control">
            <label class="label" for="key">
              <span class="label-text">Key to Start from:</span>
            </label>
            <input id="key" class="input input-bordered w-full" />
          </div>

          <div class="form-control">
            <label class="label" for="label">
              <span class="label-text">Property to be used as Label:</span>
            </label>
            <input id="label" class="input input-bordered w-full custom" />
          </div>
        </div>

        <div class="flex items-center gap-4 mt-4">
          <button id="startButton" class="btn btn-primary flex-1">
            Start
          </button>
          <div id="status" class="text-sm opacity-70 flex-1"></div>
        </div>
      </div>
    </div>

    <!-- Graph Viewer -->
    <div class="card bg-base-300 shadow-xl flex-1">
      <div class="card-body p-0">
        <svg class="w-full h-full min-h-[400px]"></svg>
      </div>
    </div>

    <!-- Data Inspector -->
    <div class="card bg-base-300 shadow-xl">
      <div class="card-body p-4">
        <div class="flex justify-between items-center">
          <h3 class="card-title">Data Inspector</h3>
          <div class="flex gap-2">
            <button id="loadAllNodesBtn" class="btn btn-sm btn-accent" disabled>
              ‚è≥ Loading...
            </button>
            <button id="save" class="btn btn-accent">Save Changes</button>
          </div>
        </div>
        <div id="detail" class="cont overflow-auto max-h-[200px] mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/promise.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>


  <!-- Button Logic -->
  <script type="text/javascript">
    // Initialize admin authentication
    document.addEventListener("DOMContentLoaded", () => {
      ShogunAdmin.init({
        autoFill: true,
        showIndicator: true,
        fieldId: "authToken",
        syncEnabled: true,
      });
    });

    // Listen for password updates
    window.addEventListener("shogun-admin-password-updated", (event) => {
      console.log("Admin password updated");
    });

    // Status update function
    function updateStatus(message, isError = false) {
      const statusEl = document.getElementById("status");
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#ff0000" : "#666";
      }
      console.log(isError ? "ERROR:" : "INFO:", message);
    }

    // Clear old data more selectively
    try {
      // Only clear gun-related data, not all localStorage
      Object.keys(localStorage).forEach((key) => {
        if (key.startsWith("gun/") || key.startsWith("radata")) {
          localStorage.removeItem(key);
        }
      });
    } catch (e) {
      updateStatus("Warning: Could not clear localStorage", true);
    }

    let gun = null;
    let isGunReady = false;

    // Initialize default peers - will be updated when user changes the input

    // Configure the middleware GLOBALLY before ANY Gun instance creation
    updateStatus("Configuring Gun middleware...");

    // Function to create Gun instance with current peer configuration
    function createGunInstance() {
      const relayPeerInput = document.getElementById("relayPeer");
      const currentPeer = relayPeerInput
        ? relayPeerInput.value.trim()
        : peer

      if (!currentPeer) {
        updateStatus("Error: Empty peer URL", true);
        return null;
      }

      peers = [currentPeer];
      updateStatus(`Creating Gun instance with peer: ${currentPeer}`);

      Gun.on("opt", function (ctx) {
        if (ctx.once) {
          return;
        }
        ctx.on("out", function (msg) {
          const to = this.to;
          // Use centralized admin password
          const authToken =
            ShogunAdmin.getPassword() ||
            (document.getElementById("authToken")
              ? document.getElementById("authToken").value.trim()
              : "");
          if (authToken) {
            // Add headers for all outgoing messages, especially 'put'
            msg.headers = {
              ...msg.headers, // Preserve existing headers
              token: authToken,
              Authorization: "Bearer " + authToken,
            };
          }
          console.log(msg);
          to.next(msg); // pass to next middleware
        });
      });

      try {
        // Enhanced Gun configuration matching graph.html
        gun = new Gun({ 
          peers: peers, 
          localStorage: false,
          // Enhanced sync configurations
          wire: true,        // Enable wire protocol for efficiency
          webrtc: true,      // Enable WebRTC for direct peer connections
          wait: 300,         // Faster batch processing
          until: 250,        // Shorter timeout for queries
          batch: 5,          // Small batch size for real-time updates
          retry: 3,          // Number of retry attempts
          // Connection resilience
          reconnect: true,   // Enable automatic reconnection
          heartbeat: 30000,  // Heartbeat every 30 seconds
          timeout: 15000     // Connection timeout
        });

        let graph = {
          nodes: [],
          edges: [],
        };

        let peerList = document.getElementById("peerList");
        if (peerList) {
          peerList.innerHTML = currentPeer;
        }

        // Enhanced connection monitoring and auto-reconnection
        let connectionState = {
          isConnected: false,
          lastPing: Date.now(),
          reconnectAttempts: 0,
          maxReconnectAttempts: 5,
          reconnectDelay: 2000
        };

        // Monitor connection health
        gun.on('hi', (peer) => {
          connectionState.isConnected = true;
          connectionState.lastPing = Date.now();
          connectionState.reconnectAttempts = 0;
          console.log('üü¢ Gun connected to peer:', peer);
          updateStatus('üü¢ Connected to relay');
        });

        gun.on('bye', (peer) => {
          connectionState.isConnected = false;
          console.log('üî¥ Gun disconnected from peer:', peer);
          updateStatus('üî¥ Disconnected from relay');
          attemptReconnection();
        });

        // Heartbeat to detect stale connections
        setInterval(() => {
          const timeSinceLastPing = Date.now() - connectionState.lastPing;
          if (timeSinceLastPing > 60000 && connectionState.isConnected) {
            console.warn('‚ö†Ô∏è Connection may be stale, attempting reconnection');
            attemptReconnection();
          }
        }, 30000);

        // Auto-reconnection logic
        function attemptReconnection() {
          if (connectionState.reconnectAttempts >= connectionState.maxReconnectAttempts) {
            console.error('‚ùå Max reconnection attempts reached');
            updateStatus('‚ùå Connection failed - max attempts reached', true);
            return;
          }

          connectionState.reconnectAttempts++;
          updateStatus(`üîÑ Reconnecting... (${connectionState.reconnectAttempts}/${connectionState.maxReconnectAttempts})`);
          
          setTimeout(() => {
            try {
              const gunInstance = createGunInstance();
              if (gunInstance) {
                updateStatus('‚úÖ Reconnected successfully');
              }
            } catch (error) {
              console.error('Reconnection failed:', error);
              setTimeout(attemptReconnection, connectionState.reconnectDelay * connectionState.reconnectAttempts);
            }
          }, connectionState.reconnectDelay);
        }

        // Make gun instance globally available
        window.gun = gun;
        window.graph = graph;
        isGunReady = true;

        updateStatus("Gun instance created successfully");
        return gun;
      } catch (error) {
        updateStatus(`Error creating Gun instance: ${error.message}`, true);
        return null;
      }
    }

    // Create initial instance after DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(function () {
        const gunInstance = createGunInstance();
        if (gunInstance) {
          updateStatus("Ready to start visualization");
        }
      }, 500);
    });
  </script>
  <script src="/visualGraph/visualGraph.js"></script>
  <script src="/visualGraph/abstraction.js"></script>
  <script>
    // Wait for all scripts to load and DFS to be available
    function waitForDFS() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;

        const checkDFS = () => {
          attempts++;
          if (typeof window.DFS !== "undefined" && window.DFS.search) {
            updateStatus("DFS module loaded successfully!");
            resolve();
          } else if (attempts >= maxAttempts) {
            updateStatus("Timeout waiting for DFS module", true);
            reject(new Error("DFS module failed to load"));
          } else {
            setTimeout(checkDFS, 100);
          }
        };
        checkDFS();
      });
    }

    // Initialize everything once DFS is ready
    waitForDFS()
      .then(() => {
        updateStatus("All modules loaded. Ready to use!");

        // Set up Load All Nodes button event listener
        const loadAllNodesBtn = document.getElementById("loadAllNodesBtn");
        if (loadAllNodesBtn) {
          // Enable the button now that functions are ready
          loadAllNodesBtn.disabled = false;
          loadAllNodesBtn.textContent = "üï∏Ô∏è Load All Nodes";
          loadAllNodesBtn.title = "Click to load all nodes from the specified key";

          loadAllNodesBtn.addEventListener("click", function (ev) {
            ev.preventDefault();
            if (typeof window.loadAllNodesMode === 'function') {
              window.loadAllNodesMode();
            } else {
              updateStatus("‚ùå Load All Nodes function not available", true);
              console.error("‚ùå loadAllNodesMode function not available");
            }
          });
        }

        // Override the start function with a safer version
        const startButton = document.getElementById("startButton");
        if (startButton) {
          startButton.addEventListener("click", function (ev) {
            ev.preventDefault();
            updateStatus("Start button clicked...");

            const relayPeer = document
              .getElementById("relayPeer")
              .value.trim();
            // Use centralized admin password
            const authToken =
              ShogunAdmin.getPassword() ||
              document.getElementById("authToken").value.trim();
            const key = document.getElementById("key").value.trim();
            const label = document.getElementById("label").value.trim();

            // Validation
            if (!relayPeer) {
              updateStatus("Please enter a relay peer URL", true);
              alert("Please enter a relay peer URL");
              return;
            }

            if (!authToken) {
              updateStatus(
                "Please enter an auth token. Set it in the Control Panel for automatic loading.",
                true
              );
              alert(
                "Please enter an auth token. Set it in the Control Panel for automatic loading."
              );
              return;
            }

            if (!key) {
              updateStatus("Please enter a key to start from", true);
              alert("Please enter a key to start from");
              return;
            }

            if (!isGunReady || !window.gun) {
              updateStatus("Gun instance not ready, recreating...");
              const gunInstance = createGunInstance();
              if (!gunInstance) {
                updateStatus("Failed to create Gun instance", true);
                alert(
                  "Failed to connect to Gun database. Please check your settings."
                );
                return;
              }
            }

            // Recreate Gun instance with current peer if it changed
            const currentPeers = window.gun ? window.gun._.opt.peers : {};
            const currentPeer = Object.keys(currentPeers)[0];
            if (!currentPeer || currentPeer !== relayPeer) {
              updateStatus("Peer changed, recreating Gun instance...");
              const gunInstance = createGunInstance();
              if (!gunInstance) {
                updateStatus("Failed to recreate Gun instance", true);
                alert(
                  "Failed to connect to the new peer. Please check the URL."
                );
                return;
              }
            }

            if (window.DFS && window.DFS.search) {
              updateStatus(
                `Starting DFS search with key: ${key}${label ? `, label: ${label}` : ""
                }`
              );
              try {
                window.DFS.search(key, label);
              } catch (error) {
                updateStatus(`DFS search error: ${error.message}`, true);
                alert(`Search failed: ${error.message}`);
              }
            } else {
              updateStatus("DFS module not available", true);
              alert("DFS module is not available. Please refresh the page.");
            }
          });
        }
      })
      .catch((error) => {
        updateStatus(`Failed to initialize: ${error.message}`, true);
        alert(
          "Failed to initialize the application. Please refresh the page."
        );
      });
  </script>
</body>

</html>