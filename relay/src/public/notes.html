<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Notes</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        body { background-color: #222; color: #eee; font-family: "Menlo", "Consolas", monospace; line-height: 1.6; margin: 2em; }
        h1 { border-bottom: 1px solid #555; padding-bottom: 10px; }
        a { color: #8af; text-decoration: none; }
        a:hover { background-color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #2a2a2a; padding: 2em; border-radius: 5px; border: 1px solid #444; }
        input[type="password"] { background-color: #444; color: #eee; border: 1px solid #666; padding: 12px; font-family: inherit; width: 100%; box-sizing: border-box; margin: 8px 0; }
        textarea { background-color: #333; color: #eee; border: 1px solid #666; padding: 1em; font-family: inherit; width: 100%; box-sizing: border-box; margin: 8px 0; height: 50vh; border-radius: 4px; }
        button { background-color: #444; color: #eee; border: 1px solid #666; padding: 12px 24px; cursor: pointer; font-family: inherit; margin: 8px 0; }
        button:hover { background-color: #555; }
        #message { padding: 1em; margin: 1em 0; border-radius: 4px; display: none; }
        .success { background-color: #143; border: 1px solid #175; }
        .error { background-color: #412; border: 1px solid #511; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/">&larr; Back to Control Panel</a>
        <h1>Admin Notes</h1>
        
        <section>
            <h2>Authentication</h2>
            <input type="password" id="adminToken" placeholder="Admin Token" />
        </section>

        <section>
            <h2>Your Private, Encrypted Notes</h2>
            <textarea id="notesArea" placeholder="Enter your admin token to load encrypted notes..."></textarea>
            <button onclick="saveNotes()">Save Encrypted Notes</button>
            <button onclick="deleteNotes()" class="danger">Delete Notes</button>
        </section>

        <div id="message"></div>
    </div>

    <script>
        const adminTokenInput = document.getElementById('adminToken');
        const notesArea = document.getElementById('notesArea');
        const messageEl = document.getElementById('message');

        // Gun SEA is available globally after including the scripts
        const SEA = window.SEA;

        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = isError ? 'error' : 'success';
            messageEl.style.display = 'block';
            setTimeout(() => { messageEl.style.display = 'none'; }, 3000);
        }
        
        async function apiCall(endpoint, method = 'GET', body) {
            const token = adminTokenInput.value;
            if (!token) {
                showMessage('Admin Token is required.', true);
                return null;
            }

            try {
                const options = {
                    method,
                    headers: { 'Authorization': `Bearer ${token}` },
                };
                if (body) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(endpoint, options);
                
                if (method === 'DELETE' && response.ok) {
                    return await response.json();
                }

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `HTTP Error: ${response.status}`);
                }
                return result;
            } catch (error) {
                showMessage(error.message, true);
                return null;
            }
        }

        async function loadNotes() {
            const secret = adminTokenInput.value;
            if (!secret) {
                notesArea.value = '';
                return;
            }
            const result = await apiCall('/api/notes');
            if (result && result.notes) {
                try {
                    const decryptedNotes = await SEA.decrypt(result.notes, secret);
                    if (decryptedNotes) {
                        notesArea.value = decryptedNotes;
                        showMessage('Notes decrypted and loaded.', false);
                    } else {
                        notesArea.value = '';
                        showMessage('Could not decrypt notes. Check your token or save new notes to overwrite.', true);
                    }
                } catch(e) {
                    notesArea.value = '';
                    showMessage('Decryption failed. The data may not be encrypted or the token is wrong.', true);
                }
            } else {
                notesArea.value = ''; // Clear if no notes are found
            }
        }

        async function saveNotes() {
            const secret = adminTokenInput.value;
            if (!secret) {
                showMessage('Admin Token is required to encrypt and save notes.', true);
                return;
            }
            const notes = notesArea.value;
            const encryptedNotes = await SEA.encrypt(notes, secret);
            
            const result = await apiCall('/api/notes', 'POST', { notes: encryptedNotes });
            if (result) {
                showMessage('Notes encrypted and saved successfully!', false);
            }
        }

        async function deleteNotes() {
            if (!confirm('Are you sure you want to delete all notes permanently? This cannot be undone.')) {
                return;
            }
            const result = await apiCall('/api/notes', 'DELETE');
            if (result && result.success) {
                notesArea.value = '';
                showMessage('Notes deleted successfully.', false);
            }
        }

        // Auto-load notes if token is stored
        window.onload = () => {
            const storedToken = localStorage.getItem('shogun-relay-admin-token');
            if (storedToken) {
                adminTokenInput.value = storedToken;
                loadNotes();
            }
        };

        adminTokenInput.addEventListener('change', () => {
             localStorage.setItem('shogun-relay-admin-token', adminTokenInput.value);
             loadNotes(); // Load notes when token is entered/changed
        });
    </script>
</body>
</html>   