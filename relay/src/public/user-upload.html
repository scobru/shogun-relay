<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Upload - Smart Contract</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <link href="styles/wormhole.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        body {
            line-height: 1.6;
            background-color: #1A1A1A;
        }

        .drag-drop-area {
            border: 2px dashed #606060;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: rgba(64, 64, 64, 0.3);
        }

        .drag-drop-area.drag-over {
            border-color: #FF69B4;
            background-color: rgba(255, 105, 180, 0.1);
        }

        .upload-card {
            background-color: #404040;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #606060;
        }

        .file-item {
            background-color: #282828;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #606060;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background-color: #404040;
        }

        .pubkey-display {
            font-family: monospace;
            font-size: 0.875rem;
            background-color: #404040;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #606060;
            word-break: break-all;
            color: #E0E0E0;
        }

        /* Stili migliorati per i badge - design elegante e minimalista */
        .encrypted-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            min-width: 80px;
        }

        .encrypted-badge:hover {
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }

        .encrypted-badge .lock-icon {
            width: 12px;
            height: 12px;
            opacity: 0.95;
        }

        .plain-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 1px 3px rgba(107, 114, 128, 0.2);
            border: 1px solid rgba(107, 114, 128, 0.3);
            min-width: 80px;
        }

        .plain-badge:hover {
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
            transform: translateY(-1px);
        }
    </style>
    <!-- Include Gun and SEA for encryption -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>

<body class="antialiased bg-[#1A1A1A]">
    <div class="container mx-auto p-6">
        <div class="flex items-center mb-6">
            <a href="/" class="text-[#42A5F5] hover:text-[#64B5F6] transition-colors text-lg">&larr; Back to Control Panel</a>
        </div>

        <div class="card bg-[#282828] border-[#404040] rounded-2xl">
            <div class="p-8 sm:p-10">
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-6 text-[#FF69B4]" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>

                    <h1 class="text-3xl font-semibold mb-3 text-[#FFFFFF]">User Upload</h1>
                    <p class="text-[#A0A0A0] text-lg mb-8">Upload files using your Ethereum wallet</p>

                    <!-- Subscription Status Link -->
                    <div class="mb-6">
                        <a href="/subscribe" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-6 py-3 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Check Subscription Status
                        </a>
                    </div>

                    <!-- Setup Section -->
                    <div class="w-full max-w-4xl space-y-8">
                        <!-- Wallet Setup -->
                        <div class="upload-card">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-[#FF69B4]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                                Wallet Setup
                            </h3>
                            <p class="text-[#A0A0A0] text-base mb-6">
                                Connetti il tuo wallet Ethereum. Tutti i file caricati saranno associati al tuo address.
                            </p>
                            <div class="form-control mb-6">
                                <label class="label">
                                    <span class="label-text text-[#FFFFFF] text-base">Wallet Connection:</span>
                                </label>
                                <div class="flex items-center gap-3">
                                    <button id="connectWalletBtn" class="btn bg-[#FF69B4] hover:bg-[#FF1493] border-0 text-[#FFFFFF] rounded-xl px-6 py-3 font-medium">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                        Connect MetaMask
                                    </button>
                                    <span id="walletStatus" class="text-base text-[#A0A0A0]">Not connected</span>
                                </div>
                                <div id="walletInfo" class="mt-3 hidden">
                                    <div class="bg-[#282828] rounded-xl p-4">
                                        <p class="text-base text-[#A0A0A0] mb-2">Connected Wallet:</p>
                                        <div class="font-mono text-base text-[#E0E0E0]" id="walletAddress"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Section -->
                        <div id="uploadSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-[#FF69B4]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                Upload Files
                            </h3>

                            <div class="mb-6 space-y-3">
                                <div>
                                    <p class="text-base text-[#A0A0A0] mb-2">Wallet Address:</p>
                                    <div class="pubkey-display" id="currentWalletAddress"></div>
                                </div>

                                <!-- Subscription Status -->
                                <div id="subscriptionStatus" class="mt-6">
                                    <div class="bg-[#282828] rounded-xl p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold flex items-center gap-2 text-[#FFFFFF]">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                Subscription Status
                                            </h4>
                                            <button id="refreshSubscriptionBtn" class="btn btn-xs bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-lg"
                                                onclick="checkSubscriptionStatus(walletAddress)">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                                Refresh
                                            </button>
                                        </div>
                                        <div id="subscriptionDetails" class="text-base space-y-2">
                                            <p class="text-[#A0A0A0]">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="drag-drop-area" id="dropArea">
                                <svg class="flex flex-col items-center w-16 h-16 mx-auto mb-4"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                        clip-rule="evenodd" />
                                </svg>
                                <p class="text-[#E0E0E0] text-lg">Drag & drop files here or click to select</p>
                                <input type="file" id="fileInput" class="hidden" />
                            </div>

                            <div class="form-control mb-6">
                                <label class="label cursor-pointer justify-start gap-3">
                                    <input type="checkbox" id="encryptCheck" class="checkbox checkbox-primary" />
                                    <span class="label-text text-[#E0E0E0] text-base">üîí Encrypt file with wallet signature</span>
                                </label>
                                <div class="label-text-alt text-[#A0A0A0] mt-2">
                                    Files will be encrypted with a deterministic key derived from your wallet signature
                                </div>
                            </div>

                            <div class="upload-progress hidden" id="uploadProgress">
                                <div class="progress-bar" id="progressBar">0%</div>
                            </div>

                            <button id="uploadBtn" class="btn bg-[#FF69B4] hover:bg-[#FF1493] border-0 text-[#FFFFFF] mt-6 rounded-xl px-8 py-4 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                Upload File
                            </button>
                        </div>

                        <!-- Files List -->
                        <div id="filesSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-[#FF69B4]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Your Files
                            </h3>

                            <div class="flex items-center justify-between mb-6">
                                <div class="text-base text-[#A0A0A0]">
                                    <span id="fileCount">0</span> files,
                                    <span id="totalSize">0 MB</span> total
                                </div>
                                <div class="flex items-center gap-3">
                                    <button id="refreshFilesBtn" class="btn btn-sm bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-lg">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Refresh
                                    </button>
                                    <button id="syncMBBtn" class="btn btn-sm bg-[#FF69B4] hover:bg-[#FF1493] border-0 text-[#FFFFFF] rounded-lg" onclick="syncMBUsage()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Sync MB
                                    </button>
                                    <button id="debugMBBtn" class="btn btn-sm bg-[#42A5F5] hover:bg-[#64B5F6] border-0 text-[#FFFFFF] rounded-lg" onclick="debugMBUsage()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        Debug MB
                                    </button>
                                    <button id="repairFilesBtn" class="btn btn-sm bg-[#FFA500] hover:bg-[#FF8C00] border-0 text-[#FFFFFF] rounded-lg" onclick="repairFiles()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Repair Files
                                    </button>
                                </div>
                            </div>

                            <div id="filesList" class="space-y-4">
                                <!-- Files will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage" class="w-full max-w-4xl mt-8"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let walletAddress = '';

        // DOM elements
        const uploadSection = document.getElementById('uploadSection');
        const currentWalletAddressEl = document.getElementById('currentWalletAddress');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const filesSection = document.getElementById('filesSection');
        const filesList = document.getElementById('filesList');
        const fileCount = document.getElementById('fileCount');
        const totalSize = document.getElementById('totalSize');
        const refreshFilesBtn = document.getElementById('refreshFilesBtn');
        const statusMessage = document.getElementById('statusMessage');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddressEl = document.getElementById('walletAddress');
        const subscriptionStatusEl = document.getElementById('subscriptionStatus');
        const subscriptionDetailsEl = document.getElementById('subscriptionDetails');
        const refreshSubscriptionBtn = document.getElementById('refreshSubscriptionBtn');
        const encryptCheck = document.getElementById('encryptCheck');


        // Event listeners
        uploadBtn.addEventListener('click', () => {
            console.log('üñ±Ô∏è user-upload: Upload button clicked');
            uploadFile();
        });
        refreshFilesBtn.addEventListener('click', async () => {
            console.log('üñ±Ô∏è user-upload: Refresh button clicked');
            
            // Prima sincronizza i MB
            await syncMBUsage();
            
            // Poi ricarica i file con un delay per GunDB
            setTimeout(() => {
              loadUserFiles();
            }, 1000); // 1 secondo di delay
        });
        connectWalletBtn.addEventListener('click', () => {
            console.log('üñ±Ô∏è user-upload: Connect wallet button clicked');
            connectWallet();
        });
        refreshSubscriptionBtn.addEventListener('click', () => {
            console.log('üñ±Ô∏è user-upload: Refresh subscription button clicked');
            checkSubscriptionStatus(walletAddress);
        });
        encryptCheck.addEventListener('change', (e) => {
            console.log('üîí user-upload: Encrypt checkbox changed:', e.target.checked);
            // This checkbox is for user-facing, so we don't need to store its state globally
            // The actual encryption logic will be handled on the backend or client-side
        });


        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropArea.classList.add('drag-over');
        }

        function unhighlight(e) {
            dropArea.classList.remove('drag-over');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            checkFileSize(files[0]);
        }

        // Aggiungi event listener per il file input
        fileInput.addEventListener('change', (e) => {
            console.log('üìÅ user-upload: File input change event triggered');
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                console.log('üìÅ user-upload: File selected:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                checkFileSize(file);
            } else {
                console.log('üìÅ user-upload: No file selected');
            }
        });

        // Verifica la dimensione del file
        function checkFileSize(file) {
            if (!file) {
                console.log('üìÅ user-upload: No file provided to checkFileSize');
                return;
            }

            console.log('üìÅ user-upload: Checking file size for:', file.name);
            const fileSizeMB = Math.ceil(file.size / (1024 * 1024)); // Arrotonda sempre verso l'alto
            const maxFileSize = 100; // MB massimi per file (puoi modificare questo valore)

            console.log('üìÅ user-upload: File size:', fileSizeMB, 'MB (max:', maxFileSize, 'MB)');

            if (fileSizeMB > maxFileSize) {
                console.log('‚ùå user-upload: File too large');
                showStatus(`‚ùå File too large! Maximum size is ${maxFileSize} MB`, 'error');
                fileInput.value = '';
                return;
            }

            console.log('‚úÖ user-upload: File size OK');
            showStatus(`üìÅ File selected: ${file.name} (${fileSizeMB} MB)`, 'info');
        }

        // Controlla lo stato della sottoscrizione
        async function checkSubscriptionStatus(walletAddr) {
            try {
                console.log('üîç user-upload: checkSubscriptionStatus called with walletAddr:', walletAddr);

                if (!walletAddr) {
                    console.log('‚ùå user-upload: No wallet address provided');
                    showStatus('No wallet address provided', 'error');
                    return;
                }

                // Verifica che l'elemento esista
                if (!subscriptionDetailsEl) {
                    console.error('‚ùå user-upload: subscriptionDetailsEl not found');
                    return;
                }

                // Mostra loading state
                subscriptionDetailsEl.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading loading-spinner loading-sm"></div>
                        <p class="text-sm text-[#A0A0A0] mt-2">Checking subscription status...</p>
                    </div>
                `;
                subscriptionStatusEl.classList.remove('hidden');

                // Usa il nuovo endpoint centralizzato
                const url = `/api/v1/subscriptions/user-subscription-details/${encodeURIComponent(walletAddr)}`;
                console.log(`üîç user-upload: Making API call to: ${url}`);
                
                // Log dettagliato della richiesta
                console.log(`üîç user-upload: Request details:`, {
                  url: url,
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                
                const response = await fetch(url);
                console.log(`üì° user-upload: Response status: ${response.status}`);
                console.log(`üì° user-upload: Response headers:`, Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log(`üìã user-upload: Response data:`, result);
                
                // Log dettagliato della risposta
                console.log(`üìã user-upload: Subscription response details:`, {
                  success: result.success,
                  chainId: result.chainId,
                  userAddress: result.userAddress,
                  subscription: result.subscription,
                  mbUsed: result.subscription?.mbUsed,
                  mbRemaining: result.subscription?.mbRemaining,
                  usagePercentage: result.subscription?.usagePercentage
                });

                if (result.success) {
                    const details = result.subscription;
                    console.log('üìä user-upload: Subscription details:', details);

                    if (details.isActive) {
                        console.log('‚úÖ user-upload: Subscription is ACTIVE');
                        const mbAllocated = details.mbAllocated || 0;
                        const mbUsed = details.mbUsed || 0;
                        const mbRemaining = details.mbRemaining || 0;
                        const usagePercentage = details.usagePercentage || 0;

                        subscriptionDetailsEl.innerHTML = `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-[#A0A0A0]">Status:</p>
                                    <p class="text-success font-semibold text-[#10B981]">‚úÖ Active</p>
                                </div>
                                <div>
                                    <p class="text-[#A0A0A0]">Days Remaining:</p>
                                    <p class="font-semibold text-[#FF69B4]">${details.daysRemaining}</p>
                                </div>
                                <div>
                                    <p class="text-[#A0A0A0]">Total MB:</p>
                                    <p class="font-semibold text-[#FF69B4]">${mbAllocated} MB</p>
                                </div>
                                <div>
                                    <p class="text-[#A0A0A0]">Used MB:</p>
                                    <p class="font-semibold text-[#FF69B4]">${mbUsed} MB (${usagePercentage}%)</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-[#A0A0A0]">Remaining MB:</p>
                                    <p class="font-semibold text-[#FF69B4]">${mbRemaining} MB</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-[#404040] rounded-full h-2">
                                    <div class="bg-[#FF69B4] h-2 rounded-full" style="width: ${usagePercentage}%"></div>
                                </div>
                                <p class="text-xs text-[#A0A0A0] mt-1">Storage usage: ${usagePercentage}%</p>
                            </div>
                        `;

                        console.log('‚úÖ user-upload: Subscription status updated successfully');
                    } else {
                        console.log('‚ùå user-upload: Subscription is NOT active. Reason:', details.reason);
                        subscriptionDetailsEl.innerHTML = `
                            <div class="text-center">
                                <p class="text-warning font-semibold mb-2 text-[#FFD700]">‚ö†Ô∏è No active subscription</p>
                                <p class="text-[#A0A0A0] mb-3">You need an active subscription to upload files</p>
                                <a href="/subscribe" class="btn bg-transparent border-[#FF69B4] text-[#FF69B4] hover:bg-[#FF1493] rounded-lg px-6 py-3 font-medium">
                                    Subscribe Now
                                </a>
                            </div>
                        `;
                    }
                } else {
                    console.log('‚ùå user-upload: API call failed:', result.error);
                    subscriptionDetailsEl.innerHTML = `
                        <div class="text-center">
                            <p class="text-error font-semibold text-[#FF4444]">‚ùå Error checking subscription</p>
                            <p class="text-[#A0A0A0]">${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('üí• user-upload: Error checking subscription status:', error);

                if (subscriptionDetailsEl) {
                    subscriptionDetailsEl.innerHTML = `
                        <div class="text-center">
                            <p class="text-error font-semibold text-[#FF4444]">‚ùå Connection error</p>
                            <p class="text-[#A0A0A0]">${error.message}</p>
                            <button onclick="checkSubscriptionStatus('${walletAddr}')" class="btn btn-sm bg-transparent border-[#FF69B4] text-[#FF69B4] hover:bg-[#FF1493] rounded-lg mt-2">
                                Retry
                            </button>
                        </div>
                    `;
                }

                if (subscriptionStatusEl) {
                    subscriptionStatusEl.classList.remove('hidden');
                }
            }
        }

        // File upload
        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                showStatus('Please select a file to upload', 'error');
                return;
            }

            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('üì§ user-upload: Starting file upload');
                console.log('üì§ user-upload: File details:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                console.log('üì§ user-upload: Wallet address:', walletAddress);
                console.log('üîí user-upload: Encryption enabled:', encryptCheck.checked);

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                uploadProgress.classList.remove('hidden');

                let fileToUpload = file;
                let encryptionKey = null;

                // Se la crittografia √® abilitata, genera la chiave dalla firma MetaMask
                if (encryptCheck.checked) {
                    try {
                        progressBar.style.width = "25%";
                        progressBar.textContent = "Signing with MetaMask...";

                        // Genera un messaggio unico per la firma
                        const message = `I Love Shogun`;

                        console.log('üîê user-upload: Requesting signature for message:', message);

                        // Richiedi la firma a MetaMask
                        const signature = await ethereum.request({
                            method: 'personal_sign',
                            params: [message, walletAddress]
                        });

                        console.log('üîê user-upload: Signature received:', signature.substring(0, 20) + '...');

                        // Genera una chiave deterministica dalla firma
                        encryptionKey = await generateDeterministicKey(signature, walletAddress);
                        console.log('üîê user-upload: Encryption key generated');

                        progressBar.style.width = "50%";
                        progressBar.textContent = "Encrypting file...";

                        // Converti il file in base64
                        const base64data = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (err) => reject(err);
                            reader.readAsDataURL(file);
                        });

                        // Cripta il file
                        const encryptedData = await SEA.encrypt(base64data, encryptionKey);
                        fileToUpload = new File([encryptedData], file.name + ".enc", {
                            type: "text/plain",
                        });

                        console.log('üîê user-upload: File encrypted successfully');
                        progressBar.style.width = "75%";
                        progressBar.textContent = "Encrypted! Uploading...";

                    } catch (encryptionError) {
                        console.error('üí• user-upload: Encryption error:', encryptionError);
                        showStatus(`‚ùå Encryption failed: ${encryptionError.message}`, 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload File';
                        uploadProgress.classList.add('hidden');
                        return;
                    }
                }

                const formData = new FormData();
                formData.append('file', fileToUpload);
                formData.append('encrypt', encryptCheck.checked);
                if (encryptionKey) {
                    formData.append('encryptionKey', encryptionKey);
                }

                console.log('üì§ user-upload: Sending request to /api/v1/ipfs/upload');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                // Timeout per l'upload di 120 secondi (aumentato per file grandi)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 120000); // 120 secondi

                const response = await fetch('/api/v1/ipfs/upload', {
                    method: 'POST',
                    headers: {
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('üì§ user-upload: Response status:', response.status);
                const result = await response.json();
                console.log('üì§ user-upload: Response data:', result);

                if (result.success) {
                    const actualSize = result.mbUsage.actualSizeMB;
                    const chargedSize = result.mbUsage.sizeMB;
                    const verified = result.mbUsage.verified;
                    const sizeInfo = actualSize !== chargedSize ?
                        ` (${actualSize} MB actual, ${chargedSize} MB charged)` :
                        ` (${chargedSize} MB)`;

                    const verificationInfo = verified ?
                        ` ‚úÖ Storage verified` :
                        ` ‚ö†Ô∏è Storage not verified`;

                    const encryptionInfo = encryptCheck.checked ?
                        ` üîí File encrypted with wallet signature` :
                        ` üìÑ File uploaded as plain text`;

                    showStatus(`‚úÖ File uploaded successfully! Hash: ${result.file.hash}${sizeInfo}${verificationInfo}${encryptionInfo}`, 'success');
                    fileInput.value = '';

                    // Salva l'hash nel nodo systemhash (opzionale, non bloccante)
                    setTimeout(async () => {
                        try {
                            console.log('üíæ user-upload: Saving hash to systemhash node:', result.file.hash);
                            await saveHashToSystemHash(result.file.hash, walletAddress);
                            console.log('‚úÖ user-upload: Hash saved to systemhash node successfully');
                        } catch (systemHashError) {
                            console.warn('‚ö†Ô∏è user-upload: Failed to save hash to systemhash node:', systemHashError);
                            // Non blocchiamo l'upload se fallisce il salvataggio nel systemhash
                        }
                    }, 100); // Piccolo delay per non bloccare l'upload

                    // Chiama loadUserFiles dopo l'upload riuscito
                    console.log(`üì§ user-upload: Calling loadUserFiles after successful upload`);
                    
                    // Aggiungi un delay per permettere a GunDB di sincronizzare
                    setTimeout(() => {
                      loadUserFiles();
                    }, 2000); // 2 secondi di delay

                    await checkSubscriptionStatus(walletAddress);

                } else {
                    let errorMessage = result.error;

                    // Gestisci errori specifici
                    if (result.error === 'Storage insufficiente per questo file') {
                        errorMessage = `‚ùå Storage insufficiente! File requires ${result.details.requiredMB} MB. Please add more MB to your subscription.`;
                    } else if (result.error === 'Errore verifica storage disponibile') {
                        errorMessage = `‚ùå Storage verification error: ${result.details}`;
                    }

                    showStatus(errorMessage, 'error');
                }

            } catch (error) {
                console.error('üí• user-upload: Upload error:', error);

                if (error.name === 'AbortError') {
                    showStatus('‚ùå Upload timeout after 120 seconds', 'error');
                } else {
                    showStatus(`‚ùå Upload error: ${error.message}`, 'error');
                }
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                uploadProgress.classList.add('hidden');
            }
        }

        // Funzione per ottenere la firma del wallet per autenticazione
        async function getWalletSignature() {
            try {
                const message = "I Love Shogun";
                console.log('üîê user-upload: Requesting signature for authentication:', message);

                const signature = await ethereum.request({
                    method: 'personal_sign',
                    params: [message, walletAddress]
                });

                console.log('üîê user-upload: Authentication signature received:', signature.substring(0, 20) + '...');
                return signature;
            } catch (error) {
                console.error('üí• user-upload: Error getting wallet signature:', error);
                throw new Error('Failed to get wallet signature for authentication');
            }
        }

        // Funzione per generare una chiave deterministica dalla firma
        async function generateDeterministicKey(signature, walletAddress) {
            try {
                // Combina la firma con l'address per creare una chiave unica
                const combinedData = signature + walletAddress;

                // Usa SHA-256 per creare un hash deterministico
                const encoder = new TextEncoder();
                const data = encoder.encode(combinedData);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);

                // Converti in stringa esadecimale
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // Prendi i primi 32 caratteri come chiave (128 bit)
                const key = hashHex.substring(0, 32);

                console.log('üîê user-upload: Generated deterministic key:', key.substring(0, 8) + '...');
                return key;
            } catch (error) {
                console.error('üí• user-upload: Error generating deterministic key:', error);
                throw new Error('Failed to generate encryption key');
            }
        }

        // Funzione per salvare l'hash nel nodo systemhash
        async function saveHashToSystemHash(fileHash, userAddress) {
            try {
                console.log('üíæ user-upload: saveHashToSystemHash called with:', { fileHash, userAddress });
                
                // Ottieni la firma del wallet per l'autenticazione
                console.log('üîê user-upload: Getting wallet signature for system hash save...');
                const authSignature = await getWalletSignature();
                console.log('üîê user-upload: Got signature, making request to save-system-hash...');

                const response = await fetch('/api/v1/user-uploads/save-system-hash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': userAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    },
                    body: JSON.stringify({
                        hash: fileHash,
                        userAddress: userAddress,
                        timestamp: Date.now()
                    })
                });

                console.log('üíæ user-upload: Save system hash response status:', response.status);
                const result = await response.json();
                console.log('üíæ user-upload: Save system hash response:', result);

                if (result.success) {
                    console.log('‚úÖ user-upload: Hash saved to systemhash node successfully');
                    return true;
                } else {
                    throw new Error(result.error || 'Failed to save hash to systemhash node');
                }
            } catch (error) {
                console.error('üí• user-upload: Error saving hash to systemhash node:', error);
                throw error;
            }
        }

        // Carica i file dell'utente
        async function loadUserFiles() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('üìÇ user-upload: Loading files for wallet:', walletAddress);
                console.log('üìÇ user-upload: Making request to:', `/api/v1/user-uploads/${encodeURIComponent(walletAddress)}`);
                
                // Verifica che gli elementi DOM esistano
                console.log('üìÇ user-upload: filesSection element:', filesSection);
                console.log('üìÇ user-upload: filesList element:', filesList);
                console.log('üìÇ user-upload: fileCount element:', fileCount);
                console.log('üìÇ user-upload: totalSize element:', totalSize);
                
                const response = await fetch(`/api/v1/user-uploads/${encodeURIComponent(walletAddress)}`);
                
                console.log('üìÇ user-upload: Response status:', response.status);
                console.log('üìÇ user-upload: Response ok:', response.ok);
                console.log('üìÇ user-upload: Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìÇ user-upload: Load files response:', result);
                console.log('üìÇ user-upload: Response success:', result.success);
                console.log('üìÇ user-upload: Response uploads:', result.uploads);
                console.log('üìÇ user-upload: Response count:', result.count);
                console.log('üìÇ user-upload: Response totalSizeMB:', result.totalSizeMB);

                if (result.success) {
                    console.log('üìÇ user-upload: Files found:', result.uploads);
                    console.log('üìÇ user-upload: Files count:', result.count);
                    console.log('üìÇ user-upload: Total size:', result.totalSizeMB);
                    console.log('üìÇ user-upload: Files array type:', Array.isArray(result.uploads));
                    console.log('üìÇ user-upload: Files array length:', result.uploads ? result.uploads.length : 'null');

                    // Verifica che filesList esista
                    if (!filesList) {
                        console.error('‚ùå user-upload: filesList element not found!');
                        showStatus('Error: filesList element not found', 'error');
                        return;
                    }

                    // Assicurati che la sezione files sia visibile
                    if (filesSection && filesSection.classList.contains('hidden')) {
                        console.log('üìÇ user-upload: Making filesSection visible');
                        filesSection.classList.remove('hidden');
                    }

                    console.log('üìÇ user-upload: Calling displayFiles with:', result.uploads);
                    displayFiles(result.uploads);

                    // Aggiorna i contatori
                    if (fileCount) {
                        fileCount.textContent = result.count;
                        console.log('üìÇ user-upload: Updated file count to:', result.count);
                    } else {
                        console.warn('‚ö†Ô∏è user-upload: fileCount element not found');
                    }

                    if (totalSize) {
                        const totalSizeMB = result.totalSizeMB || 0;
                        totalSize.textContent = `${totalSizeMB.toFixed(2)} MB`;
                        console.log('üìÇ user-upload: Updated total size to:', totalSizeMB.toFixed(2), 'MB');
                    } else {
                        console.warn('‚ö†Ô∏è user-upload: totalSize element not found');
                    }

                    console.log('‚úÖ user-upload: Files loaded and displayed successfully');
                } else {
                    console.error('‚ùå user-upload: Failed to load files:', result.error);
                    showStatus(`Failed to load files: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('üí• user-upload: Error loading files:', error);
                console.error('üí• user-upload: Error stack:', error.stack);
                showStatus(`Error loading files: ${error.message}`, 'error');
            }
        }

        // Sync MB usage
        async function syncMBUsage() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('üîÑ user-upload: Sync MB usage triggered for wallet:', walletAddress);
                showStatus('üîÑ Syncing MB usage...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/sync-mb-usage/${encodeURIComponent(walletAddress)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('üîÑ user-upload: Sync MB response:', result);

                if (result.success) {
                    showStatus(`‚úÖ MB usage synced successfully! Used: ${result.mbUsed} MB (${result.fileCount} files)`, 'success');

                    // Aggiorna immediatamente lo stato della sottoscrizione
                    await checkSubscriptionStatus(walletAddress);

                    // Ricarica anche i file per aggiornare i totali
                    await loadUserFiles();
                } else {
                    showStatus(`‚ùå Failed to sync MB usage: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('üí• user-upload: Error syncing MB usage:', error);
                showStatus(`‚ùå Error syncing MB usage: ${error.message}`, 'error');
            }
        }

        // Debug MB usage
        async function debugMBUsage() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('üêõ user-upload: Debug MB usage triggered for wallet:', walletAddress);
                showStatus('üêõ Debugging MB usage...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/debug-mb-usage/${encodeURIComponent(walletAddress)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('üêõ user-upload: Debug MB response:', result);

                if (result.success) {
                    // Mostra i dettagli del debug nella console
                    console.log('üêõ Debug details:', result.debug);
                    
                    // Mostra dettagli di ogni file
                    if (result.debug.files && result.debug.files.length > 0) {
                        console.log('üêõ File details:');
                        result.debug.files.forEach((file, index) => {
                            console.log(`üêõ File ${index + 1}:`, {
                                hash: file.hash,
                                name: file.name,
                                sizeMB: file.sizeMB,
                                data: file.data,
                                hasSizeMB: file.data && file.data.sizeMB !== undefined,
                                hasSize: file.data && file.data.size !== undefined
                            });
                        });
                    }
                    
                    // Calcola il totale dei MB dai file
                    let totalMB = 0;
                    let validFiles = 0;
                    let corruptedFiles = 0;
                    if (result.debug.files && result.debug.files.length > 0) {
                        result.debug.files.forEach(file => {
                            if (file.sizeMB && !isNaN(file.sizeMB)) {
                                totalMB += file.sizeMB;
                                validFiles++;
                            } else {
                                corruptedFiles++;
                                console.warn(`üêõ Corrupted file: ${file.hash}`, file.data);
                            }
                        });
                    }
                    
                    showStatus(`‚úÖ Debug completed! Found ${validFiles} valid files (${corruptedFiles} corrupted), total: ${totalMB.toFixed(2)} MB. Check console for details.`, 'success');
                } else {
                    showStatus(`‚ùå Failed to debug MB usage: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('üí• user-upload: Error debugging MB usage:', error);
                showStatus(`‚ùå Error debugging MB usage: ${error.message}`, 'error');
            }
        }

        // Repair Files
        async function repairFiles() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            if (!confirm('Are you sure you want to repair corrupted files? This will re-upload all your files to verify their integrity.')) {
                return;
            }

            try {
                console.log('üîß user-upload: Repairing files triggered for wallet:', walletAddress);
                showStatus('üîß Repairing files...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/repair-files/${encodeURIComponent(walletAddress)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('üîß user-upload: Repair files response:', result);

                if (result.success) {
                    showStatus(`‚úÖ Files repaired successfully! Total files repaired: ${result.repairedCount}`, 'success');
                    await loadUserFiles(); // Ricarica i file per aggiornare la lista
                    await checkSubscriptionStatus(walletAddress); // Aggiorna lo stato della sottoscrizione
                } else {
                    showStatus(`‚ùå Failed to repair files: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('üí• user-upload: Error repairing files:', error);
                showStatus(`‚ùå Error repairing files: ${error.message}`, 'error');
            }
        }

        function displayFiles(files) {
            console.log('üé® user-upload: Displaying files:', files);
            console.log('üé® user-upload: Files type:', typeof files);
            console.log('üé® user-upload: Files is array:', Array.isArray(files));
            console.log('üé® user-upload: Files length:', files ? files.length : 'null');

            // Verifica che filesList esista
            if (!filesList) {
                console.error('‚ùå user-upload: filesList element not found in displayFiles!');
                return;
            }

            console.log('üé® user-upload: filesList element found:', filesList);

            if (!files || files.length === 0) {
                console.log('üì≠ user-upload: No files to display');
                filesList.innerHTML = '<p class="text-[#A0A0A0] text-center py-8">No files uploaded yet</p>';
                return;
            }

            console.log(`üìÅ user-upload: Displaying ${files.length} files`);
            
            try {
                const filesHTML = files.map((file, index) => {
                    console.log(`üé® user-upload: Processing file ${index}:`, file);
                    
                    // Usa originalName se disponibile, altrimenti rimuovi .enc dal nome
                    const displayName = file.originalName || (file.name && file.name.endsWith('.enc') ? file.name.replace('.enc', '') : file.name);
                    const isEncrypted = file.encrypted || (file.name && file.name.endsWith('.enc'));

                    console.log(`üé® user-upload: File ${index} - displayName:`, displayName);
                    console.log(`üé® user-upload: File ${index} - isEncrypted:`, isEncrypted);

                    return `
                    <div class="file-item">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold text-[#FFFFFF]">${displayName}</h4>
                                    ${isEncrypted ? '<span class="encrypted-badge"><svg xmlns="http://www.w3.org/2000/svg" class="lock-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></svg> Encrypted</span>' : '<span class="plain-badge">üìÑ Plain</span>'}
                                </div>
                                <p class="text-base text-[#A0A0A0]">
                                    ${file.sizeMB} MB ‚Ä¢ ${new Date(file.uploadedAt).toLocaleString()}
                                </p>
                                <p class="text-xs font-mono text-[#FF69B4] mt-1">${file.hash}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="viewFile('${file.hash}', '${displayName}', ${isEncrypted})" class="btn btn-sm bg-transparent border-[#FF69B4] text-[#FF69B4] hover:bg-[#FF1493] rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                    ${isEncrypted ? 'Decrypt & View' : 'View'}
                                </button>
                                <button onclick="deleteFile('${file.hash}')" class="btn btn-sm bg-transparent border-[#FF4444] text-[#FF4444] hover:bg-[#FF1493] rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                console.log('üé® user-upload: Generated HTML length:', filesHTML.length);
                console.log('üé® user-upload: Setting filesList.innerHTML');
                
                filesList.innerHTML = filesHTML;
                
                console.log('üé® user-upload: HTML set successfully');
                console.log('üé® user-upload: filesList.innerHTML length:', filesList.innerHTML.length);
                
            } catch (error) {
                console.error('üí• user-upload: Error in displayFiles:', error);
                console.error('üí• user-upload: Error stack:', error.stack);
                filesList.innerHTML = '<p class="text-error text-center py-8">Error displaying files</p>';
            }
        }

        // View/Decrypt file
        async function viewFile(hash, fileName, isEncrypted) {
            try {
                if (isEncrypted) {
                    console.log('üîê user-upload: Decrypting file:', fileName);
                    showStatus('üîê Requesting signature for decryption...', 'info');

                    // Genera lo stesso messaggio usato per la crittografia
                    const message = `I Love Shogun`;

                    // Richiedi la firma a MetaMask
                    const signature = await ethereum.request({
                        method: 'personal_sign',
                        params: [message, walletAddress]
                    });

                    // Genera la stessa chiave deterministica
                    const encryptionKey = await generateDeterministicKey(signature, walletAddress);

                    showStatus('üîê Decrypting file...', 'info');

                    // Scarica il file crittografato
                    const response = await fetch(`/ipfs-content/${hash}`);
                    const encryptedData = await response.text();

                    // Decripta il file
                    const decryptedData = await SEA.decrypt(encryptedData, encryptionKey);

                    if (!decryptedData) {
                        throw new Error('Decryption failed - invalid key or corrupted data');
                    }

                    // Converti da base64 a blob
                    const base64Response = await fetch(decryptedData);
                    const blob = await base64Response.blob();

                    // Crea un URL per il download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus('‚úÖ File decrypted and downloaded successfully!', 'success');
                } else {
                    // File non crittografato - apri direttamente
                    console.log('üìÑ user-upload: Opening plain file:', fileName);
                    window.open(`/ipfs-content/${hash}`, '_blank');
                }
            } catch (error) {
                console.error('üí• user-upload: Error viewing/decrypting file:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Delete file function
        async function deleteFile(hash) {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete this file?`)) {
                return;
            }

            try {
                console.log('üóëÔ∏è user-upload: Deleting file with hash:', hash);
                showStatus('üóëÔ∏è Deleting file...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/${encodeURIComponent(walletAddress)}/${hash}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('üóëÔ∏è user-upload: Delete file response:', result);

                if (result.success) {
                    showStatus('‚úÖ File deleted successfully!', 'success');
                    
                    // Ricarica i file per aggiornare la lista
                    await loadUserFiles();
                } else {
                    showStatus(`‚ùå Failed to delete file: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('üí• user-upload: Error deleting file:', error);
                showStatus(`‚ùå Error deleting file: ${error.message}`, 'error');
            }
        }

        // Wallet connection
        async function connectWallet() {
            console.log('üîó user-upload: connectWallet called');

            if (typeof window.ethereum !== 'undefined') {
                try {
                    console.log('üîó user-upload: Requesting accounts from MetaMask');
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    walletAddress = accounts[0];
                    console.log('üîó user-upload: Wallet connected:', walletAddress);

                    walletAddressEl.textContent = walletAddress;
                    currentWalletAddressEl.textContent = walletAddress;
                    walletStatus.textContent = `Connected: ${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;
                    walletInfo.classList.remove('hidden');

                    // Mostra le sezioni di upload e file
                    uploadSection.classList.remove('hidden');
                    filesSection.classList.remove('hidden');

                    showStatus('Wallet connected!', 'success');

                    // Controlla lo stato della sottoscrizione
                    console.log('üîó user-upload: Calling checkSubscriptionStatus with walletAddress:', walletAddress);
                    checkSubscriptionStatus(walletAddress);
                    loadUserFiles();
                } catch (error) {
                    console.error('üí• user-upload: Error connecting wallet:', error);
                    showStatus('Failed to connect wallet. Please ensure MetaMask is unlocked.', 'error');
                }
            } else {
                console.log('‚ùå user-upload: MetaMask not found');
                showStatus('MetaMask is not installed. Please install MetaMask to use this feature.', 'warning');
            }
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const colors = {
                success: 'text-[#10B981]',
                error: 'text-[#FF4444]',
                info: 'text-[#42A5F5]',
                warning: 'text-[#FFD700]'
            };

            statusMessage.innerHTML = `
                <div class="alert ${colors[type]} bg-[#282828] border border-[#404040]">
                    <span>${message}</span>
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('Connect your wallet to start uploading files', 'info');
        });
    </script>
</body>

</html>