<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Upload - Smart Contract</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/wormhole.css" />
    <style>
        body {
            line-height: 1.6;
            background-color: rgb(25, 25, 25);
        }

        .drag-drop-area {
            @apply border-2 border-dashed border-base-content/20 rounded-xl p-8 text-center mt-6 mb-6 transition-all duration-300 cursor-pointer bg-base-300/30;
        }

        .drag-drop-area.drag-over {
            @apply border-accent bg-accent/10;
        }

        .upload-card {
            @apply bg-base-300/50 rounded-xl p-6 border border-base-content/20;
        }

        .file-item {
            @apply bg-base-200/50 rounded-lg p-4 border border-base-content/10 hover:bg-base-200/70 transition-colors;
        }

        .pubkey-display {
            @apply font-mono text-sm bg-base-300 p-3 rounded border break-all;
        }
    </style>
</head>

<body class="antialiased">
    <div class="container mx-auto p-4">
        <div class="flex items-center mb-6">
            <a href="/" class="nav-link">&larr; Back to Control Panel</a>
        </div>

        <div class="card">
            <div class="p-8">
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-accent" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>

                    <h1 class="text-3xl font-semibold mb-2">User Upload</h1>
                    <p class="text-base-content/70 mb-8">Upload files using your Ethereum wallet and Gun public key</p>

                    <!-- Setup Section -->
                    <div class="w-full max-w-4xl space-y-6">
                        <div class="upload-card">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                                Authorization Setup
                            </h3>
                            <p class="text-base-content/70 mb-4">
                                Enter your Ethereum wallet address and Gun public key. The wallet address must be
                                authorized via
                                smart contract subscription.
                            </p>

                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">Wallet Address:</span>
                                </label>
                                <input type="text" id="walletAddress" class="input input-bordered"
                                    placeholder="Enter your Ethereum wallet address (0x...)" />
                            </div>

                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">Gun Public Key:</span>
                                </label>
                                <textarea id="gunPubKey" class="textarea textarea-bordered h-20 font-mono text-sm"
                                    placeholder="Enter your Gun public key..."></textarea>
                            </div>

                            <button id="setAuthBtn" class="btn btn-accent">
                                Set Authorization
                            </button>
                        </div>

                        <!-- Upload Section -->
                        <div id="uploadSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                Upload Files
                            </h3>

                            <div class="mb-4 space-y-2">
                                <div>
                                    <p class="text-sm text-base-content/70 mb-1">Wallet Address:</p>
                                    <div class="pubkey-display" id="currentWallet"></div>
                                </div>
                                <div>
                                    <p class="text-sm text-base-content/70 mb-1">Gun Public Key:</p>
                                    <div class="pubkey-display" id="currentGunKey"></div>
                                </div>
                            </div>

                            <div class="drag-drop-area" id="dropArea">
                                <svg class="flex flex-col items-center w-16 h-16 mx-auto mb-4"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                        clip-rule="evenodd" />
                                </svg>
                                <p>Drag & drop files here or click to select</p>
                                <input type="file" id="fileInput" class="hidden" />
                            </div>

                            <div class="upload-progress hidden" id="uploadProgress">
                                <div class="progress-bar" id="progressBar">0%</div>
                            </div>

                            <button id="uploadBtn" class="btn btn-accent mt-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                Upload File
                            </button>
                        </div>

                        <!-- Files List -->
                        <div id="filesSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Your Files
                            </h3>

                            <div class="flex items-center justify-between mb-4">
                                <div class="text-sm text-base-content/70">
                                    <span id="fileCount">0</span> files,
                                    <span id="totalSize">0 MB</span> total
                                </div>
                                <button id="refreshFilesBtn" class="btn btn-sm btn-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Refresh
                                </button>
                            </div>

                            <div id="filesList" class="space-y-3">
                                <!-- Files will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage" class="w-full max-w-4xl mt-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentWalletAddress = '';
        let currentGunPubKey = '';

        // DOM elements
        const walletAddressInput = document.getElementById('walletAddress');
        const gunPubKeyInput = document.getElementById('gunPubKey');
        const setAuthBtn = document.getElementById('setAuthBtn');
        const uploadSection = document.getElementById('uploadSection');
        const currentWalletEl = document.getElementById('currentWallet');
        const currentGunKeyEl = document.getElementById('currentGunKey');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const filesSection = document.getElementById('filesSection');
        const filesList = document.getElementById('filesList');
        const fileCount = document.getElementById('fileCount');
        const totalSize = document.getElementById('totalSize');
        const refreshFilesBtn = document.getElementById('refreshFilesBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Event listeners
        setAuthBtn.addEventListener('click', setAuthorization);
        uploadBtn.addEventListener('click', uploadFile);
        refreshFilesBtn.addEventListener('click', loadUserFiles);

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropArea.classList.add('drag-over');
        }

        function unhighlight(e) {
            dropArea.classList.remove('drag-over');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
        }

        // Authorization setup
        function setAuthorization() {
            const walletAddress = walletAddressInput.value.trim();
            const gunPubKey = gunPubKeyInput.value.trim();

            if (!walletAddress) {
                showStatus('Please enter a wallet address', 'error');
                return;
            }

            if (!gunPubKey) {
                showStatus('Please enter a Gun public key', 'error');
                return;
            }

            // Validazione base dell'indirizzo Ethereum
            if (!walletAddress.startsWith('0x') || walletAddress.length !== 42) {
                showStatus('Please enter a valid Ethereum wallet address', 'error');
                return;
            }

            // Validazione base della chiave Gun
            if (gunPubKey.length < 20) {
                showStatus('Please enter a valid Gun public key', 'error');
                return;
            }

            currentWalletAddress = walletAddress;
            currentGunPubKey = gunPubKey;

            currentWalletEl.textContent = walletAddress;
            currentGunKeyEl.textContent = gunPubKey;

            uploadSection.classList.remove('hidden');
            filesSection.classList.remove('hidden');

            showStatus('Authorization set successfully!', 'success');
            loadUserFiles();
        }

        // File upload
        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                showStatus('Please select a file to upload', 'error');
                return;
            }

            if (!currentWalletAddress || !currentGunPubKey) {
                showStatus('Please set your authorization first', 'error');
                return;
            }

            try {
                uploadBtn.disabled = true;
                uploadProgress.classList.remove('hidden');

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/ipfs-upload-user', {
                    method: 'POST',
                    headers: {
                        'x-user-address': currentWalletAddress,
                        'x-pubkey': currentGunPubKey
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`File uploaded successfully! Hash: ${result.file.hash}`, 'success');
                    fileInput.value = '';
                    loadUserFiles(); // Refresh files list
                } else {
                    showStatus(`Upload failed: ${result.error}`, 'error');
                }

            } catch (error) {
                showStatus(`Upload error: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadProgress.classList.add('hidden');
            }
        }

        // Load user files
        async function loadUserFiles() {
            if (!currentWalletAddress) return;

            try {
                const response = await fetch(`/api/user-uploads/${encodeURIComponent(currentWalletAddress)}`);
                const result = await response.json();

                if (result.success) {
                    displayFiles(result.uploads);
                    fileCount.textContent = result.count;
                    totalSize.textContent = `${result.totalSizeMB.toFixed(2)} MB`;
                } else {
                    showStatus(`Failed to load files: ${result.error}`, 'error');
                }

            } catch (error) {
                showStatus(`Error loading files: ${error.message}`, 'error');
            }
        }

        function displayFiles(files) {
            if (files.length === 0) {
                filesList.innerHTML = '<p class="text-base-content/60 text-center py-8">No files uploaded yet</p>';
                return;
            }

            filesList.innerHTML = files.map(file => `
                <div class="file-item">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold">${file.name}</h4>
                            <p class="text-sm text-base-content/60">
                                ${file.sizeMB} MB • ${new Date(file.uploadedAt).toLocaleString()}
                            </p>
                            <p class="text-xs font-mono text-accent mt-1">${file.hash}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="${file.ipfsUrl}" target="_blank" class="btn btn-sm btn-outline">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                View
                            </a>
                            <button onclick="deleteFile('${file.hash}')" class="btn btn-sm btn-error">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete file
        async function deleteFile(hash) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            try {
                const response = await fetch(`/api/user-uploads/${encodeURIComponent(currentWalletAddress)}/${hash}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('File deleted successfully', 'success');
                    loadUserFiles(); // Refresh files list
                } else {
                    showStatus(`Failed to delete file: ${result.error}`, 'error');
                }

            } catch (error) {
                showStatus(`Error deleting file: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const colors = {
                success: 'text-success',
                error: 'text-error',
                info: 'text-info',
                warning: 'text-warning'
            };

            statusMessage.innerHTML = `
                <div class="alert ${colors[type]} bg-${type}/10 border border-${type}/20">
                    <span>${message}</span>
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('Enter your Ethereum wallet address and Gun public key to start uploading files', 'info');
        });
    </script>
</body>

</html>