<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Upload - Smart Contract</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/wormhole.css" />
    <style>
        body {
            line-height: 1.6;
            background-color: rgb(25, 25, 25);
        }

        .drag-drop-area {
            @apply border-2 border-dashed border-base-content/20 rounded-xl p-8 text-center mt-6 mb-6 transition-all duration-300 cursor-pointer bg-base-300/30;
        }

        .drag-drop-area.drag-over {
            @apply border-accent bg-accent/10;
        }

        .upload-card {
            @apply bg-base-300/50 rounded-xl p-6 border border-base-content/20;
        }

        .file-item {
            @apply bg-base-200/50 rounded-lg p-4 border border-base-content/10 hover:bg-base-200/70 transition-colors;
        }

        .pubkey-display {
            @apply font-mono text-sm bg-base-300 p-3 rounded border break-all;
        }

        /* Stili migliorati per i badge - design elegante e minimalista */
        .encrypted-badge {
            @apply inline-flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            min-width: 80px;
        }

        .encrypted-badge:hover {
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }

        .encrypted-badge .lock-icon {
            width: 12px;
            height: 12px;
            opacity: 0.95;
        }

        .plain-badge {
            @apply inline-flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 1px 3px rgba(107, 114, 128, 0.2);
            border: 1px solid rgba(107, 114, 128, 0.3);
            min-width: 80px;
        }

        .plain-badge:hover {
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
            transform: translateY(-1px);
        }
    </style>
    <!-- Include Gun and SEA for encryption -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>

<body class="antialiased">
    <div class="container mx-auto p-4">
        <div class="flex items-center mb-6">
            <a href="/" class="nav-link">&larr; Back to Control Panel</a>
        </div>

        <div class="card">
            <div class="p-8">
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-accent" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>

                    <h1 class="text-3xl font-semibold mb-2">User Upload</h1>
                    <p class="text-base-content/70 mb-8">Upload files using your Ethereum wallet</p>

                    <!-- Subscription Status Link -->
                    <div class="mb-6">
                        <a href="/subscribe" class="btn btn-outline btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Check Subscription Status
                        </a>
                    </div>

                    <!-- Setup Section -->
                    <div class="w-full max-w-4xl space-y-6">
                        <!-- Wallet Setup -->
                        <div class="upload-card">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                                Wallet Setup
                            </h3>
                            <p class="text-base-content/70 mb-4">
                                Connetti il tuo wallet Ethereum. Tutti i file caricati saranno associati al tuo address.
                            </p>
                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">Wallet Connection:</span>
                                </label>
                                <div class="flex items-center gap-2">
                                    <button id="connectWalletBtn" class="btn btn-accent">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                        Connect MetaMask
                                    </button>
                                    <span id="walletStatus" class="text-sm text-base-content/60">Not connected</span>
                                </div>
                                <div id="walletInfo" class="mt-2 hidden">
                                    <div class="bg-base-200/50 rounded-lg p-3">
                                        <p class="text-sm text-base-content/70 mb-1">Connected Wallet:</p>
                                        <div class="font-mono text-sm" id="walletAddress"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Section -->
                        <div id="uploadSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                Upload Files
                            </h3>

                            <div class="mb-4 space-y-2">
                                <div>
                                    <p class="text-sm text-base-content/70 mb-1">Wallet Address:</p>
                                    <div class="pubkey-display" id="currentWalletAddress"></div>
                                </div>

                                <!-- Subscription Status -->
                                <div id="subscriptionStatus" class="mt-4">
                                    <div class="bg-base-200/50 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="font-semibold flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                Subscription Status
                                            </h4>
                                            <button id="refreshSubscriptionBtn" class="btn btn-xs btn-outline"
                                                onclick="checkSubscriptionStatus(walletAddress)">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                                Refresh
                                            </button>
                                        </div>
                                        <div id="subscriptionDetails" class="text-sm space-y-1">
                                            <p class="text-base-content/60">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="drag-drop-area" id="dropArea">
                                <svg class="flex flex-col items-center w-16 h-16 mx-auto mb-4"
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                        clip-rule="evenodd" />
                                </svg>
                                <p>Drag & drop files here or click to select</p>
                                <input type="file" id="fileInput" class="hidden" />
                            </div>

                            <div class="form-control mb-4">
                                <label class="label cursor-pointer justify-start gap-3">
                                    <input type="checkbox" id="encryptCheck" class="checkbox checkbox-accent" />
                                    <span class="label-text">🔒 Encrypt file with wallet signature</span>
                                </label>
                                <div class="label-text-alt text-base-content/60 mt-1">
                                    Files will be encrypted with a deterministic key derived from your wallet signature
                                </div>
                            </div>

                            <div class="upload-progress hidden" id="uploadProgress">
                                <div class="progress-bar" id="progressBar">0%</div>
                            </div>

                            <button id="uploadBtn" class="btn btn-accent mt-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                Upload File
                            </button>
                        </div>

                        <!-- Files List -->
                        <div id="filesSection" class="upload-card hidden">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Your Files
                            </h3>

                            <div class="flex items-center justify-between mb-4">
                                <div class="text-sm text-base-content/70">
                                    <span id="fileCount">0</span> files,
                                    <span id="totalSize">0 MB</span> total
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="refreshFilesBtn" class="btn btn-sm btn-outline">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Refresh
                                    </button>
                                    <button id="syncMBBtn" class="btn btn-sm btn-accent" onclick="syncMBUsage()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Sync MB
                                    </button>
                                    <button id="debugMBBtn" class="btn btn-sm btn-outline" onclick="debugMBUsage()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                        Debug MB
                                    </button>
                                </div>
                            </div>

                            <div id="filesList" class="space-y-3">
                                <!-- Files will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage" class="w-full max-w-4xl mt-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let walletAddress = '';

        // DOM elements
        const uploadSection = document.getElementById('uploadSection');
        const currentWalletAddressEl = document.getElementById('currentWalletAddress');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const filesSection = document.getElementById('filesSection');
        const filesList = document.getElementById('filesList');
        const fileCount = document.getElementById('fileCount');
        const totalSize = document.getElementById('totalSize');
        const refreshFilesBtn = document.getElementById('refreshFilesBtn');
        const statusMessage = document.getElementById('statusMessage');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddressEl = document.getElementById('walletAddress');
        const subscriptionStatusEl = document.getElementById('subscriptionStatus');
        const subscriptionDetailsEl = document.getElementById('subscriptionDetails');
        const refreshSubscriptionBtn = document.getElementById('refreshSubscriptionBtn');
        const encryptCheck = document.getElementById('encryptCheck');


        // Event listeners
        uploadBtn.addEventListener('click', () => {
            console.log('🖱️ user-upload: Upload button clicked');
            uploadFile();
        });
        refreshFilesBtn.addEventListener('click', () => {
            console.log('🖱️ user-upload: Refresh button clicked');
            loadUserFiles();
        });
        connectWalletBtn.addEventListener('click', () => {
            console.log('🖱️ user-upload: Connect wallet button clicked');
            connectWallet();
        });
        refreshSubscriptionBtn.addEventListener('click', () => {
            console.log('🖱️ user-upload: Refresh subscription button clicked');
            checkSubscriptionStatus(walletAddress);
        });
        encryptCheck.addEventListener('change', (e) => {
            console.log('🔒 user-upload: Encrypt checkbox changed:', e.target.checked);
            // This checkbox is for user-facing, so we don't need to store its state globally
            // The actual encryption logic will be handled on the backend or client-side
        });


        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropArea.classList.add('drag-over');
        }

        function unhighlight(e) {
            dropArea.classList.remove('drag-over');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            checkFileSize(files[0]);
        }

        // Aggiungi event listener per il file input
        fileInput.addEventListener('change', (e) => {
            console.log('📁 user-upload: File input change event triggered');
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                console.log('📁 user-upload: File selected:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                checkFileSize(file);
            } else {
                console.log('📁 user-upload: No file selected');
            }
        });

        // Verifica la dimensione del file
        function checkFileSize(file) {
            if (!file) {
                console.log('📁 user-upload: No file provided to checkFileSize');
                return;
            }

            console.log('📁 user-upload: Checking file size for:', file.name);
            const fileSizeMB = Math.ceil(file.size / (1024 * 1024)); // Arrotonda sempre verso l'alto
            const maxFileSize = 100; // MB massimi per file (puoi modificare questo valore)

            console.log('📁 user-upload: File size:', fileSizeMB, 'MB (max:', maxFileSize, 'MB)');

            if (fileSizeMB > maxFileSize) {
                console.log('❌ user-upload: File too large');
                showStatus(`❌ File too large! Maximum size is ${maxFileSize} MB`, 'error');
                fileInput.value = '';
                return;
            }

            console.log('✅ user-upload: File size OK');
            showStatus(`📁 File selected: ${file.name} (${fileSizeMB} MB)`, 'info');
        }

        // Controlla lo stato della sottoscrizione
        async function checkSubscriptionStatus(walletAddr) {
            try {
                console.log('🔍 user-upload: checkSubscriptionStatus called with walletAddr:', walletAddr);

                if (!walletAddr) {
                    console.log('❌ user-upload: No wallet address provided');
                    showStatus('No wallet address provided', 'error');
                    return;
                }

                // Verifica che l'elemento esista
                if (!subscriptionDetailsEl) {
                    console.error('❌ user-upload: subscriptionDetailsEl not found');
                    return;
                }

                // Mostra loading state
                subscriptionDetailsEl.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading loading-spinner loading-sm"></div>
                        <p class="text-sm text-base-content/60 mt-2">Checking subscription status...</p>
                    </div>
                `;
                subscriptionStatusEl.classList.remove('hidden');

                // Usa il nuovo endpoint centralizzato
                const url = `/api/v1/subscriptions/user-subscription-details/${encodeURIComponent(walletAddr)}`;
                console.log('🔍 user-upload: Making API call to:', url);

                const response = await fetch(url);
                console.log('📡 user-upload: Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('📋 user-upload: Response data:', result);

                if (result.success) {
                    const details = result.subscription;
                    console.log('📊 user-upload: Subscription details:', details);

                    if (details.isActive) {
                        console.log('✅ user-upload: Subscription is ACTIVE');
                        const mbAllocated = details.mbAllocated || 0;
                        const mbUsed = details.mbUsed || 0;
                        const mbRemaining = details.mbRemaining || 0;
                        const usagePercentage = details.usagePercentage || 0;

                        subscriptionDetailsEl.innerHTML = `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-base-content/60">Status:</p>
                                    <p class="text-success font-semibold">✅ Active</p>
                                </div>
                                <div>
                                    <p class="text-base-content/60">Days Remaining:</p>
                                    <p class="font-semibold">${details.daysRemaining}</p>
                                </div>
                                <div>
                                    <p class="text-base-content/60">Total MB:</p>
                                    <p class="font-semibold">${mbAllocated} MB</p>
                                </div>
                                <div>
                                    <p class="text-base-content/60">Used MB:</p>
                                    <p class="font-semibold">${mbUsed} MB (${usagePercentage}%)</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-base-content/60">Remaining MB:</p>
                                    <p class="font-semibold text-accent">${mbRemaining} MB</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-base-300 rounded-full h-2">
                                    <div class="bg-accent h-2 rounded-full" style="width: ${usagePercentage}%"></div>
                                </div>
                                <p class="text-xs text-base-content/60 mt-1">Storage usage: ${usagePercentage}%</p>
                            </div>
                        `;

                        console.log('✅ user-upload: Subscription status updated successfully');
                    } else {
                        console.log('❌ user-upload: Subscription is NOT active. Reason:', details.reason);
                        subscriptionDetailsEl.innerHTML = `
                            <div class="text-center">
                                <p class="text-warning font-semibold mb-2">⚠️ No active subscription</p>
                                <p class="text-base-content/60 mb-3">You need an active subscription to upload files</p>
                                <a href="/subscribe" class="btn btn-sm btn-accent">
                                    Subscribe Now
                                </a>
                            </div>
                        `;
                    }
                } else {
                    console.log('❌ user-upload: API call failed:', result.error);
                    subscriptionDetailsEl.innerHTML = `
                        <div class="text-center">
                            <p class="text-error font-semibold">❌ Error checking subscription</p>
                            <p class="text-base-content/60">${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('💥 user-upload: Error checking subscription status:', error);

                if (subscriptionDetailsEl) {
                    subscriptionDetailsEl.innerHTML = `
                        <div class="text-center">
                            <p class="text-error font-semibold">❌ Connection error</p>
                            <p class="text-base-content/60">${error.message}</p>
                            <button onclick="checkSubscriptionStatus('${walletAddr}')" class="btn btn-sm btn-outline mt-2">
                                Retry
                            </button>
                        </div>
                    `;
                }

                if (subscriptionStatusEl) {
                    subscriptionStatusEl.classList.remove('hidden');
                }
            }
        }

        // File upload
        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                showStatus('Please select a file to upload', 'error');
                return;
            }

            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('📤 user-upload: Starting file upload');
                console.log('📤 user-upload: File details:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                console.log('📤 user-upload: Wallet address:', walletAddress);
                console.log('🔒 user-upload: Encryption enabled:', encryptCheck.checked);

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                uploadProgress.classList.remove('hidden');

                let fileToUpload = file;
                let encryptionKey = null;

                // Se la crittografia è abilitata, genera la chiave dalla firma MetaMask
                if (encryptCheck.checked) {
                    try {
                        progressBar.style.width = "25%";
                        progressBar.textContent = "Signing with MetaMask...";

                        // Genera un messaggio unico per la firma
                        const message = `I Love Shogun`;

                        console.log('🔐 user-upload: Requesting signature for message:', message);

                        // Richiedi la firma a MetaMask
                        const signature = await ethereum.request({
                            method: 'personal_sign',
                            params: [message, walletAddress]
                        });

                        console.log('🔐 user-upload: Signature received:', signature.substring(0, 20) + '...');

                        // Genera una chiave deterministica dalla firma
                        encryptionKey = await generateDeterministicKey(signature, walletAddress);
                        console.log('🔐 user-upload: Encryption key generated');

                        progressBar.style.width = "50%";
                        progressBar.textContent = "Encrypting file...";

                        // Converti il file in base64
                        const base64data = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (err) => reject(err);
                            reader.readAsDataURL(file);
                        });

                        // Cripta il file
                        const encryptedData = await SEA.encrypt(base64data, encryptionKey);
                        fileToUpload = new File([encryptedData], file.name + ".enc", {
                            type: "text/plain",
                        });

                        console.log('🔐 user-upload: File encrypted successfully');
                        progressBar.style.width = "75%";
                        progressBar.textContent = "Encrypted! Uploading...";

                    } catch (encryptionError) {
                        console.error('💥 user-upload: Encryption error:', encryptionError);
                        showStatus(`❌ Encryption failed: ${encryptionError.message}`, 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload File';
                        uploadProgress.classList.add('hidden');
                        return;
                    }
                }

                const formData = new FormData();
                formData.append('file', fileToUpload);
                formData.append('encrypt', encryptCheck.checked);
                if (encryptionKey) {
                    formData.append('encryptionKey', encryptionKey);
                }

                console.log('📤 user-upload: Sending request to /api/v1/ipfs/upload');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                // Timeout per l'upload di 60 secondi
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 60000);

                const response = await fetch('/api/v1/ipfs/upload', {
                    method: 'POST',
                    headers: {
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('📤 user-upload: Response status:', response.status);
                const result = await response.json();
                console.log('📤 user-upload: Response data:', result);

                if (result.success) {
                    const actualSize = result.mbUsage.actualSizeMB;
                    const chargedSize = result.mbUsage.sizeMB;
                    const verified = result.mbUsage.verified;
                    const sizeInfo = actualSize !== chargedSize ?
                        ` (${actualSize} MB actual, ${chargedSize} MB charged)` :
                        ` (${chargedSize} MB)`;

                    const verificationInfo = verified ?
                        ` ✅ Storage verified` :
                        ` ⚠️ Storage not verified`;

                    const encryptionInfo = encryptCheck.checked ?
                        ` 🔒 File encrypted with wallet signature` :
                        ` 📄 File uploaded as plain text`;

                    showStatus(`✅ File uploaded successfully! Hash: ${result.file.hash}${sizeInfo}${verificationInfo}${encryptionInfo}`, 'success');
                    fileInput.value = '';

                    console.log('📤 user-upload: Calling loadUserFiles after successful upload');

                    // Aggiorna immediatamente i file e lo stato della sottoscrizione
                    await loadUserFiles();
                    await checkSubscriptionStatus(walletAddress);

                } else {
                    let errorMessage = result.error;

                    // Gestisci errori specifici
                    if (result.error === 'Storage insufficiente per questo file') {
                        errorMessage = `❌ Storage insufficiente! File requires ${result.details.requiredMB} MB. Please add more MB to your subscription.`;
                    } else if (result.error === 'Errore verifica storage disponibile') {
                        errorMessage = `❌ Storage verification error: ${result.details}`;
                    }

                    showStatus(errorMessage, 'error');
                }

            } catch (error) {
                console.error('💥 user-upload: Upload error:', error);

                if (error.name === 'AbortError') {
                    showStatus('❌ Upload timeout after 60 seconds', 'error');
                } else {
                    showStatus(`❌ Upload error: ${error.message}`, 'error');
                }
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                uploadProgress.classList.add('hidden');
            }
        }

        // Funzione per ottenere la firma del wallet per autenticazione
        async function getWalletSignature() {
            try {
                const message = "I Love Shogun";
                console.log('🔐 user-upload: Requesting signature for authentication:', message);

                const signature = await ethereum.request({
                    method: 'personal_sign',
                    params: [message, walletAddress]
                });

                console.log('🔐 user-upload: Authentication signature received:', signature.substring(0, 20) + '...');
                return signature;
            } catch (error) {
                console.error('💥 user-upload: Error getting wallet signature:', error);
                throw new Error('Failed to get wallet signature for authentication');
            }
        }

        // Funzione per generare una chiave deterministica dalla firma
        async function generateDeterministicKey(signature, walletAddress) {
            try {
                // Combina la firma con l'address per creare una chiave unica
                const combinedData = signature + walletAddress;

                // Usa SHA-256 per creare un hash deterministico
                const encoder = new TextEncoder();
                const data = encoder.encode(combinedData);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);

                // Converti in stringa esadecimale
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // Prendi i primi 32 caratteri come chiave (128 bit)
                const key = hashHex.substring(0, 32);

                console.log('🔐 user-upload: Generated deterministic key:', key.substring(0, 8) + '...');
                return key;
            } catch (error) {
                console.error('💥 user-upload: Error generating deterministic key:', error);
                throw new Error('Failed to generate encryption key');
            }
        }

        // Carica i file dell'utente
        async function loadUserFiles() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('📂 user-upload: Loading files for wallet:', walletAddress);
                const response = await fetch(`/api/v1/user-uploads/${encodeURIComponent(walletAddress)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('📂 user-upload: Load files response:', result);

                if (result.success) {
                    console.log('📂 user-upload: Files found:', result.uploads);
                    console.log('📂 user-upload: Files count:', result.count);
                    console.log('📂 user-upload: Total size:', result.totalSizeMB);

                    displayFiles(result.uploads);

                    // Aggiorna i contatori
                    if (fileCount) {
                        fileCount.textContent = result.count;
                        console.log('📂 user-upload: Updated file count to:', result.count);
                    }

                    if (totalSize) {
                        const totalSizeMB = result.totalSizeMB || 0;
                        totalSize.textContent = `${totalSizeMB.toFixed(2)} MB`;
                        console.log('📂 user-upload: Updated total size to:', totalSizeMB.toFixed(2), 'MB');
                    }

                    console.log('✅ user-upload: Files loaded and displayed successfully');
                } else {
                    console.error('❌ user-upload: Failed to load files:', result.error);
                    showStatus(`Failed to load files: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('💥 user-upload: Error loading files:', error);
                showStatus(`Error loading files: ${error.message}`, 'error');
            }
        }

        // Sync MB usage
        async function syncMBUsage() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('🔄 user-upload: Sync MB usage triggered for wallet:', walletAddress);
                showStatus('🔄 Syncing MB usage...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/sync-mb-usage/${encodeURIComponent(walletAddress)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('🔄 user-upload: Sync MB response:', result);

                if (result.success) {
                    showStatus(`✅ MB usage synced successfully! Used: ${result.mbUsed} MB (${result.fileCount} files)`, 'success');

                    // Aggiorna immediatamente lo stato della sottoscrizione
                    await checkSubscriptionStatus(walletAddress);

                    // Ricarica anche i file per aggiornare i totali
                    await loadUserFiles();
                } else {
                    showStatus(`❌ Failed to sync MB usage: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('💥 user-upload: Error syncing MB usage:', error);
                showStatus(`❌ Error syncing MB usage: ${error.message}`, 'error');
            }
        }

        // Debug MB usage
        async function debugMBUsage() {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                console.log('🐛 user-upload: Debug MB usage triggered for wallet:', walletAddress);
                showStatus('🐛 Debugging MB usage...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/debug/mb-usage/${encodeURIComponent(walletAddress)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('🐛 user-upload: Debug MB response:', result);

                if (result.success) {
                    showStatus(`✅ MB usage debug completed! Details: ${JSON.stringify(result.details)}`, 'success');
                } else {
                    showStatus(`❌ Failed to debug MB usage: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('💥 user-upload: Error debugging MB usage:', error);
                showStatus(`❌ Error debugging MB usage: ${error.message}`, 'error');
            }
        }

        function displayFiles(files) {
            console.log('🎨 user-upload: Displaying files:', files);

            if (files.length === 0) {
                console.log('📭 user-upload: No files to display');
                filesList.innerHTML = '<p class="text-base-content/60 text-center py-8">No files uploaded yet</p>';
                return;
            }

            console.log(`📁 user-upload: Displaying ${files.length} files`);
            filesList.innerHTML = files.map(file => {
                // Usa originalName se disponibile, altrimenti rimuovi .enc dal nome
                const displayName = file.originalName || (file.name && file.name.endsWith('.enc') ? file.name.replace('.enc', '') : file.name);
                const isEncrypted = file.encrypted || (file.name && file.name.endsWith('.enc'));

                return `
                <div class="file-item">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold">${displayName}</h4>
                                ${isEncrypted ? '<span class="encrypted-badge"><svg xmlns="http://www.w3.org/2000/svg" class="lock-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></svg> Encrypted</span>' : '<span class="plain-badge">📄 Plain</span>'}
                            </div>
                            <p class="text-sm text-base-content/60">
                                ${file.sizeMB} MB • ${new Date(file.uploadedAt).toLocaleString()}
                            </p>
                            <p class="text-xs font-mono text-accent mt-1">${file.hash}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="viewFile('${file.hash}', '${displayName}', ${isEncrypted})" class="btn btn-sm btn-outline">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                ${isEncrypted ? 'Decrypt & View' : 'View'}
                            </button>
                            <button onclick="deleteFile('${file.hash}')" class="btn btn-sm btn-error">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // View/Decrypt file
        async function viewFile(hash, fileName, isEncrypted) {
            try {
                if (isEncrypted) {
                    console.log('🔐 user-upload: Decrypting file:', fileName);
                    showStatus('🔐 Requesting signature for decryption...', 'info');

                    // Genera lo stesso messaggio usato per la crittografia
                    const message = `I Love Shogun`;

                    // Richiedi la firma a MetaMask
                    const signature = await ethereum.request({
                        method: 'personal_sign',
                        params: [message, walletAddress]
                    });

                    // Genera la stessa chiave deterministica
                    const encryptionKey = await generateDeterministicKey(signature, walletAddress);

                    showStatus('🔐 Decrypting file...', 'info');

                    // Scarica il file crittografato
                    const response = await fetch(`/ipfs-content/${hash}`);
                    const encryptedData = await response.text();

                    // Decripta il file
                    const decryptedData = await SEA.decrypt(encryptedData, encryptionKey);

                    if (!decryptedData) {
                        throw new Error('Decryption failed - invalid key or corrupted data');
                    }

                    // Converti da base64 a blob
                    const base64Response = await fetch(decryptedData);
                    const blob = await base64Response.blob();

                    // Crea un URL per il download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus('✅ File decrypted and downloaded successfully!', 'success');
                } else {
                    // File non crittografato - apri direttamente
                    console.log('📄 user-upload: Opening plain file:', fileName);
                    window.open(`/ipfs-content/${hash}`, '_blank');
                }
            } catch (error) {
                console.error('💥 user-upload: Error viewing/decrypting file:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        // Delete file function
        async function deleteFile(hash) {
            if (!walletAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete this file?`)) {
                return;
            }

            try {
                console.log('🗑️ user-upload: Deleting file with hash:', hash);
                showStatus('🗑️ Deleting file...', 'info');

                // Ottieni la firma del wallet per l'autenticazione
                const authSignature = await getWalletSignature();

                const response = await fetch(`/api/v1/user-uploads/${encodeURIComponent(walletAddress)}/${hash}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-address': walletAddress,
                        'x-wallet-signature': authSignature,
                        'x-signature-message': 'I Love Shogun'
                    }
                });

                const result = await response.json();
                console.log('🗑️ user-upload: Delete file response:', result);

                if (result.success) {
                    showStatus('✅ File deleted successfully!', 'success');
                    
                    // Ricarica i file per aggiornare la lista
                    await loadUserFiles();
                } else {
                    showStatus(`❌ Failed to delete file: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('💥 user-upload: Error deleting file:', error);
                showStatus(`❌ Error deleting file: ${error.message}`, 'error');
            }
        }

        // Wallet connection
        async function connectWallet() {
            console.log('🔗 user-upload: connectWallet called');

            if (typeof window.ethereum !== 'undefined') {
                try {
                    console.log('🔗 user-upload: Requesting accounts from MetaMask');
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    walletAddress = accounts[0];
                    console.log('🔗 user-upload: Wallet connected:', walletAddress);

                    walletAddressEl.textContent = walletAddress;
                    currentWalletAddressEl.textContent = walletAddress;
                    walletStatus.textContent = `Connected: ${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;
                    walletInfo.classList.remove('hidden');

                    // Mostra le sezioni di upload e file
                    uploadSection.classList.remove('hidden');
                    filesSection.classList.remove('hidden');

                    showStatus('Wallet connected!', 'success');

                    // Controlla lo stato della sottoscrizione
                    console.log('🔗 user-upload: Calling checkSubscriptionStatus with walletAddress:', walletAddress);
                    checkSubscriptionStatus(walletAddress);
                    loadUserFiles();
                } catch (error) {
                    console.error('💥 user-upload: Error connecting wallet:', error);
                    showStatus('Failed to connect wallet. Please ensure MetaMask is unlocked.', 'error');
                }
            } else {
                console.log('❌ user-upload: MetaMask not found');
                showStatus('MetaMask is not installed. Please install MetaMask to use this feature.', 'warning');
            }
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const colors = {
                success: 'text-success',
                error: 'text-error',
                info: 'text-info',
                warning: 'text-warning'
            };

            statusMessage.innerHTML = `
                <div class="alert ${colors[type]} bg-${type}/10 border border-${type}/20">
                    <span>${message}</span>
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('Connect your wallet to start uploading files', 'info');
        });
    </script>
</body>

</html>