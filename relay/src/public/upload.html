<!DOCTYPE html>
<html lang="en" data-theme="shogun-dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPFS File Uploader</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/shogun-theme@1.0.0/styles/variables.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/shogun-theme@1.0.0/styles/base.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/shogun-theme@1.0.0/styles/daisyui-overrides.css" rel="stylesheet" type="text/css" />
  <link href="styles/wormhole.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Include centralized admin authentication -->
  <script src="lib/admin-auth.js"></script>
  <script src="lib/admin-nav.js"></script>
  <style>
    body {
      line-height: 1.6;
      background: linear-gradient(135deg, #1A1A1A 0%, #0D0D0D 100%);
      min-height: 100vh;
    }

    .hero-gradient {
      background: radial-gradient(ellipse at top, rgba(255, 105, 180, 0.1) 0%, transparent 60%);
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.4); }
      50% { box-shadow: 0 0 20px 5px rgba(255, 105, 180, 0.2); }
    }

    .pulse-glow {
      animation: pulse-glow 2s infinite;
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .section-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #404040, transparent);
      margin: 2rem 0;
    }

    .drag-drop-area {
      border: 2px dashed #606060;
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: rgba(64, 64, 64, 0.3);
    }

    .drag-drop-area.drag-over {
      border-color: #FF69B4;
      background-color: rgba(255, 105, 180, 0.1);
    }

    .drag-drop-area svg {
      width: 6rem;
      height: 6rem;
      margin: 0 auto 0.5rem;
      color: #FF69B4;
    }

    .upload-progress {
      background-color: #404040;
      border-radius: 1rem;
      overflow: hidden;
      margin-top: 1.5rem;
      display: none;
    }

    .progress-bar {
      height: 1.5rem;
      background-color: #4CAF50;
      color: #FFFFFF;
      text-align: center;
      font-size: 0.875rem;
      line-height: 1.5rem;
      transition: all 0.3s ease;
    }

    .message {
      padding: 1.5rem;
      border-radius: 1rem;
      margin-top: 1.5rem;
      display: none;
    }

    .message.success {
      background-color: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }

    .message.error {
      background-color: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #F44336;
    }

    .message a {
      color: #42A5F5;
      text-decoration: underline;
    }

    .message a:hover {
      color: #64B5F6;
    }
  </style>
</head>

<body class="antialiased">
  <div class="hero-gradient min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Back Navigation -->
      <div class="flex items-center mb-8">
        <a href="/" class="flex items-center gap-2 text-[#A0A0A0] hover:text-[#FF69B4] transition-colors group">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Back to Control Panel</span>
        </a>
      </div>

      <div class="card bg-[#282828] border border-[#404040] rounded-2xl card-hover">
        <div class="p-8 sm:p-10">
          <div class="flex flex-col items-center">
            <!-- Header Icon -->
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-[#42A5F5] to-[#1976D2] mb-6 pulse-glow">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
            </div>

            <h1 class="text-3xl md:text-4xl font-bold mb-4 text-[#FFFFFF]">IPFS File Uploader</h1>
            <p class="text-[#8B94FF] mb-8">Direct file upload with optional encryption</p>

          <div class="w-full space-y-8">
            <div class="form-group">
              <label class="block text-lg font-medium mb-3 text-[#FFFFFF]">File Upload:</label>
              <p class="text-[#A0A0A0] text-base mb-6">
                Select a file to upload to your IPFS node via the relay.
              </p>

              <div class="drag-drop-area" id="dropArea">
                <svg class="flex flex-col items-center w-32 h-32 mx-auto" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                    clip-rule="evenodd" />
                </svg>

                <p class="text-[#E0E0E0] text-lg">Drag & drop files here or click to select</p>
                <input type="file" id="fileInput" class="hidden" />
              </div>

              <div class="form-control mb-6">
                <label class="label cursor-pointer justify-start gap-3">
                  <input type="checkbox" id="encryptCheck" class="checkbox checkbox-primary" />
                  <span class="label-text text-[#E0E0E0] text-base">Encrypt file with admin token before upload?</span>
                </label>
              </div>

              <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar" id="progressBar">0%</div>
              </div>

              <button class="btn bg-[#FF69B4] hover:bg-[#FF1493] border-0 text-[#FFFFFF] mt-6 rounded-xl px-8 py-4 font-medium" id="uploadBtn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                    clip-rule="evenodd" />
                </svg>
                Upload File
              </button>
              <div class="form-group mt-6">
                <label class="block text-lg font-medium mb-3 text-[#FFFFFF]" for="fileNameInput">
                  File Name Override (optional):
                </label>
                <input
                  type="text"
                  id="fileNameInput"
                  class="input input-bordered w-full bg-[#1A1A1A] border-[#404040] text-[#E0E0E0]"
                  placeholder="Leave empty to use the original file name"
                  autocomplete="off"
                />
              </div>
            </div>

            <div id="message" class="message"></div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-12 text-center">
        <div class="section-divider"></div>
        <p class="text-[#606060] text-sm">
          Shogun Relay Upload - Part of the <a href="https://github.com/scobru/shogun" class="text-[#FF69B4] hover:text-[#FF1493] transition-colors">Shogun Project</a>
        </p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const messageEl = document.getElementById("message");
    const encryptCheck = document.getElementById("encryptCheck");
    const dropArea = document.getElementById("dropArea");
    const uploadProgress = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const fileNameInput = document.getElementById("fileNameInput");

    // Drag and drop functionality
    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropArea.classList.add("drag-over");
    }

    function unhighlight(e) {
      dropArea.classList.remove("drag-over");
    }

    dropArea.addEventListener("drop", handleDrop, false);
    dropArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => updateFileNameInput(fileInput.files[0]));

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      updateFileNameInput(files[0]);
    }

    function updateFileNameInput(file) {
      if (file && !fileNameInput.value.trim()) {
        fileNameInput.value = file.name;
      }
    }

    const showMessage = (text, type = "error") => {
      messageEl.innerHTML = text;
      messageEl.className = `message ${type}`;
      messageEl.style.display = "block";

      if (type === "success") {
        messageEl.scrollIntoView({ behavior: "smooth" });
      }
    };

    // Initialize admin authentication
    document.addEventListener('DOMContentLoaded', () => {
      ShogunAdmin.init({
          autoFill: true,
          showIndicator: true,
          adminFieldId: 'adminPassword',
          syncEnabled: true
      });
    });

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      // Use centralized admin password
      const token = ShogunAdmin.getPassword();

      console.log(`üíæ Token:`, token);

      if (!token) {
        showMessage("Admin Token is required. Please set it in the Control Panel.");
        return;
      }

      if (!file) {
        showMessage("Please select a file to upload.");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.classList.add("loading");
      messageEl.style.display = "none";
      uploadProgress.style.display = "block";
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";

      let fileToUpload = file;
      const userProvidedName = fileNameInput.value.trim();
      const baseFileName = userProvidedName || file.name;
      let uploadFileName = baseFileName;

      if (encryptCheck.checked) {
        try {
          progressBar.style.width = "25%";
          progressBar.textContent = "Encrypting...";

          const base64data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (err) => reject(err);
            reader.readAsDataURL(file);
          });


          const encryptedData = await SEA.encrypt(base64data, token);
          // Convert encrypted object to JSON string (SEA.encrypt returns an object)
          // This is critical: if we don't stringify, File constructor will convert it to "[object Object]"
          const encryptedDataJson = JSON.stringify(encryptedData);
          const encryptionFileName = baseFileName.endsWith(".enc")
            ? baseFileName
            : `${baseFileName}.enc`;
          fileToUpload = new File([encryptedDataJson], encryptionFileName, {
            type: "text/plain",
          });
          uploadFileName = encryptionFileName;

          progressBar.style.width = "50%";
          progressBar.textContent = "Encrypted! Uploading...";
        } catch (err) {
          showMessage(`Encryption failed: ${err.message}`);
          uploadBtn.disabled = false;
          uploadBtn.classList.remove("loading");
          uploadProgress.style.display = "none";
          return;
        }
      }

      const formData = new FormData();
      uploadFileName = fileToUpload.name || uploadFileName || baseFileName;
      formData.append("file", fileToUpload, uploadFileName);

      try {
        const response = await fetch("/api/v1/ipfs/upload", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        }

        const result = await response.json();

        if (result.success && result.file) {
          progressBar.style.width = "100%";
          progressBar.textContent = "Upload Complete!";

          const { hash } = result.file;
          const isEncrypted = encryptCheck.checked;
          
          // Build relay URL (always go through relay viewer)
          const baseUrl = window.location.origin;
          const finalIpfsUrl = isEncrypted
            ? `${baseUrl}/api/v1/ipfs/cat/${hash}/decrypt?token=${encodeURIComponent(token)}`
            : `${baseUrl}/api/v1/ipfs/cat/${hash}`;
          
          console.log(`üîó Relay URL: ${finalIpfsUrl}`);
          console.log(`üîí Is encrypted: ${isEncrypted}`);

          // Add file to system hashes (admin upload)
          try {
            console.log('üíæ Adding file to system hashes...');
            
            // Prepare metadata for system hash
            const systemHashData = {
              hash: hash,
              userAddress: 'admin-upload',
              timestamp: Date.now(),
              fileName: uploadFileName,
              displayName: uploadFileName, // Add displayName for pin manager
              originalName: file.name,
              fileSize: fileToUpload.size ?? file.size,
              isEncrypted: isEncrypted,
              contentType: fileToUpload.type || file.type || 'application/octet-stream',
              relayUrl: finalIpfsUrl,
              gatewayUrl: `${baseUrl}/ipfs/${hash}`,
              uploadedAt: Date.now()
            };
            
            console.log('üíæ System hash data:', systemHashData);
            
            const systemHashResponse = await fetch('/api/v1/user-uploads/save-system-hash', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(systemHashData)
            });

            if (systemHashResponse.ok) {
              await systemHashResponse.json();
              console.log('‚úÖ File added to system hashes');
            } else {
              console.warn('‚ö†Ô∏è Failed to add file to system hashes:', systemHashResponse.status);
              const errorText = await systemHashResponse.text();
              console.warn('‚ö†Ô∏è Error details:', errorText);
            }
          } catch (error) {
            console.error('‚ùå Error adding file to system hashes:', error);
            // Don't block the upload if system hash save fails
          }

          const successMessage = `
            <div class="flex flex-col gap-2">
              <div class="font-semibold text-success">‚úÖ File uploaded successfully!</div>
              <div class="font-mono text-sm">Hash: ${hash}</div>
              <div class="flex flex-col gap-1">
                <a href="${finalIpfsUrl}" target="_blank" class="link">üîó Relay URL ${isEncrypted ? "(decrypted)" : ""}</a>
              </div>
            </div>
          `;
          showMessage(successMessage, "success");
        } else {
          throw new Error(
            result.error || "Upload failed for an unknown reason."
          );
        }
      } catch (err) {
        showMessage(`Upload failed: ${err.message}`);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.classList.remove("loading");
      }
    });
  </script>
</body>

</html>