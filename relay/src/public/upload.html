<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPFS File Uploader - Shogun Relay</title>
  <link rel="stylesheet" href="styles/google-md3.css">
  <script src="lib/admin-auth.js"></script>
  <script src="lib/admin-nav.js"></script>
  <style>
    .page-header {
      background-color: var(--md-surface-container-low);
      border-bottom: 1px solid var(--md-outline-variant);
      padding: 24px;
      margin-bottom: 32px;
    }

    .page-header-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .page-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      background: linear-gradient(135deg, #42A5F5, #1976D2);
      box-shadow: 0 8px 24px rgba(66, 165, 245, 0.3);
    }

    .page-icon svg {
      width: 28px;
      height: 28px;
      color: white;
    }

    .upload-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .upload-card {
      background-color: var(--md-surface-container);
      border: 1px solid var(--md-outline-variant);
      border-radius: 16px;
      padding: 32px;
    }

    .drag-drop-area {
      border: 2px dashed var(--md-outline);
      border-radius: 16px;
      padding: 48px 24px;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: var(--md-surface-container-low);
    }

    .drag-drop-area:hover {
      border-color: var(--md-primary);
      background-color: var(--md-surface-container);
    }

    .drag-drop-area.drag-over {
      border-color: var(--md-primary);
      background-color: rgba(255, 105, 180, 0.1);
    }

    .drag-drop-area svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      color: var(--md-primary);
    }

    .drag-drop-text {
      font-size: 1rem;
      color: var(--md-on-surface-variant);
    }

    .upload-progress {
      background-color: var(--md-surface-container-high);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 24px;
      display: none;
    }

    .progress-bar {
      height: 24px;
      background-color: var(--md-success);
      color: white;
      text-align: center;
      font-size: 0.875rem;
      line-height: 24px;
      transition: width 0.3s ease;
    }

    .message {
      padding: 16px;
      border-radius: 12px;
      margin-top: 24px;
      display: none;
    }

    .message.success {
      background-color: var(--md-success-container);
      border: 1px solid var(--md-success);
      color: var(--md-success);
    }

    .message.error {
      background-color: var(--md-error-container);
      border: 1px solid var(--md-error);
      color: var(--md-error);
    }

    .message a {
      color: var(--md-tertiary);
      text-decoration: underline;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding: 12px 16px;
      background-color: var(--md-surface-container-low);
      border-radius: 8px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--md-primary);
    }

    .checkbox-label {
      color: var(--md-on-surface);
      font-size: 0.875rem;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="page-header">
    <div class="page-header-content">
      <a href="/admin" class="md-btn md-btn-icon" title="Back to Admin">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24"
          height="24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <div class="page-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
      </div>
      <div>
        <h1 class="md-headline-medium">IPFS File Uploader</h1>
        <p class="md-body-medium md-text-secondary">Direct file or directory upload with optional encryption</p>
      </div>
    </div>
  </header>

  <main class="md-container upload-container">
    <div class="upload-card">
      <!-- Drag & Drop Area -->
      <div class="drag-drop-area" id="dropArea">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd"
            d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
            clip-rule="evenodd" />
        </svg>
        <p class="drag-drop-text">Drag & drop files here or click to select</p>
        <input type="file" id="fileInput" style="display: none;" multiple>
        <input type="file" id="directoryInput" style="display: none;" webkitdirectory>
      </div>

      <!-- Upload Mode Selection -->
      <div class="checkbox-row" style="margin-bottom: 16px;">
        <input type="radio" id="uploadModeSingle" name="uploadMode" value="single" checked>
        <label class="checkbox-label" for="uploadModeSingle">Single File</label>
        <input type="radio" id="uploadModeDirectory" name="uploadMode" value="directory" style="margin-left: 24px;">
        <label class="checkbox-label" for="uploadModeDirectory">Directory (Multiple Files)</label>
      </div>

      <!-- File Name Override -->
      <div class="md-field">
        <label class="md-label" for="fileNameInput">File Name Override (optional)</label>
        <input type="text" id="fileNameInput" class="md-input" placeholder="Leave empty to use the original file name">
      </div>

      <!-- Encrypt Checkbox -->
      <div class="checkbox-row">
        <input type="checkbox" id="encryptCheck">
        <label class="checkbox-label" for="encryptCheck">Encrypt file with admin token before upload</label>
      </div>

      <!-- Upload Button -->
      <button class="md-btn md-btn-filled" style="width: 100%;" id="uploadBtn">
        <svg xmlns="http://www.w3.org/2000/svg" class="md-icon-sm" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
            clip-rule="evenodd" />
        </svg>
        Upload File
      </button>

      <!-- Progress Bar -->
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>

      <!-- Message -->
      <div id="message" class="message"></div>
    </div>

    <!-- Footer -->
    <footer class="md-footer">
      <p class="md-body-small">
        Shogun Relay Upload â€” Part of the <a href="https://github.com/scobru/shogun">Shogun Project</a>
      </p>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const directoryInput = document.getElementById("directoryInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const messageEl = document.getElementById("message");
    const encryptCheck = document.getElementById("encryptCheck");
    const dropArea = document.getElementById("dropArea");
    const uploadProgress = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const fileNameInput = document.getElementById("fileNameInput");

    // Drag and drop functionality
    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropArea.classList.add("drag-over");
    }

    function unhighlight(e) {
      dropArea.classList.remove("drag-over");
    }

    dropArea.addEventListener("drop", handleDrop, false);
    dropArea.addEventListener("click", () => {
      const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
      if (uploadMode === 'directory') {
        directoryInput.click();
      } else {
        fileInput.click();
      }
    });
    
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        updateFileNameInput(fileInput.files[0]);
      }
    });
    
    directoryInput.addEventListener("change", () => {
      if (directoryInput.files.length > 0) {
        updateFileNameInput(directoryInput.files[0]);
      }
    });

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
      
      if (uploadMode === 'directory') {
        // Check if dropped items are from a directory
        const items = Array.from(dt.items);
        const hasDirectory = items.some(item => item.webkitGetAsEntry && item.webkitGetAsEntry().isDirectory);
        
        if (hasDirectory || files.length > 1) {
          // Create a DataTransfer object to set files
          const dataTransfer = new DataTransfer();
          Array.from(files).forEach(file => dataTransfer.items.add(file));
          directoryInput.files = dataTransfer.files;
          updateFileNameInput(files[0]);
        } else {
          fileInput.files = files;
          updateFileNameInput(files[0]);
        }
      } else {
        fileInput.files = files;
        updateFileNameInput(files[0]);
      }
    }

    function updateFileNameInput(file) {
      if (file && !fileNameInput.value.trim()) {
        fileNameInput.value = file.name;
      }
    }

    const showMessage = (text, type = "error") => {
      messageEl.innerHTML = text;
      messageEl.className = `message ${type}`;
      messageEl.style.display = "block";

      if (type === "success") {
        messageEl.scrollIntoView({ behavior: "smooth" });
      }
    };

    // Initialize admin authentication
    document.addEventListener('DOMContentLoaded', () => {
      ShogunAdmin.init({
        autoFill: true,
        showIndicator: true,
        adminFieldId: 'adminPassword',
        syncEnabled: true
      });
    });

    uploadBtn.addEventListener("click", async () => {
      const token = ShogunAdmin.getPassword();
      const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
      
      let filesToUpload = [];
      let isDirectory = false;

      if (!token) {
        showMessage("Admin Token is required. Please set it in the Admin Panel.");
        return;
      }

      if (uploadMode === 'directory') {
        filesToUpload = Array.from(directoryInput.files);
        isDirectory = filesToUpload.length > 0 && filesToUpload.some(f => f.webkitRelativePath);
      } else {
        const file = fileInput.files[0];
        if (!file) {
          showMessage("Please select a file to upload.");
          return;
        }
        filesToUpload = [file];
      }

      if (filesToUpload.length === 0) {
        showMessage("Please select file(s) to upload.");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";
      messageEl.style.display = "none";
      uploadProgress.style.display = "block";
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";

      const userProvidedName = fileNameInput.value.trim();
      const mainFile = filesToUpload[0];
      const baseFileName = userProvidedName || mainFile.name;
      
      // For directory uploads, encryption is not supported yet
      if (isDirectory && encryptCheck.checked) {
        showMessage("Encryption is not yet supported for directory uploads.");
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload File";
        uploadProgress.style.display = "none";
        return;
      }

      let processedFiles = filesToUpload;
      
      if (encryptCheck.checked && !isDirectory) {
        try {
          progressBar.style.width = "25%";
          progressBar.textContent = "Encrypting...";

          const base64data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (err) => reject(err);
            reader.readAsDataURL(mainFile);
          });

          const encryptedData = await SEA.encrypt(base64data, token);
          const encryptedDataJson = JSON.stringify(encryptedData);
          const encryptionFileName = baseFileName.endsWith(".enc")
            ? baseFileName
            : `${baseFileName}.enc`;
          processedFiles = [new File([encryptedDataJson], encryptionFileName, {
            type: "text/plain",
          })];

          progressBar.style.width = "50%";
          progressBar.textContent = "Encrypted! Uploading...";
        } catch (err) {
          showMessage(`Encryption failed: ${err.message}`);
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Upload File";
          uploadProgress.style.display = "none";
          return;
        }
      }

      const formData = new FormData();
      const uploadEndpoint = isDirectory ? "/api/v1/ipfs/upload-directory" : "/api/v1/ipfs/upload";
      
      if (isDirectory) {
        // Upload as directory
        processedFiles.forEach((file) => {
          const path = file.webkitRelativePath || file.name;
          formData.append("files", file, path);
        });
        progressBar.style.width = "60%";
        progressBar.textContent = `Uploading ${processedFiles.length} files...`;
      } else {
        // Single file upload
        const uploadFileName = processedFiles[0].name || baseFileName;
        formData.append("file", processedFiles[0], uploadFileName);
      }

      try {
        progressBar.style.width = isDirectory ? "60%" : "60%";
        const response = await fetch(uploadEndpoint, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
          progressBar.style.width = "100%";
          progressBar.textContent = "Upload Complete!";

          // Handle both single file and directory responses
          const hash = result.directoryCid || result.cid || (result.file && result.file.hash);
          const isEncrypted = encryptCheck.checked && !isDirectory;
          const fileCount = result.fileCount || 1;

          const baseUrl = window.location.origin;
          const finalIpfsUrl = isEncrypted
            ? `${baseUrl}/api/v1/ipfs/cat/${hash}/decrypt?token=${encodeURIComponent(token)}`
            : `${baseUrl}/api/v1/ipfs/cat/${hash}`;

          // Add to system hashes
          try {
            const systemHashData = {
              hash: hash,
              userAddress: 'admin-upload',
              timestamp: Date.now(),
              fileName: isDirectory ? `Directory (${fileCount} files)` : baseFileName,
              displayName: isDirectory ? `Directory (${fileCount} files)` : baseFileName,
              originalName: isDirectory ? `Directory (${fileCount} files)` : mainFile.name,
              fileSize: result.totalSize || processedFiles[0].size,
              isEncrypted: isEncrypted,
              contentType: isDirectory ? 'application/directory' : (processedFiles[0].type || 'application/octet-stream'),
              relayUrl: finalIpfsUrl,
              gatewayUrl: `${baseUrl}/ipfs/${hash}`,
              uploadedAt: Date.now(),
              isDirectory: isDirectory,
              fileCount: fileCount
            };

            await fetch('/api/v1/user-uploads/save-system-hash', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(systemHashData)
            });
          } catch (error) {
            console.error('Error adding to system hashes:', error);
          }

          const successMessage = isDirectory
            ? `
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="font-weight: 600;">âœ… Directory uploaded successfully!</div>
                <div style="font-family: monospace; font-size: 0.875rem;">Directory CID: ${hash}</div>
                <div style="font-size: 0.875rem;">Files: ${fileCount} | Size: ${(result.totalSizeMB || 0).toFixed(2)} MB</div>
                <a href="${finalIpfsUrl}" target="_blank">ðŸ”— View Directory</a>
              </div>
            `
            : `
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="font-weight: 600;">âœ… File uploaded successfully!</div>
                <div style="font-family: monospace; font-size: 0.875rem;">Hash: ${hash}</div>
                <a href="${finalIpfsUrl}" target="_blank">ðŸ”— View File ${isEncrypted ? "(decrypted)" : ""}</a>
              </div>
            `;
          showMessage(successMessage, "success");
        } else {
          throw new Error(result.error || "Upload failed for an unknown reason.");
        }
      } catch (err) {
        showMessage(`Upload failed: ${err.message}`);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload File";
      }
    });
  </script>
</body>

</html>