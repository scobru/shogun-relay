<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/wormhole.css">
    <!-- Include centralized admin authentication -->
    <script src="lib/admin-auth.js"></script>
    <link rel="stylesheet" href="styles/responsive.css">
    <style>
        /* File card specific styles */
        .file-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .file-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 640px) {
            .file-card-content {
                flex-direction: column;
            }
            
            .file-info {
                margin-bottom: 0.75rem;
                width: 100%;
            }
            
            .file-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .file-name {
                word-break: break-all;
                font-size: 0.95rem;
            }
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .action-btn-download {
            background-color: rgba(72, 187, 120, 0.2);
            color: rgb(72, 187, 120);
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        .action-btn-download:hover {
            background-color: rgba(72, 187, 120, 0.3);
        }
        
        .action-btn-info {
            background-color: rgba(66, 153, 225, 0.2);
            color: rgb(66, 153, 225);
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .action-btn-info:hover {
            background-color: rgba(66, 153, 225, 0.3);
        }
        
        .action-btn-delete {
            background-color: rgba(245, 101, 101, 0.2);
            color: rgb(245, 101, 101);
            border: 1px solid rgba(245, 101, 101, 0.3);
        }
        
        .action-btn-delete:hover {
            background-color: rgba(245, 101, 101, 0.3);
        }
        
        /* Improved alert messages */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .alert-success {
            background-color: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .alert-error {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-2 sm:p-4">
        <div class="flex items-center mb-4">
            <a href="/" class="nav-link">&larr; Back to Control Panel</a>
        </div>

        <div class="card bg-base-200 shadow-xl">
            <div class="p-4 sm:p-6 md:p-8">
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 sm:h-12 sm:w-12 mb-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>

                    <h1 class="text-xl sm:text-2xl font-semibold mb-6 sm:mb-8 text-center">S3 File Manager</h1>

                    <div class="w-full space-y-4 sm:space-y-6">
                        <!-- Upload Section -->
                        <div id="uploadSection" class="form-group hidden">
                            <label class="block text-sm font-medium mb-2">Upload Files:</label>
                            
                            <div class="border-2 border-dashed border-base-content/20 rounded-xl p-4 sm:p-8 text-center transition-all duration-300 cursor-pointer hover:border-accent hover:bg-accent/5" id="dropArea">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 sm:h-12 sm:w-12 mx-auto mb-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="text-base-content">üìÅ Drag & drop files here or click to select</p>
                                <input type="file" id="fileInput" multiple class="hidden">
                            </div>
                            
                            <div class="hidden mt-4" id="uploadProgress">
                                <div class="flex justify-between text-sm mb-2">
                                    <span>Upload Progress</span>
                                    <span id="progressText">0%</span>
                                </div>
                                <progress class="progress progress-success w-full" id="progressBar" value="0" max="100"></progress>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-2 mt-4">
                                <button class="btn btn-accent" onclick="triggerFileSelect()">Select Files</button>
                                <button class="btn btn-primary" onclick="uploadFiles()" id="uploadBtn" disabled>Upload Selected Files</button>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="message" class="alert hidden"></div>

                        <!-- File List Section -->
                        <div id="fileListSection" class="form-group hidden">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                                <label class="text-lg font-semibold">Files in Bucket</label>
                                <button class="btn btn-outline btn-sm" onclick="refreshFileList()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                            
                            <div id="fileList" class="space-y-2">
                                <div class="flex justify-center items-center p-8">
                                    <span class="loading loading-spinner loading-md"></span>
                                    <span class="ml-2">Loading files...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize admin authentication
        document.addEventListener('DOMContentLoaded', () => {
            ShogunAdmin.init({
                autoFill: true,
                showIndicator: true,
                fieldId: 'authToken',
                syncEnabled: true
            });
            
            // Auto-connect if password is available
            if (ShogunAdmin.hasPassword()) {
                setTimeout(connectToS3, 500);
            }
            
            // Initialize viewport height fix
            adjustViewportHeight();
        });
        
        // Handle viewport resizing for mobile
        function adjustViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        window.addEventListener('resize', adjustViewportHeight);
        window.addEventListener('orientationchange', adjustViewportHeight);

        // Listen for password updates
        window.addEventListener('shogun-admin-password-updated', (event) => {
            if (event.detail.hasPassword) {
                console.log('Admin password updated, attempting auto-connect...');
                connectToS3();
            }
        });

        let authToken = '';
        let selectedFiles = [];
        let isConnected = false;

        // Authentication - Auto-connect on page load
        function connectToS3() {
            // Use centralized admin password
            authToken = ShogunAdmin.getPassword();
            if (!authToken) {
                showMessage('Admin token required. Please set it in the Control Panel for automatic loading.', 'error');
                return;
            }

            // Test connection by trying to get file list
            testS3Connection();
        }

        async function testS3Connection() {
            try {
                const response = await fetch('/api/s3-stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        isConnected = true;
                        document.getElementById('uploadSection').classList.remove('hidden');
                        document.getElementById('fileListSection').classList.remove('hidden');
                        showMessage(`Connected! Found ${data.stats.totalBuckets} buckets with ${data.stats.totalObjects} files`, 'success');
                        refreshFileList();
                    } else {
                        throw new Error(data.error || 'Connection failed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('S3 connection error:', error);
                showMessage(`Connection failed: ${error.message}`, 'error');
            }
        }

        // File selection and drag & drop
        function triggerFileSelect() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateUploadButton();
            showMessage(`Selected ${selectedFiles.length} file(s)`, 'success');
        });

        // Drag and drop functionality
        const dropArea = document.getElementById('dropArea');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropArea.classList.add('border-accent', 'bg-accent/10');
        }

        function unhighlight(e) {
            dropArea.classList.remove('border-accent', 'bg-accent/10');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', triggerFileSelect);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            selectedFiles = Array.from(files);
            updateUploadButton();
            showMessage(`Dropped ${selectedFiles.length} file(s)`, 'success');
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = selectedFiles.length === 0;
            uploadBtn.textContent = selectedFiles.length > 0 ? 
                `Upload ${selectedFiles.length} file(s)` : 'Upload Selected Files';
        }

        // File upload
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                showMessage('No files selected', 'error');
                return;
            }

            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressContainer.classList.remove('hidden');

            let uploadedCount = 0;
            const totalFiles = selectedFiles.length;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                try {
                    await uploadSingleFile(file);
                    uploadedCount++;
                    
                    const progress = Math.round((uploadedCount / totalFiles) * 100);
                    progressBar.value = progress;
                    progressText.textContent = `${progress}% (${uploadedCount}/${totalFiles})`;
                    
                } catch (error) {
                    console.error(`Failed to upload ${file.name}:`, error);
                    showMessage(`Failed to upload ${file.name}: ${error.message}`, 'error');
                }
            }

            if (uploadedCount === totalFiles) {
                showMessage(`Successfully uploaded ${uploadedCount} file(s)!`, 'success');
                refreshFileList();
            } else {
                showMessage(`Uploaded ${uploadedCount} of ${totalFiles} files`, 'error');
            }

            // Reset
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            updateUploadButton();
            progressContainer.classList.add('hidden');
        }

        async function uploadSingleFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/s3-upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            return await response.json();
        }

        // File list management
        async function refreshFileList() {
            if (!isConnected) return;

            const fileListEl = document.getElementById('fileList');
            fileListEl.innerHTML = `
                <div class="flex justify-center items-center p-8">
                    <span class="loading loading-spinner loading-md"></span>
                    <span class="ml-2">Loading files...</span>
                </div>
            `;

            try {
                // Get S3 stats to find buckets
                const statsResponse = await fetch('/api/s3-stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!statsResponse.ok) {
                    throw new Error('Failed to fetch S3 stats');
                }

                const statsData = await statsResponse.json();
                if (!statsData.success || !statsData.stats.buckets.length) {
                    fileListEl.innerHTML = '<div class="text-center p-8 text-base-content/70">No buckets found</div>';
                    return;
                }

                // Get files from the first bucket (assuming shogun-files)
                const bucket = statsData.stats.buckets[0];
                const filesResponse = await fetch(`/api/s3-buckets/${bucket.name}/objects`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!filesResponse.ok) {
                    throw new Error('Failed to fetch file list');
                }

                const filesData = await filesResponse.json();
                displayFileList(filesData.objects || [], bucket.name);

            } catch (error) {
                console.error('Error refreshing file list:', error);
                fileListEl.innerHTML = `<div class="text-center p-8 text-error">Error: ${error.message}</div>`;
            }
        }

        function displayFileList(files, bucketName) {
            const fileListEl = document.getElementById('fileList');

            if (files.length === 0) {
                fileListEl.innerHTML = '<div class="text-center p-8 text-base-content/70">No files found</div>';
                return;
            }

            fileListEl.innerHTML = files.map(file => `
                <div class="file-card">
                    <div class="flex file-card-content">
                        <div class="file-info flex-1">
                            <h3 class="font-semibold text-accent file-name">${file.Key}</h3>
                            <p class="text-xs sm:text-sm text-base-content/70">
                                üìè ${formatFileSize(file.Size)} ‚Ä¢ 
                                üìÖ ${new Date(file.LastModified).toLocaleString()}
                            </p>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn action-btn-download" onclick="downloadFile('${bucketName}', '${file.Key}')">
                                üì• Download
                            </button>
                            <button class="action-btn action-btn-info" onclick="getFileInfo('${bucketName}', '${file.Key}')">
                                ‚ÑπÔ∏è Info
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteFile('${bucketName}', '${file.Key}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // File operations
        function downloadFile(bucket, key) {
            const url = `/s3-file/${bucket}/${key}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = key.split('/').pop(); // Extract filename
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Downloading ${key}...`, 'success');
        }

        async function getFileInfo(bucket, key) {
            try {
                const response = await fetch(`/s3-info/${bucket}/${key}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    const info = data.file;
                    alert(`File Info:\n\n` +
                        `Name: ${info.key}\n` +
                        `Size: ${formatFileSize(info.size)}\n` +
                        `Type: ${info.contentType}\n` +
                        `Modified: ${new Date(info.lastModified).toLocaleString()}\n` +
                        `ETag: ${info.etag}\n` +
                        `URL: ${info.url}`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage(`Failed to get file info: ${error.message}`, 'error');
            }
        }

        async function deleteFile(bucket, key) {
            if (!confirm(`Are you sure you want to delete "${key}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/s3-file/${bucket}/${key}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    showMessage(`Deleted "${key}" successfully`, 'success');
                    refreshFileList();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage(`Failed to delete file: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `alert ${type === 'success' ? 'alert-success' : 'alert-error'}`;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html> 