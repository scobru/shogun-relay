<!doctype html>
<html lang="en" data-theme="night">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Minimal Messenger</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/wormhole.css">
    <script src="lib/admin-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter3@4.0.0/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bugout@0.0.13/docs/bugout.min.js"></script>
    <script src="./lib/bugoff.js"></script>

    <style>
      body { 
        background-color: #333; 
        color: #eee;
        padding: 1em;
      }

      .nav-link {
        display: inline-flex;
        align-items: center;
        color: #8af;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        transition: background-color 0.2s ease;
      }

      .nav-link:hover {
        background-color: rgba(136, 170, 255, 0.1);
      }

      .input-custom {
        background-color: #2a2a2a;
        color: #eee;
        border: 1px solid #555;
        padding: 0.75rem;
        border-radius: 0.25rem;
        font-family: inherit;
        transition: border-color 0.2s ease;
      }

      .input-custom:focus {
        outline: none;
        border-color: #8af;
      }

      .input-custom:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-custom {
        background-color: #444;
        color: #eee;
        border: 1px solid #555;
        padding: 0.75rem 1.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      .btn-custom:hover:not(:disabled) {
        background-color: #555;
        border-color: #8af;
      }

      .btn-custom:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      pre { 
        background-color: #2a2a2a;
        white-space: pre-wrap; 
        word-wrap: break-word; 
        line-height: 1.4;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #444;
      }

      #messages {
        height: 500px;
        overflow-y: auto;
        margin: 1rem 0;
        font-size: 0.95rem;
      }

      #log {
        height: 120px;
        overflow-y: auto;
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .card {
        background-color: #2a2a2a;
        border: 1px solid #444;
        border-radius: 0.5rem;
        transition: transform 0.2s ease;
      }

      .card:hover {
        transform: translateY(-2px);
      }

      @media (max-width: 640px) {
        .input-group {
          flex-direction: column;
          gap: 0.5rem;
        }

        .input-group > * {
          width: 100%;
        }

        #messages {
          height: 400px;
        }

        #log {
          height: 100px;
        }
      }
    </style>
  </head>
  <body class="antialiased">
    <div class="container mx-auto p-4">
      <div class="flex items-center mb-4">
        <a href="/" class="nav-link">&larr; Back to Control Panel</a>
      </div>

      <div class="card">
        <div class="p-8">
          <div class="flex flex-col items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>

            <h1 class="text-2xl font-semibold mb-8">Minimal Messenger</h1>

            <div class="w-full space-y-6">
              <div class="form-group">
                <label class="block text-sm font-medium mb-2">Server Address:</label>
                <div class="flex gap-2">
                  <input type="text" id="serverAddress" class="input input-bordered flex-1" placeholder="Enter server address">
                  <button id="connectBtn" class="btn btn-primary">Connect</button>
                </div>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium mb-2">Messages:</label>
                <div class="mockup-code bg-base-300 h-96 overflow-y-auto" id="messagesContainer">
                  <pre id="messages" class="text-sm"><code class="text-base-content">Not connected.</code></pre>
                </div>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium mb-2">Send Message:</label>
                <div class="flex gap-2">
                  <input type="text" id="username" class="input input-bordered w-32" placeholder="Name">
                  <input type="text" id="messageInput" class="input input-bordered flex-1" placeholder="Connect to start chatting..." disabled>
                  <button id="sendBtn" class="btn btn-accent" disabled>Send</button>
                </div>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium mb-2">Connection Log:</label>
                <div class="mockup-code bg-base-300 h-32 overflow-y-auto">
                  <pre id="log" class="text-xs"><code class="text-base-content opacity-70"></code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
        // Initialize admin authentication
        document.addEventListener('DOMContentLoaded', () => {
            ShogunAdmin.init({
                autoFill: false, // This app doesn't need auto-fill
                showIndicator: false,
                syncEnabled: true
            });
        });

        const serverAddressInput = document.getElementById('serverAddress');
        const connectBtn = document.getElementById('connectBtn');
        const messagesEl = document.getElementById('messages');
        const usernameInput = document.getElementById('username');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const logEl = document.getElementById('log');

        let bugout = null;
        let connected = false;

        function log(...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' ')}`;
            console.log(...args);
            const logCode = logEl.querySelector('code') || logEl;
            logCode.textContent += logMessage + '\n';
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        }

        function updateUI() {
            connectBtn.textContent = connected ? 'Disconnect' : 'Connect';
            connectBtn.className = connected ? 'btn btn-error' : 'btn btn-primary';
            messageInput.disabled = !connected;
            sendBtn.disabled = !connected;
            if (connected) {
                messageInput.placeholder = "Type message...";
                messageInput.className = "input input-bordered flex-1";
            } else {
                messageInput.placeholder = "Connect to start chatting...";
                messageInput.className = "input input-bordered flex-1";
            }
        }

        function initClient() {
            if (bugout) {
                bugout.destroy();
                bugout = null;
                connected = false;
                updateUI();
                log("üîå Disconnected.");
                const messagesCode = messagesEl.querySelector('code') || messagesEl;
                messagesCode.textContent = 'Not connected.';
                return;
            }

            const serverAddress = serverAddressInput.value.trim();
            if (!serverAddress) {
                log("‚ö†Ô∏è Please enter a server address.");
                return;
            }
            
            log("üîÑ Connecting to chat server...", serverAddress);

            try {
                if (typeof Bugoff !== 'function') throw new Error("Bugoff library not available");

                bugout = new Bugoff(serverAddress);

                bugout.on("server", () => {
                    log("‚úÖ Connected to server");
                    connected = true;
                    updateUI();
                    refreshMessages();
                });

                bugout.on("message", (address, message) => {
                    if (message === "refresh") {
                        refreshMessages();
                    }
                });

                bugout.on("decrypted", (address, pubkeys, message) => {
                    log("ü§´ Decrypted message received");
                    if (message === "refresh") {
                        refreshMessages();
                    }
                });

                bugout.on("wireseen", (count) => {
                    log(`üîó ${count} peer(s) connected`);
                    connected = count > 0;
                    updateUI();
                });

                bugout.on("wireleft", (count) => {
                    log(`üëã Peer disconnected. ${count} remaining`);
                    connected = count > 0;
                    if (!connected) {
                        log("‚ùå Connection lost");
                        if (bugout) bugout.destroy();
                        bugout = null;
                    }
                    updateUI();
                });

                bugout.on("close", () => {
                    log("‚ùå Connection closed");
                    connected = false;
                    bugout = null;
                    updateUI();
                });

                bugout.on("error", (error) => {
                    log("üö´ Connection error:", error.message || error);
                    connected = false;
                    if (bugout) bugout.destroy();
                    bugout = null;
                    updateUI();
                });
            } catch (error) {
                log("üí• Failed to initialize:", error.message);
                connected = false;
                bugout = null;
                updateUI();
            }
        }

        function sendMessage() {
            if (!connected || !messageInput.value.trim()) return;

            const user = usernameInput.value.trim() || "Anonymous";
            localStorage.setItem("bugout-username", user);

            const formattedMessage = `${user}: ${messageInput.value.trim()}`;
            log("üì§ Sending:", formattedMessage);

            try {
                bugout.rpc("post", formattedMessage, (ok) => {
                    if (ok) {
                        log("‚úÖ Message sent successfully");
                        messageInput.value = "";
                        messageInput.focus();
                        refreshMessages(); // Refresh after sending
                    } else {
                        log("‚ùå Failed to send message");
                    }
                });
            } catch (error) {
                log("üí• Send error:", error.message);
            }
        }

        function refreshMessages() {
            if (!connected || !bugout) {
                const messagesCode = messagesEl.querySelector('code') || messagesEl;
                messagesCode.textContent = 'Not connected.';
                return;
            }

            try {
                bugout.rpc("list", null, (messageList) => {
                    if (!Array.isArray(messageList)) {
                        log("‚ö†Ô∏è Invalid message list received");
                        return;
                    }

                    log(`üì® Loaded ${messageList.length} messages`);
                    
                    const formattedMessages = messageList.map((m) => {
                        const time = new Date(m.t).toLocaleTimeString();
                        return `[${time}] ${m.m || ''}`;
                    });

                    const messagesCode = messagesEl.querySelector('code') || messagesEl;
                    messagesCode.textContent = formattedMessages.join('\n');
                    document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
                });
            } catch (error) {
                log("üí• Refresh error:", error.message);
            }
        }

        // Event Listeners
        connectBtn.addEventListener('click', initClient);
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initial setup
        serverAddressInput.value = window.location.hash.substr(1) || "";
        usernameInput.value = localStorage.getItem("bugout-username") || "";
        log("ü¶Ñ Minimal Messenger initialized.");
        log("Enter server address and click 'Connect'.");

    </script>
  </body>
</html>
