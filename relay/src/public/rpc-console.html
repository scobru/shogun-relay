<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>RPC Console - Shogun Relay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/google-md3.css">
    <style>
        .page-header {
            background-color: var(--md-surface-container-low);
            border-bottom: 1px solid var(--md-outline-variant);
            padding: 24px;
            margin-bottom: 32px;
        }

        .page-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            box-shadow: 0 8px 24px rgba(255, 105, 180, 0.3);
        }

        .page-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .console-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .console-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .console-grid {
                grid-template-columns: 1fr;
            }
        }

        .console-card {
            background-color: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 16px;
            padding: 24px;
        }

        .console-card h2 {
            color: var(--md-primary);
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .console-card p {
            color: var(--md-on-surface-variant);
            font-size: 0.875rem;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--md-on-surface);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .md-input {
            flex: 1;
        }

        .code-block {
            background-color: var(--md-surface-container-low);
            border: 1px solid var(--md-outline-variant);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.875rem;
            color: var(--md-on-surface);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-block.response {
            max-height: 500px;
        }

        .response-success {
            border-left: 3px solid var(--md-success);
        }

        .response-error {
            border-left: 3px solid var(--md-error);
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--md-primary);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-header h2 {
            margin-bottom: 0;
        }

        .section-header .md-flex {
            display: flex;
            gap: 8px;
        }

        select.md-input {
            appearance: auto;
            cursor: pointer;
        }

        textarea.md-input {
            min-height: 100px;
            resize: vertical;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--md-outline);
            border-top-color: var(--md-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="page-header">
        <div class="page-header-content">
            <a href="/admin" class="md-btn md-btn-icon" title="Back to Admin">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24"
                    height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div class="page-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h1 class="md-headline-medium">RPC Console</h1>
                <p class="md-body-medium md-text-secondary">Interact with blockchain RPC endpoints</p>
            </div>
        </div>
    </header>

    <main class="console-container">
        <div class="console-grid">
            <!-- Configuration Panel -->
            <div class="console-card">
                <h2>Get Started</h2>
                <p>Make your first API request using our Node RPC API.</p>

                <!-- Endpoint URL -->
                <div class="form-group">
                    <label>Endpoint URL</label>
                    <div class="form-row">
                        <input type="text" id="endpointUrl" class="md-input"
                            placeholder="https://base-sepolia.g.alchemy.com/v2/...">
                        <button onclick="copyEndpoint()" class="md-btn md-btn-outlined">Copy</button>
                    </div>
                </div>

                <!-- Network Selector -->
                <div class="form-group">
                    <label>Network</label>
                    <select id="networkSelect" class="md-input">
                        <option value="">Loading networks...</option>
                    </select>
                </div>

                <!-- Method Selector -->
                <div class="form-group">
                    <label>Method</label>
                    <select id="methodSelect" class="md-input">
                        <option value="">Select a method...</option>
                    </select>
                </div>

                <!-- Parameters -->
                <div class="form-group">
                    <label>Parameters (JSON array, optional)</label>
                    <textarea id="paramsInput" class="md-input" placeholder='["0x1", "latest"]'></textarea>
                </div>

                <!-- Use Proxy Option -->
                <div class="checkbox-row">
                    <input type="checkbox" id="useProxy">
                    <label for="useProxy" style="margin-bottom: 0;">Use relay proxy (if CORS blocked)</label>
                </div>

                <!-- Execute Button -->
                <button onclick="executeRpc()" id="executeBtn" class="md-btn md-btn-filled" style="width: 100%;">
                    Execute Request
                </button>
            </div>

            <!-- Request/Response Panel -->
            <div class="console-card">
                <div class="section-header">
                    <h2>Request</h2>
                    <div class="md-flex">
                        <select id="codeFormat" class="md-input" style="width: auto; min-height: 40px;">
                            <option value="curl">Shell (curl)</option>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                        </select>
                        <button onclick="copyRequest()" class="md-btn md-btn-outlined">Copy</button>
                    </div>
                </div>
                <div id="requestCode" class="code-block">Configure endpoint and method to see request preview</div>

                <h2 style="margin-top: 24px;">Response</h2>
                <div id="responseCode" class="code-block response"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="md-footer">
            <p class="md-body-small">
                Shogun Relay RPC Console — Part of the <a href="https://github.com/scobru/shogun">Shogun Project</a>
            </p>
        </footer>
    </main>

    <script src="lib/admin-auth.js"></script>
    <script src="lib/admin-nav.js"></script>
    <script>
        // Common RPC methods
        const RPC_METHODS = [
            { name: 'eth_blockNumber', desc: 'Get the latest block number', params: [] },
            { name: 'eth_getBalance', desc: 'Get balance of an address', params: ['address', 'block'] },
            { name: 'eth_getTransactionCount', desc: 'Get transaction count (nonce)', params: ['address', 'block'] },
            { name: 'eth_getBlockByNumber', desc: 'Get block by number', params: ['blockNumber', 'fullTransactions'] },
            { name: 'eth_getBlockByHash', desc: 'Get block by hash', params: ['blockHash', 'fullTransactions'] },
            { name: 'eth_getTransactionByHash', desc: 'Get transaction by hash', params: ['txHash'] },
            { name: 'eth_getTransactionReceipt', desc: 'Get transaction receipt', params: ['txHash'] },
            { name: 'eth_sendRawTransaction', desc: 'Send signed transaction', params: ['signedTx'] },
            { name: 'eth_call', desc: 'Execute message call', params: ['callObject', 'block'] },
            { name: 'eth_estimateGas', desc: 'Estimate gas usage', params: ['callObject'] },
            { name: 'eth_getLogs', desc: 'Query logs', params: ['filterObject'] },
            { name: 'eth_gasPrice', desc: 'Get current gas price', params: [] },
            { name: 'eth_chainId', desc: 'Get chain ID', params: [] },
            { name: 'net_version', desc: 'Get network ID', params: [] },
        ];

        let availableNetworks = [];

        async function loadRpcStatus() {
            try {
                const response = await fetch('/rpc-status');
                const result = await response.json();

                if (result.success && result.rpcs) {
                    availableNetworks = result.rpcs;
                    const networkSelect = document.getElementById('networkSelect');
                    networkSelect.innerHTML = '<option value="">Select a network...</option>';

                    result.rpcs.forEach((rpc, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${rpc.name} (${rpc.network})${rpc.status === 'online' ? ' ✓' : ''}`;
                        networkSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading RPC status:', error);
            }
        }

        function populateMethods() {
            const methodSelect = document.getElementById('methodSelect');
            methodSelect.innerHTML = '<option value="">Select a method...</option>';

            RPC_METHODS.forEach(method => {
                const option = document.createElement('option');
                option.value = method.name;
                option.textContent = `${method.name} - ${method.desc}`;
                methodSelect.appendChild(option);
            });
        }

        function updateRequestPreview() {
            const endpointUrl = document.getElementById('endpointUrl').value;
            const method = document.getElementById('methodSelect').value;
            const params = document.getElementById('paramsInput').value;
            const format = document.getElementById('codeFormat').value;

            if (!endpointUrl || !method) {
                document.getElementById('requestCode').textContent = 'Configure endpoint and method to see preview';
                return;
            }

            let paramsArray = [];
            try {
                if (params.trim()) {
                    paramsArray = JSON.parse(params);
                }
            } catch (e) { }

            const requestBody = { jsonrpc: "2.0", method: method, params: paramsArray, id: 1 };

            let code = '';
            if (format === 'curl') {
                code = `curl --request POST \\
  --url ${endpointUrl} \\
  --header 'content-type: application/json' \\
  --data '${JSON.stringify(requestBody)}'`;
            } else if (format === 'javascript') {
                code = `const response = await fetch('${endpointUrl}', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(${JSON.stringify(requestBody, null, 2)})
});
const data = await response.json();`;
            } else if (format === 'python') {
                code = `import requests

response = requests.post(
    '${endpointUrl}',
    headers={'Content-Type': 'application/json'},
    json=${JSON.stringify(requestBody, null, 2)}
)
print(response.json())`;
            }

            document.getElementById('requestCode').textContent = code;
        }

        async function executeRpc() {
            const endpointUrl = document.getElementById('endpointUrl').value;
            const method = document.getElementById('methodSelect').value;
            const params = document.getElementById('paramsInput').value;

            if (!endpointUrl || !method) {
                alert('Please configure endpoint URL and method');
                return;
            }

            let paramsArray = [];
            try {
                if (params.trim()) paramsArray = JSON.parse(params);
            } catch (e) {
                alert('Invalid JSON in parameters: ' + e.message);
                return;
            }

            const executeBtn = document.getElementById('executeBtn');
            const responseCode = document.getElementById('responseCode');

            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading-spinner"></span> Executing...';
            responseCode.textContent = 'Executing request...';
            responseCode.className = 'code-block response';

            const useProxy = document.getElementById('useProxy').checked;
            const requestBody = { jsonrpc: "2.0", method: method, params: paramsArray, id: 1 };

            try {
                let response;

                if (useProxy) {
                    response = await fetch('/api/v1/system/rpc/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ endpoint: endpointUrl, request: requestBody })
                    });
                    const result = await response.json();
                    responseCode.textContent = JSON.stringify(result.success ? result.response : result, null, 2);
                    responseCode.classList.add(result.success ? 'response-success' : 'response-error');
                } else {
                    response = await fetch(endpointUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    const responseData = await response.json();
                    responseCode.textContent = JSON.stringify(responseData, null, 2);
                    responseCode.classList.add(response.ok ? 'response-success' : 'response-error');
                }
            } catch (error) {
                responseCode.textContent = JSON.stringify({
                    error: error.message,
                    suggestion: 'Enable "Use relay proxy" if CORS blocked'
                }, null, 2);
                responseCode.classList.add('response-error');
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Request';
            }
        }

        function copyEndpoint() {
            navigator.clipboard.writeText(document.getElementById('endpointUrl').value);
            alert('Copied!');
        }

        function copyRequest() {
            navigator.clipboard.writeText(document.getElementById('requestCode').textContent);
            alert('Copied!');
        }

        // Event listeners
        document.getElementById('networkSelect').addEventListener('change', function () {
            const index = this.value;
            if (index !== '' && availableNetworks[index]) {
                document.getElementById('endpointUrl').value = availableNetworks[index].rpc;
                updateRequestPreview();
            }
        });

        document.getElementById('methodSelect').addEventListener('change', updateRequestPreview);
        document.getElementById('endpointUrl').addEventListener('input', updateRequestPreview);
        document.getElementById('paramsInput').addEventListener('input', updateRequestPreview);
        document.getElementById('codeFormat').addEventListener('change', updateRequestPreview);

        // Initialize
        loadRpcStatus();
        populateMethods();
    </script>
</body>

</html>