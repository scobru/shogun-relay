<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS Pin Manager</title>
    <link rel="stylesheet" href="dharma-style/dharma.css">
    <style>
        body { background-color: #222; color: #eee; font-family: "Menlo", "Consolas", monospace; line-height: 1.6; margin: 2em; }
        h1, h2 { border-bottom: 1px solid #555; padding-bottom: 10px; }
        a { color: #8af; text-decoration: none; }
        a:hover { background-color: #333; }
        .container { max-width: 800px; margin: auto; background-color: #2a2a2a; padding: 2em; border-radius: 5px; border: 1px solid #444; }
        input[type="text"], input[type="password"] { background-color: #444; color: #eee; border: 1px solid #666; padding: 12px; font-family: inherit; width: 100%; box-sizing: border-box; margin: 8px 0; }
        button { background-color: #444; color: #eee; border: 1px solid #666; padding: 12px 24px; cursor: pointer; font-family: inherit; margin: 8px 0; }
        button:hover { background-color: #555; }
        #message { padding: 1em; margin: 1em 0; border-radius: 4px; }
        .success { background-color: #143; border: 1px solid #175; }
        .error { background-color: #412; border: 1px solid #511; }
        .working { opacity: 0.5; cursor: not-allowed; }
        #pinList { margin-top: 1em; }
        .pin-item {
            background-color: #333;
            padding: 1em;
            margin: 0.5em 0;
            border-radius: 4px;
            word-break: break-all;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        .small-button {
            padding: 4px 8px;
            font-size: 0.8em;
            flex: 0 1 auto;
        }
        .pin-action {
            background-color: #1a4d1a;
            border-color: #2a6d2a;
        }
        .pin-action:hover {
            background-color: #2a6d2a;
        }
        .unpin-action {
            background-color: #8B4000;
            border-color: #A04000;
        }
        .unpin-action:hover {
            background-color: #A04000;
        }
        .remove-action {
            background-color: #8B0000;
            border-color: #A00000;
        }
        .remove-action:hover {
            background-color: #A00000;
        }
        .copy-action {
            background-color: #444;
        }
        .copy-action:hover {
            background-color: #555;
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0,0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }
        .loader-spinner {
            border: 8px solid #444;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IPFS Pin Manager</h1>
        
        <div id="loader" class="loader-overlay" style="display: none;">
            <div class="loader-spinner"></div>
        </div>

        <section>
            <h2>Authentication</h2>
            <input type="password" id="adminToken" placeholder="Admin Token" />
        </section>

        <section>
            <h2>Pin Management</h2>
            <input type="text" id="cidInput" placeholder="Enter CID to pin/unpin" />
            <button onclick="addPin()">Add Pin</button>
            <button onclick="removePin()">Remove Pin</button>
            <button onclick="listPins()">List All Pins</button>
            <button onclick="garbageCollect()">Garbage Collect</button>
        </section>

        <section>
            <h2>Batch Operations</h2>
            <button onclick="batchUnpinAll()" class="unpin-action">üóëÔ∏è Unpin All Files</button>
            <div id="batchProgress" style="display: none;">
                <div style="margin: 10px 0;">
                    <div style="background-color: #444; border: 1px solid #666; border-radius: 4px; height: 20px; overflow: hidden;">
                        <div id="progressBar" style="background-color: #8B4000; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9em;">
                        <span id="progressText">Processing...</span>
                        <span style="float: right;"><span id="progressCurrent">0</span> / <span id="progressTotal">0</span></span>
                    </div>
                </div>
                <div id="batchLog" style="max-height: 200px; overflow-y: auto; background-color: #2a2a2a; border: 1px solid #555; padding: 10px; font-size: 0.8em; margin-top: 10px;"></div>
            </div>
        </section>

        <div id="message" style="display: none;"></div>
        <div id="pinList"></div>
    </div>

    <script>
        const adminTokenInput = document.getElementById('adminToken');
        const cidInput = document.getElementById('cidInput');
        const messageEl = document.getElementById('message');
        const pinListEl = document.getElementById('pinList');
        const loaderEl = document.getElementById('loader');

        function showLoader() {
            loaderEl.style.display = 'flex';
        }

        function hideLoader() {
            loaderEl.style.display = 'none';
        }

        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = isError ? 'error' : 'success';
            messageEl.style.display = 'block';
        }

        function setWorking(isWorking) {
            document.querySelectorAll('button').forEach(btn => {
                if (isWorking) {
                    btn.classList.add('working');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('working');
                    btn.disabled = false;
                }
            });
        }

        async function apiCall(endpoint, method = 'POST', body = {}, options = {}) {
            const manageVisibility = options.manageVisibility !== false;
            
            if (manageVisibility) {
                showLoader();
                setWorking(true);
            }

            try {
                const token = adminTokenInput.value;
                if (!token) {
                    throw new Error('Admin Token is required.');
                }

                messageEl.style.display = 'none';
                console.log(`Making ${method} request to ${endpoint}`);
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Response:', result);

                if (result.success === false) {
                    throw new Error(result.error || 'API returned success:false');
                }

                return result;
            } catch (error) {
                console.log('API call error:', error);
                showMessage(error.message, true);
                return null;
            } finally {
                if (manageVisibility) {
                    setWorking(false);
                    hideLoader();
                }
            }
        }

        async function addPin() {
            const cid = cidInput.value.trim();
            if (!cid) {
                showMessage('Please enter a CID', true);
                return;
            }

            const result = await apiCall('/pins/add', 'POST', { cid });
            if (result) {
                showMessage('Pin added successfully');
                await listPins();
            }
        }

        async function removePin() {
            const cid = cidInput.value.trim();
            if (!cid) {
                showMessage('Please enter a CID', true);
                return;
            }

            const result = await apiCall('/pins/rm', 'POST', { cid });
            if (result) {
                showMessage('Pin removed successfully');
                await listPins();
            }
        }

        async function listPins() {
            const result = await apiCall('/pins/ls', 'POST');
            if (result) {
                pinListEl.innerHTML = '';
                
                // Get pins from the correct path in the response
                const pins = result.data?.Keys || {};
                
                if (Object.keys(pins).length === 0) {
                    pinListEl.innerHTML = '<div class="pin-item">No pins found</div>';
                    return;
                }

                // Add a style for the pin name
                const style = document.createElement('style');
                style.textContent = `
                    .pin-name {
                        color: #8af;
                        margin-top: 5px;
                        font-size: 0.9em;
                    }
                    .pin-type {
                        color: #7c7;
                        font-size: 0.9em;
                    }
                    .pin-item {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }
                    .button-group {
                        display: flex;
                        gap: 8px;
                        margin-top: 5px;
                    }
                    .small-button {
                        padding: 4px 8px;
                        font-size: 0.8em;
                        flex: 0 1 auto;
                    }
                    .pin-action {
                        background-color: #1a4d1a;
                        border-color: #2a6d2a;
                    }
                    .pin-action:hover {
                        background-color: #2a6d2a;
                    }
                    .unpin-action {
                        background-color: #8B4000;
                        border-color: #A04000;
                    }
                    .unpin-action:hover {
                        background-color: #A04000;
                    }
                    .remove-action {
                        background-color: #8B0000;
                        border-color: #A00000;
                    }
                    .remove-action:hover {
                        background-color: #A00000;
                    }
                    .copy-action {
                        background-color: #444;
                    }
                    .copy-action:hover {
                        background-color: #555;
                    }
                `;
                document.head.appendChild(style);

                // Process and display pins
                Object.entries(pins).forEach(([cid, info]) => {
                    const pinEl = document.createElement('div');
                    pinEl.className = 'pin-item';
                    
                    // Add CID
                    const cidEl = document.createElement('div');
                    cidEl.textContent = `CID: ${cid}`;
                    cidEl.style.fontFamily = 'monospace';
                    pinEl.appendChild(cidEl);

                    // Add Type
                    const typeEl = document.createElement('div');
                    typeEl.textContent = `Type: ${info.Type || 'recursive'}`;
                    typeEl.style.color = '#8af';
                    pinEl.appendChild(typeEl);

                    // Add button group
                    const buttonGroup = document.createElement('div');
                    buttonGroup.className = 'button-group';

                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'üìã Copy CID';
                    copyBtn.className = 'small-button copy-action';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(cid)
                            .then(() => {
                                copyBtn.textContent = '‚úÖ Copied!';
                                setTimeout(() => copyBtn.textContent = 'üìã Copy CID', 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy:', err);
                                copyBtn.textContent = '‚ùå Error';
                                setTimeout(() => copyBtn.textContent = 'üìã Copy CID', 2000);
                            });
                    };

                    // Add pin again button
                    const rePinBtn = document.createElement('button');
                    rePinBtn.textContent = 'üìå Pin Again';
                    rePinBtn.className = 'small-button pin-action';
                    rePinBtn.onclick = async () => {
                        rePinBtn.disabled = true;
                        rePinBtn.textContent = '‚è≥ Pinning...';
                        
                        const result = await apiCall('/pins/add', 'POST', { cid });

                        if (result) {
                            rePinBtn.textContent = '‚úÖ Pinned!';
                            showMessage(`Successfully pinned CID: ${cid}`, false);
                        } else {
                            rePinBtn.textContent = '‚ùå Failed';
                        }
                        
                        setTimeout(() => {
                            if (rePinBtn.textContent !== '‚úÖ Pinned!') {
                                rePinBtn.disabled = false;
                                rePinBtn.textContent = 'üìå Pin Again';
                            }
                        }, 2000);
                    };

                    // Add unpin button
                    const unpinBtn = document.createElement('button');
                    unpinBtn.textContent = 'üìç Unpin';
                    unpinBtn.className = 'small-button unpin-action';
                    unpinBtn.onclick = async () => {
                        if (!confirm('Are you sure you want to unpin this content?')) return;
                        
                        unpinBtn.disabled = true;
                        unpinBtn.textContent = '‚è≥ Unpinning...';
                        
                        const result = await apiCall('/pins/rm', 'POST', { cid });

                        if (result) {
                            unpinBtn.textContent = '‚úÖ Unpinned!';
                            showMessage(`Successfully unpinned CID: ${cid}`, false);
                            setTimeout(listPins, 2000);
                        } else {
                            unpinBtn.textContent = '‚ùå Failed';
                            // Error is shown by apiCall, just reset button
                            setTimeout(() => {
                                unpinBtn.disabled = false;
                                unpinBtn.textContent = 'üìç Unpin';
                            }, 2000);
                        }
                    };

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'üóëÔ∏è Remove';
                    removeBtn.className = 'small-button remove-action';
                    removeBtn.onclick = async () => {
                        if (!confirm('This will unpin the content AND run garbage collection, which can be slow. Are you sure?')) return;
                        
                        showLoader();
                        setWorking(true);
                        removeBtn.textContent = '‚è≥ Unpinning...';
                        
                        try {
                            const unpinResult = await apiCall('/pins/rm', 'POST', { cid }, { manageVisibility: false });

                            if (unpinResult) {
                                showMessage(`Successfully unpinned ${cid}. Now running GC...`, false);
                                removeBtn.textContent = 'üßπ Collecting...';

                                const gcResult = await apiCall('/repo/gc', 'POST', { manageVisibility: false });

                                if (gcResult) {
                                    showMessage(`Successfully removed ${cid} and ran garbage collection.`, false);
                                    setTimeout(listPins, 1500);
                                } else {
                                    showMessage(`Unpinned ${cid}, but garbage collection failed.`, true);
                                }
                            }
                        } catch (error) {
                            showMessage(error.message, true);
                        } finally {
                            // Hide the main loader. listPins will show its own.
                            hideLoader();
                            setWorking(false);
                            // The list will be refreshed, so no need to manually reset the button.
                        }
                    };

                    buttonGroup.appendChild(copyBtn);
                    buttonGroup.appendChild(rePinBtn);
                    buttonGroup.appendChild(unpinBtn);
                    buttonGroup.appendChild(removeBtn);
                    pinEl.appendChild(buttonGroup);

                    pinListEl.appendChild(pinEl);
                });

                // Add summary
                const summary = document.createElement('div');
                summary.style.marginTop = '1em';
                summary.style.padding = '1em';
                summary.style.backgroundColor = '#2a2a2a';
                summary.style.borderRadius = '4px';
                summary.textContent = `Total pins: ${Object.keys(pins).length}`;
                pinListEl.appendChild(summary);
            }
        }

        async function garbageCollect() {
            const result = await apiCall('/repo/gc', 'POST');
            if (result && result.data) {
                // Handle the garbage collection response which might be a stream of objects
                const message = Array.isArray(result.data) 
                    ? `Garbage collection completed. Removed ${result.data.length} items.`
                    : 'Garbage collection completed successfully';
                showMessage(message);
            }
        }

        function updateBatchProgress(current, total, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressCurrent = document.getElementById('progressCurrent');
            const progressTotal = document.getElementById('progressTotal');
            
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressText.textContent = message;
            progressCurrent.textContent = current;
            progressTotal.textContent = total;
        }

        function addBatchLog(message, isError = false) {
            const batchLog = document.getElementById('batchLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = isError ? '#ff6666' : '#cccccc';
            logEntry.style.marginBottom = '2px';
            logEntry.textContent = `[${timestamp}] ${message}`;
            batchLog.appendChild(logEntry);
            batchLog.scrollTop = batchLog.scrollHeight;
        }

        async function batchUnpinAll() {
            if (!confirm('‚ö†Ô∏è This will unpin ALL files from IPFS. This action cannot be undone. Are you sure?')) {
                return;
            }

            const batchProgress = document.getElementById('batchProgress');
            const batchLog = document.getElementById('batchLog');
            
            // Clear previous log
            batchLog.innerHTML = '';
            batchProgress.style.display = 'block';
            
            addBatchLog('Starting batch unpin operation...');
            
            try {
                // First, get all pins
                addBatchLog('Fetching current pin list...');
                const listResult = await apiCall('/pins/ls', 'POST', {}, { manageVisibility: false });
                
                if (!listResult || !listResult.data || !listResult.data.Keys) {
                    addBatchLog('Failed to fetch pin list', true);
                    showMessage('Failed to fetch pin list', true);
                    batchProgress.style.display = 'none';
                    return;
                }

                const pins = Object.keys(listResult.data.Keys);
                const totalPins = pins.length;
                
                if (totalPins === 0) {
                    addBatchLog('No pins found to remove');
                    showMessage('No pins found to remove');
                    batchProgress.style.display = 'none';
                    return;
                }

                addBatchLog(`Found ${totalPins} pins to remove`);
                updateBatchProgress(0, totalPins, 'Unpinning files...');

                let successCount = 0;
                let errorCount = 0;

                // Process each pin
                for (let i = 0; i < pins.length; i++) {
                    const cid = pins[i];
                    const currentProgress = i + 1;
                    
                    updateBatchProgress(currentProgress, totalPins, `Unpinning ${currentProgress}/${totalPins}: ${cid.substring(0, 12)}...`);
                    addBatchLog(`Unpinning: ${cid}`);

                    try {
                        const unpinResult = await apiCall('/pins/rm', 'POST', { cid }, { manageVisibility: false });
                        
                        if (unpinResult && unpinResult.success !== false) {
                            successCount++;
                            addBatchLog(`‚úÖ Successfully unpinned: ${cid.substring(0, 12)}...`);
                        } else {
                            errorCount++;
                            addBatchLog(`‚ùå Failed to unpin: ${cid.substring(0, 12)}... - ${unpinResult?.error || 'Unknown error'}`, true);
                        }
                    } catch (error) {
                        errorCount++;
                        addBatchLog(`‚ùå Error unpinning: ${cid.substring(0, 12)}... - ${error.message}`, true);
                    }

                    // Small delay to prevent overwhelming the API
                    if (i < pins.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                updateBatchProgress(totalPins, totalPins, 'Batch unpin completed');
                addBatchLog(`Batch operation completed: ${successCount} successful, ${errorCount} failed`);
                
                if (successCount > 0) {
                    showMessage(`Batch unpin completed: ${successCount} files unpinned successfully${errorCount > 0 ? `, ${errorCount} failed` : ''}`, errorCount === 0 ? false : true);
                    
                    // Ask if user wants to run garbage collection
                    if (confirm('Files have been unpinned. Would you like to run garbage collection to free up disk space?')) {
                        addBatchLog('Running garbage collection...');
                        updateBatchProgress(totalPins, totalPins, 'Running garbage collection...');
                        
                        const gcResult = await apiCall('/repo/gc', 'POST', {}, { manageVisibility: false });
                        if (gcResult) {
                            addBatchLog('‚úÖ Garbage collection completed');
                            showMessage('Batch unpin and garbage collection completed successfully');
                        } else {
                            addBatchLog('‚ùå Garbage collection failed', true);
                            showMessage('Files unpinned but garbage collection failed', true);
                        }
                    }
                    
                    // Refresh the pin list
                    await listPins();
                } else {
                    showMessage('Batch unpin failed - no files were unpinned', true);
                }

            } catch (error) {
                addBatchLog(`‚ùå Fatal error: ${error.message}`, true);
                showMessage(`Batch unpin failed: ${error.message}`, true);
            } finally {
                updateBatchProgress(0, 0, 'Ready');
            }
        }
    </script>
</body>
</html>
 