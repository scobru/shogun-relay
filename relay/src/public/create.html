<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunDB Data Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
     <link href="styles/wormhole.css" rel="stylesheet" type="text/css" />

    <!-- Include centralized admin authentication -->
    <script src="lib/admin-auth.js"></script>
    <style>
        .input-custom {
            width: 100%;
            background-color: #404040;
            color: #FFFFFF;
            border: 1px solid #606060;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .input-custom:focus {
            outline: none;
            border-color: #FF69B4;
            box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.2);
        }

        .textarea-height {
            height: 200px;
        }

        @media (min-width: 640px) {
            .textarea-height {
                height: 256px;
                /* h-64 equivalent */
            }
        }

        .btn-custom {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #FF69B4;
            color: #FFFFFF;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
        }

        @media (min-width: 640px) {
            .btn-custom {
                width: auto;
            }
        }

        .btn-custom:hover {
            background-color: #FF1493;
            transform: translateY(-1px);
        }

        .btn-custom:disabled {
            background-color: #606060;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-weight: 500;
        }

        .message.success {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .message.error {
            background-color: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
    </style>
</head>

<body class="antialiased bg-[#1A1A1A]">
    <div class="container mx-auto p-6">
        <div class="flex items-center mb-6">
            <a href="/" class="text-[#42A5F5] hover:text-[#64B5F6] transition-colors text-lg">&larr; Back to Control
                Panel</a>
        </div>

        <div class="card bg-[#282828] border-[#404040] rounded-2xl shadow-xl">
            <div class="p-8 sm:p-10">
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 sm:h-16 sm:w-16 mb-6 text-[#FF69B4]"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>

                    <h1 class="text-2xl sm:text-3xl font-semibold mb-8 sm:mb-10 text-center text-[#FFFFFF]">GunDB Data
                        Creator</h1>

                    <div class="w-full space-y-6 sm:space-y-8">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-[#FF69B4]">Create New Node</h2>
                            <div class="space-y-6">
                                <div class="form-group">
                                    <label class="block text-lg font-medium mb-3 text-[#FFFFFF]">Node Path:</label>
                                    <input type="text" id="nodePathInput" class="input-custom"
                                        placeholder="e.g., my/data/node">
                                </div>
                                <div class="form-group">
                                    <label class="block text-lg font-medium mb-3 text-[#FFFFFF]">Data:</label>
                                    <div id="json-fields-container"
                                        class="space-y-4 p-4 border border-[#606060] rounded-xl bg-[#404040]">
                                        <!-- Key-value pairs will be dynamically added here -->
                                    </div>
                                    <div class="mt-4">
                                        <button id="addFieldBtn"
                                            class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-6 py-3 text-lg font-medium">+
                                            Add Field</button>
                                    </div>
                                </div>
                                <div class="flex justify-center sm:justify-start pt-4">
                                    <button id="createBtn" class="btn-custom">Create Node</button>
                                </div>
                            </div>
                        </div>

                        <div id="message" class="alert hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener( 'DOMContentLoaded', () =>
        {
            // Initialize admin authentication
            ShogunAdmin.init( {
                autoFill: true,
                showIndicator: true,
                fieldId: 'authToken',
                syncEnabled: true
            } );
            // Add the first empty field for the user
            addField();
        } );

        // Listen for password updates
        window.addEventListener( 'shogun-admin-password-updated', ( event ) =>
        {
            console.log( 'Admin password updated' );
        } );

        const nodePathInput = document.getElementById( 'nodePathInput' );
        const createBtn = document.getElementById( 'createBtn' );
        const messageEl = document.getElementById( 'message' );
        const jsonFieldsContainer = document.getElementById( 'json-fields-container' );
        const addFieldBtn = document.getElementById( 'addFieldBtn' );

        const showMessage = ( text, type = 'error' ) =>
        {
            messageEl.textContent = text;
            messageEl.className = `message ${ type }`;
            messageEl.style.display = 'block';

            // Scroll to message
            messageEl.scrollIntoView( { behavior: 'smooth', block: 'center' } );

            // Auto-hide messages after 5 seconds
            setTimeout( () =>
            {
                messageEl.style.display = 'none';
            }, 5000 );
        };

        const addField = ( key = '', value = '' ) =>
        {
            const fieldId = `field-${ Date.now() }-${ Math.random().toString( 36 ).substring( 2, 9 ) }`;
            const newField = document.createElement( 'div' );
            newField.classList.add( 'flex', 'items-center', 'space-x-3' );
            newField.id = fieldId;
            newField.innerHTML = `
                <input type="text" placeholder="Key" class="input w-full bg-[#282828] border-[#606060] text-[#FFFFFF] placeholder-[#A0A0A0] rounded-xl px-4 py-3 text-lg focus:ring-[#FF69B4] focus:ring-opacity-50 focus:outline-none key-input" value="${ key }">
                <input type="text" placeholder="Value (string, number, boolean, or JSON)" class="input w-full bg-[#282828] border-[#606060] text-[#FFFFFF] placeholder-[#A0A0A0] rounded-xl px-4 py-3 text-lg focus:ring-[#FF69B4] focus:ring-opacity-50 focus:outline-none value-input" value="${ value }">
                <button type="button" class="btn btn-sm bg-transparent border-[#606060] text-[#F44336] hover:bg-[#404040] rounded-xl px-3 py-3" onclick="document.getElementById('${ fieldId }').remove()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            jsonFieldsContainer.appendChild( newField );
        };

        addFieldBtn.addEventListener( 'click', ( e ) =>
        {
            e.preventDefault();
            addField();
        } );

        createBtn.addEventListener( 'click', async () =>
        {
            const nodePath = nodePathInput.value.trim();
            if ( !nodePath )
            {
                showMessage( 'Node Path is required.' );
                return;
            }

            const data = {};
            const fields = jsonFieldsContainer.querySelectorAll( '.flex' );
            let hasError = false;

            fields.forEach( field =>
            {
                if ( hasError ) return;

                const keyInput = field.querySelector( '.key-input' );
                const valueInput = field.querySelector( '.value-input' );
                const key = keyInput.value.trim();
                let value = valueInput.value; // Keep original input to check for empty strings

                if ( key )
                {
                    // Try to parse numbers, booleans, and JSON strings
                    const trimmedValue = value.trim();
                    if ( trimmedValue !== '' && !isNaN( trimmedValue ) && !isNaN( parseFloat( trimmedValue ) ) )
                    {
                        value = Number( trimmedValue );
                    } else if ( trimmedValue.toLowerCase() === 'true' )
                    {
                        value = true;
                    } else if ( trimmedValue.toLowerCase() === 'false' )
                    {
                        value = false;
                    } else if ( ( trimmedValue.startsWith( '{' ) && trimmedValue.endsWith( '}' ) ) || ( trimmedValue.startsWith( '[' ) && trimmedValue.endsWith( ']' ) ) )
                    {
                        try
                        {
                            value = JSON.parse( trimmedValue );
                        } catch ( e )
                        {
                            // It's not valid JSON, treat as a string.
                            value = value;
                        }
                    }
                    data[ key ] = value;
                } else if ( value.trim() )
                {
                    showMessage( `Field has a value but no key. Please provide a key or remove the field.` );
                    keyInput.focus();
                    hasError = true;
                }
            } );

            if ( hasError ) return;

            if ( Object.keys( data ).length === 0 )
            {
                showMessage( 'Data cannot be empty. Please add at least one key-value pair.' );
                return;
            }

            const authHeader = ShogunAdmin.getAuthHeaders();
            if ( !authHeader[ 'Authorization' ] )
            {
                showMessage( 'Auth Token is required. Please set it in the Control Panel.' );
                return;
            }

            // Show loading state
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading loading-spinner"></span> Creating...';

            try
            {
                // Use REST API instead of Gun directly
                const response = await fetch( `/api/v1/system/node/${ nodePath }`, {
                    method: 'POST',
                    headers: { ...authHeader, 'Content-Type': 'application/json' },
                    body: JSON.stringify( { data: data } )
                } );

                if ( !response.ok )
                {
                    const errorText = await response.text();
                    throw new Error( `HTTP error ${ response.status }: ${ errorText }` );
                }

                const result = await response.json();
                if ( result.success )
                {
                    showMessage( `Node created/updated successfully at "${ nodePath }"!`, 'success' );

                    // Clear form after success
                    nodePathInput.value = '';
                    jsonFieldsContainer.innerHTML = ''; // Clear fields
                    addField(); // Add a fresh empty field
                } else
                {
                    showMessage( `Failed to create node: ${ result.error || JSON.stringify( result ) }` );
                }

            } catch ( err )
            {
                console.error( 'Error details:', err );
                showMessage( `Error: ${ err.message }` );
            } finally
            {
                // Reset button state
                createBtn.disabled = false;
                createBtn.textContent = 'Create Node';
            }
        } );

        // Handle viewport resizing for mobile
        function adjustViewportHeight ()
        {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty( '--vh', `${ vh }px` );
        }

        window.addEventListener( 'resize', adjustViewportHeight );
        window.addEventListener( 'orientationchange', adjustViewportHeight );
        adjustViewportHeight();
    </script>
</body>

</html>