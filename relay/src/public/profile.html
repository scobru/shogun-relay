<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/wormhole.css">
</head>
<body class="antialiased">
    <div class="container mx-auto p-4">
        <div id="loading" class="text-center">
            <span class="loading loading-lg loading-spinner text-accent"></span>
            <p>Loading profile...</p>
        </div>

        <div id="profile-container" class="hidden">
            <!-- Profile Header -->
            <div class="card mb-8">
                <div class="p-8 flex items-center gap-6">
                    <div class="avatar">
                        <div class="w-24 rounded-full ring ring-accent ring-offset-base-100 ring-offset-2">
                            <img id="profile-avatar" src="https://placehold.co/128x128" alt="User Avatar" />
                        </div>
                    </div>
                    <div>
                        <h1 id="profile-name" class="text-3xl font-bold"></h1>
                        <p id="profile-username" class="text-accent"></p>
                        <p id="profile-summary" class="mt-2 text-base-content/80"></p>
                    </div>
                </div>
            </div>

            <!-- Outbox Posts -->
            <div>
                <h2 class="text-2xl font-semibold mb-4">Posts</h2>
                <div id="posts-container" class="space-y-4">
                    <!-- Posts will be injected here -->
                </div>
            </div>
        </div>
         <div id="error-container" class="hidden text-center">
            <p class="text-2xl text-error">Could not load profile.</p>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingEl = document.getElementById('loading');
            const profileEl = document.getElementById('profile-container');
            const errorEl = document.getElementById('error-container');

            const params = new URLSearchParams(window.location.search);
            const username = params.get('user');

            if (!username) {
                showError('No user specified in URL. Please use ?user=username');
                return;
            }

            try {
                // Fetch actor data
                const actorResponse = await fetch(`/ap/u/${username}`);
                if (!actorResponse.ok) {
                    throw new Error(`Actor not found: ${actorResponse.statusText}`);
                }
                const actor = await actorResponse.json();
                
                displayProfile(actor);

                // Fetch outbox data
                const outboxResponse = await fetch(actor.outbox);
                 if (!outboxResponse.ok) {
                    throw new Error(`Could not fetch outbox: ${outboxResponse.statusText}`);
                }
                const outbox = await outboxResponse.json();

                displayPosts(outbox.orderedItems);

                // Show profile and hide loading indicator
                loadingEl.classList.add('hidden');
                profileEl.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            }

            function showError(message) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                document.getElementById('error-message').textContent = message;
                console.error(message);
            }

            function displayProfile(actor) {
                document.title = `${actor.name} (@${actor.preferredUsername})`;
                document.getElementById('profile-name').textContent = actor.name || 'No name set';
                document.getElementById('profile-username').textContent = `@${actor.preferredUsername}`;
                document.getElementById('profile-summary').textContent = actor.summary || 'No bio set.';
                if (actor.icon && actor.icon.url) {
                    document.getElementById('profile-avatar').src = actor.icon.url;
                }
            }

            function displayPosts(posts) {
                const container = document.getElementById('posts-container');
                if (!posts || posts.length === 0) {
                    container.innerHTML = '<p>No posts yet.</p>';
                    return;
                }

                container.innerHTML = posts.map(post => {
                    // We only display notes for now
                    if (post.object && post.object.type === 'Note') {
                        const object = post.object;
                        return `
                            <div class="card bg-base-200">
                                <div class="p-6">
                                    <p class="text-lg">${object.content}</p>
                                    <p class="text-sm text-base-content/60 mt-4">
                                        Published on ${new Date(object.published).toLocaleString()}
                                    </p>
                                </div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            }
        });
    </script>
</body>
</html> 