<!DOCTYPE html>
<html lang="en" data-theme="night">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Dashboard - Shogun Relay</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <link href="styles/wormhole.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="lib/admin-nav.js"></script>
    <script src="lib/admin-auth.js"></script>
    <style>
        .service-card {
            transition: all 0.3s ease;
            border: 1px solid #606060;
            background-color: #404040;
            border-radius: 1rem;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.2);
            border-color: rgba(255, 105, 180, 0.3);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: all 0.3s ease;
        }

        .status-online {
            background-color: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background-color: #F44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
        }

        .status-warning {
            background-color: #FFA500;
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.5);
        }

        .status-unknown {
            background-color: #A0A0A0;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .restart-btn {
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(255, 165, 0, 0.3);
        }

        .service-actions {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .service-card:hover .service-actions {
            opacity: 1;
        }
    </style>
</head>

<body class="antialiased bg-[#1A1A1A]">
    <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-[#FFFFFF]">Services Dashboard</h1>
                <p class="text-[#A0A0A0] text-lg">Monitor and control Shogun Relay services</p>
            </div>
            <div class="flex gap-3">
                <button onclick="refreshAllServices()" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">Refresh All</button>
                <button onclick="clearAdminPassword()" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium" title="Clear stored admin password">Clear Auth</button>
                <a href="/pin-manager" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">Pin Manager</a>
                <a href="/" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">Back</a>
            </div>
        </div>

        <div id="alertPanel" class="alert alert-warning mb-8 bg-[#FFA500]/20 border-[#FFA500]/30 text-[#FFA500] rounded-xl p-4" style="display: none;">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span id="alertMessage">Some services are offline or experiencing issues</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

            <!-- Gun Relay Service -->
            <div class="service-card card shadow-xl">
                <div class="card-body p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="card-title text-lg text-[#FF69B4]">
                            <span class="status-indicator status-unknown pulse" id="gun-status-indicator"></span>
                            Gun Relay
                        </h2>
                        <div class="badge badge-outline bg-[#282828] border-[#606060] text-[#E0E0E0]" id="gun-uptime">--</div>
                    </div>

                    <div class="space-y-3 text-base">
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Status:</span><span id="gun-status" class="font-semibold text-[#FFFFFF]">Checking...</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Active Connections:</span><span id="gun-connections" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Total Connections:</span><span id="gun-total-connections" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Memory Usage:</span><span id="gun-memory" class="text-[#FFFFFF]">--</span></div>
                    </div>

                    <div class="card-actions justify-end mt-6 service-actions">
                        <button onclick="refreshService('gun')" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">🔄 Refresh</button>
                        <button onclick="restartService('gun')" class="btn bg-[#FFA500] hover:bg-[#FF8C00] border-0 text-[#FFFFFF] rounded-xl px-4 py-2 font-medium restart-btn">🔄 Restart</button>
                    </div>
                </div>
            </div>

            <!-- IPFS Service -->
            <div class="service-card card shadow-xl">
                <div class="card-body p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="card-title text-lg text-[#FF69B4]">
                            <span class="status-indicator status-unknown pulse" id="ipfs-status-indicator"></span>
                            IPFS Node
                        </h2>
                        <div class="badge badge-outline bg-[#282828] border-[#606060] text-[#E0E0E0]" id="ipfs-version">--</div>
                    </div>

                    <div class="space-y-3 text-base">
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Status:</span><span id="ipfs-status" class="font-semibold text-[#FFFFFF]">Checking...</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Storage Used:</span><span id="ipfs-storage" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Storage Max:</span><span id="ipfs-storage-max" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Usage %:</span><span id="ipfs-usage-percent" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Objects:</span><span id="ipfs-objects" class="text-[#FFFFFF]">--</span></div>
                        <div class="flex justify-between"><span class="text-[#E0E0E0]">Type:</span><span id="ipfs-type" class="text-[#FFFFFF]">--</span></div>
                    </div>

                    <div class="card-actions justify-end mt-6">
                        <button onclick="refreshService('ipfs')" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">🔄 Refresh</button>
                        <button onclick="restartService('ipfs')" class="btn bg-[#FFA500] hover:bg-[#FF8C00] border-0 text-[#FFFFFF] rounded-xl px-4 py-2 font-medium restart-btn">🔄 Restart</button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="service-card card shadow-xl">
                <div class="card-body p-6">
                    <h2 class="card-title text-lg text-[#FF69B4] mb-6">Quick Actions</h2>
                    <div class="space-y-4">
                        <button onclick="healthCheck()" class="btn bg-[#4CAF50] hover:bg-[#45A049] border-0 text-[#FFFFFF] w-full rounded-xl px-6 py-3 font-medium">🔍 Health Check</button>
                        <button onclick="restartAllServices()" class="btn bg-[#FFA500] hover:bg-[#FF8C00] border-0 text-[#FFFFFF] w-full rounded-xl px-6 py-3 font-medium">🔄 Restart All</button>
                    </div>
                    <div class="mt-6">
                        <p class="text-sm text-[#A0A0A0]">Last updated: <span id="last-update" class="text-[#E0E0E0]">--</span></p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Logs Section -->
        <div class="card bg-[#404040] border-[#606060] rounded-xl mt-8">
            <div class="card-body p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="card-title text-[#FF69B4] text-xl">Service Logs</h2>
                    <button onclick="clearLogs()" class="btn bg-transparent border-[#606060] text-[#E0E0E0] hover:bg-[#404040] rounded-xl px-4 py-2 font-medium">Clear</button>
                </div>
                <div id="service-logs" class="bg-[#282828] rounded-xl p-4 font-mono text-base h-40 overflow-y-auto text-[#E0E0E0]">
                    <div class="text-[#A0A0A0]">Service monitoring initialized...</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let updateInterval;
        let servicesStatus = {};

        function getAdminPassword() {
            return ShogunAdmin.getPassword();
        }

        function log(message, level = 'info') {
            const logs = document.getElementById('service-logs');
            const timestamp = new Date().toLocaleTimeString();
            const levelIcon = { 'info': 'ℹ', 'success': '', 'warning': '', 'error': '' }[level] || 'ℹ';

            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${levelIcon} ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;

            while (logs.children.length > 50) {
                logs.removeChild(logs.firstChild);
            }
        }

        function clearLogs() {
            document.getElementById('service-logs').innerHTML = '<div class="text-[#A0A0A0]">Logs cleared...</div>';
        }

        function clearAdminPassword() {
            ShogunAdmin.clearPassword();
            log('🔑 Admin password cleared from storage', 'info');
        }

        function updateStatusIndicator(service, status) {
            const indicator = document.getElementById(`${service}-status-indicator`);
            if (!indicator) return;

            indicator.className = 'status-indicator ' + {
                'online': 'status-online',
                'offline': 'status-offline',
                'warning': 'status-warning',
                'unknown': 'status-unknown pulse'
            }[status];

            servicesStatus[service] = status;
            checkForAlerts();
        }

        function checkForAlerts() {
            const alertPanel = document.getElementById('alertPanel');
            const offlineServices = Object.keys(servicesStatus).filter(service => servicesStatus[service] === 'offline');

            if (offlineServices.length > 0) {
                document.getElementById('alertMessage').textContent = `Services offline: ${offlineServices.join(', ')}`;
                alertPanel.style.display = 'block';
            } else {
                alertPanel.style.display = 'none';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        async function checkGunStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();

                document.getElementById('gun-status').textContent = data.status || 'Unknown';
                document.getElementById('gun-connections').textContent = data.activeConnections || 0;
                document.getElementById('gun-total-connections').textContent = data.totalConnections || 0;
                document.getElementById('gun-memory').textContent = formatBytes(data.memoryUsage?.heapUsed || 0);
                document.getElementById('gun-uptime').textContent = formatUptime(data.uptime || 0);

                updateStatusIndicator('gun', data.status === 'healthy' ? 'online' : 'offline');
                return true;
            } catch (error) {
                document.getElementById('gun-status').textContent = 'Offline';
                updateStatusIndicator('gun', 'offline');
                log(`Gun Relay check failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkIPFSStatus() {
            try {
                // Use the relay's IPFS status endpoint instead of direct connection
                const response = await fetch('/api/v1/ipfs/status');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('ipfs-status').textContent = 'Online';
                    document.getElementById('ipfs-version').textContent = data.version || '--';
                    document.getElementById('ipfs-type').textContent = 'IPFS';
                    
                    // Get repository statistics using relay API
                    try {
                        const password = getAdminPassword();
                        if (password) {
                            const statsResponse = await fetch('/api/v1/ipfs/repo/stat', {
                                headers: { 'Authorization': `Bearer ${password}` }
                            });
                            
                            if (statsResponse.ok) {
                                const statsData = await statsResponse.json();
                                if (statsData.success && statsData.stats) {
                                    const usedMB = statsData.stats.repoSizeMB || 0;
                                    const maxMB = statsData.stats.storageMaxMB || 0;
                                    const usagePercent = maxMB > 0 ? Math.round((usedMB / maxMB) * 100) : 0;
                                    
                                    document.getElementById('ipfs-storage').textContent = `${usedMB} MB`;
                                    document.getElementById('ipfs-storage-max').textContent = `${maxMB} MB`;
                                    document.getElementById('ipfs-usage-percent').textContent = `${usagePercent}%`;
                                    document.getElementById('ipfs-objects').textContent = statsData.stats.numObjects;
                                } else {
                                    document.getElementById('ipfs-storage').textContent = '--';
                                    document.getElementById('ipfs-storage-max').textContent = '--';
                                    document.getElementById('ipfs-usage-percent').textContent = '--';
                                    document.getElementById('ipfs-objects').textContent = '--';
                                }
                            } else {
                                document.getElementById('ipfs-storage').textContent = '--';
                                document.getElementById('ipfs-storage-max').textContent = '--';
                                document.getElementById('ipfs-usage-percent').textContent = '--';
                                document.getElementById('ipfs-objects').textContent = '--';
                            }
                        } else {
                            document.getElementById('ipfs-storage').textContent = 'Need Auth';
                            document.getElementById('ipfs-storage-max').textContent = 'Need Auth';
                            document.getElementById('ipfs-usage-percent').textContent = 'Need Auth';
                            document.getElementById('ipfs-objects').textContent = 'Need Auth';
                        }
                    } catch (statsError) {
                        console.warn('Failed to get IPFS stats:', statsError);
                        document.getElementById('ipfs-storage').textContent = '--';
                        document.getElementById('ipfs-storage-max').textContent = '--';
                        document.getElementById('ipfs-usage-percent').textContent = '--';
                        document.getElementById('ipfs-objects').textContent = '--';
                    }
                    
                    updateStatusIndicator('ipfs', 'online');
                    return true;
                } else {
                    throw new Error(data.error || 'IPFS offline');
                }
            } catch (error) {
                document.getElementById('ipfs-status').textContent = 'Offline';
                document.getElementById('ipfs-version').textContent = '--';
                document.getElementById('ipfs-type').textContent = '--';
                document.getElementById('ipfs-storage').textContent = '--';
                document.getElementById('ipfs-storage-max').textContent = '--';
                document.getElementById('ipfs-usage-percent').textContent = '--';
                document.getElementById('ipfs-objects').textContent = '--';
                updateStatusIndicator('ipfs', 'offline');
                log(`IPFS check failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkS3Status() {
            const password = getAdminPassword();
            if (!password) {
                document.getElementById('s3-status').textContent = 'No Auth';
                updateStatusIndicator('s3', 'warning');
                return false;
            }

            try {
                const response = await fetch('/api/v1/services/s3-stats', {
                    headers: { 'Authorization': `Bearer ${password}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('s3-status').textContent = 'Online';
                    document.getElementById('s3-buckets').textContent = `${data.stats.totalBuckets} buckets`;
                    document.getElementById('s3-objects').textContent = data.stats.totalObjects;
                    document.getElementById('s3-size').textContent = formatBytes(data.stats.totalSize);
                    updateStatusIndicator('s3', 'online');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('s3-status').textContent = 'Offline';
                document.getElementById('s3-buckets').textContent = '--';
                document.getElementById('s3-objects').textContent = '--';
                document.getElementById('s3-size').textContent = '--';
                updateStatusIndicator('s3', 'offline');
                log(`S3 check failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function refreshService(service) {
            log(`Refreshing ${service} service...`, 'info');

            switch (service) {
                case 'gun': await checkGunStatus(); break;
                case 'ipfs': await checkIPFSStatus(); break;
                case 's3': await checkS3Status(); break;
            }

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function refreshAllServices() {
            log('Refreshing all services...', 'info');

            await Promise.all([checkGunStatus(), checkIPFSStatus(), checkS3Status()]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            log('All services refreshed', 'success');
        }

        async function restartService(service) {
            const password = getAdminPassword();
            if (!password) {
                alert('⚠️ Admin password required for service restart');
                return;
            }

            if (!confirm(`Are you sure you want to restart the ${service} service? This may cause temporary downtime.`)) {
                return;
            }

            try {
                log(`Restarting ${service} service...`, 'info');
                const response = await fetch(`/api/v1/services/${service}/restart`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${password}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        // If JSON parsing fails, treat as success since HTTP status is ok
                        log(`✅ ${service} service restart initiated (HTTP ${response.status})`, 'success');
                        setTimeout(() => refreshService(service), 3000);
                        return;
                    }

                    if (data.success !== false) {
                        log(`✅ ${service} service restart: ${data.message || 'initiated successfully'}`, 'success');
                        // Wait a moment then refresh the service status
                        setTimeout(() => refreshService(service), 3000);
                    } else {
                        throw new Error(data.error || 'Restart failed');
                    }
                } else {
                    // Try to get error message from response
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || `HTTP ${response.status}`;
                    } catch {
                        errorMessage = `HTTP ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                log(`❌ ${service} restart failed: ${error.message}`, 'error');
            }
        }

        async function restartAllServices() {
            const password = getAdminPassword();
            if (!password) {
                alert('⚠️ Admin password required for service restart');
                return;
            }

            if (!confirm('Are you sure you want to restart ALL services? This will cause temporary downtime.')) {
                return;
            }

            log('🔄 Restarting all services...', 'info');

            const services = ['gun', 'ipfs', 's3'];
            for (const service of services) {
                try {
                    await restartService(service);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s between restarts
                } catch (error) {
                    log(`Failed to restart ${service}: ${error.message}`, 'error');
                }
            }

            // Refresh all services after restart attempts
            setTimeout(refreshAllServices, 5000);
        }


        async function healthCheck() {
            log('Running comprehensive health check...', 'info');
            await refreshAllServices();

            const allOnline = Object.values(servicesStatus).every(status => status === 'online');
            if (allOnline) {
                log(' All services are healthy', 'success');
            } else {
                log(' Some services need attention', 'warning');
            }
        }

        window.addEventListener('load', async () => {
            // Initialize ShogunAdmin
            ShogunAdmin.init();
            
            log('Services dashboard initialized', 'info');
            await refreshAllServices();
            updateInterval = setInterval(refreshAllServices, 30000);
        });

        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
    </script>
</body>

</html>