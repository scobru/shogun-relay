<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Network Statistics - Shogun Relay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/google-md3.css">
    <style>
        .page-header {
            background-color: var(--md-surface-container-low);
            border-bottom: 1px solid var(--md-outline-variant);
            padding: 24px;
            margin-bottom: 32px;
        }

        .page-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .page-title-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: linear-gradient(135deg, #42A5F5, #1E88E5);
            box-shadow: 0 8px 24px rgba(66, 165, 245, 0.3);
        }

        .page-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--md-primary);
            box-shadow: var(--md-elevation-1);
        }

        .stat-title {
            color: var(--md-primary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 500;
            color: var(--md-on-surface);
            font-family: var(--md-font-display);
        }

        .stat-unit {
            color: var(--md-on-surface-variant);
            font-size: 0.875rem;
            margin-top: 4px;
        }

        .section-card {
            background-color: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-card h2 {
            color: var(--md-primary);
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background-color: var(--md-surface-container-low);
            color: var(--md-primary);
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid var(--md-outline-variant);
            font-weight: 500;
        }

        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid var(--md-outline-variant);
            color: var(--md-on-surface);
        }

        .leaderboard-table tr:hover {
            background-color: var(--md-surface-container-high);
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tier-platinum {
            background-color: #E5E4E2;
            color: #1A1A1A;
        }

        .tier-gold {
            background-color: #FFD700;
            color: #1A1A1A;
        }

        .tier-silver {
            background-color: #C0C0C0;
            color: #1A1A1A;
        }

        .tier-bronze {
            background-color: #CD7F32;
            color: #FFFFFF;
        }

        .tier-basic {
            background-color: var(--md-surface-container-high);
            color: var(--md-on-surface);
        }

        .score-bar {
            height: 6px;
            background-color: var(--md-surface-container-low);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--md-primary), #FF1493);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--md-on-surface-variant);
        }

        .stat-data {
            color: var(--md-on-surface);
            font-weight: 500;
            font-family: 'Roboto Mono', monospace;
        }

        .loading {
            text-align: center;
            padding: 32px;
            color: var(--md-on-surface-variant);
        }

        .error-message {
            background-color: var(--md-error-container);
            color: var(--md-error);
            border-left: 3px solid var(--md-error);
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            display: none;
        }

        #storageBreakdown {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--md-outline-variant);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <a href="/admin" class="md-btn md-btn-icon" title="Back">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <div class="page-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
                    </svg>
                </div>
                <div>
                    <h1 class="md-headline-medium">Network Statistics</h1>
                    <p class="md-body-medium md-text-secondary">Comprehensive network-wide metrics</p>
                </div>
            </div>
            <button onclick="refreshAll()" class="md-btn md-btn-filled">üîÑ Refresh All</button>
        </div>
    </header>

    <main class="md-container">
        <!-- Error Display -->
        <div id="error" class="error-message"></div>

        <!-- Network Overview -->
        <div class="section-card">
            <h2>üåê Network Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Relays</div>
                    <div class="stat-value" id="totalRelays">-</div>
                    <div class="stat-unit">relays</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Relays</div>
                    <div class="stat-value" id="activeRelays">-</div>
                    <div class="stat-unit">relays</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Connections</div>
                    <div class="stat-value" id="totalConnections">-</div>
                    <div class="stat-unit">connections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Storage</div>
                    <div class="stat-value" id="totalStorage">-</div>
                    <div class="stat-unit" id="storageUnit">GB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Pins</div>
                    <div class="stat-value" id="totalPins">-</div>
                    <div class="stat-unit">pins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Deals</div>
                    <div class="stat-value" id="activeDealsCount">-</div>
                    <div class="stat-unit">deals</div>
                </div>
            </div>
            <div id="storageBreakdown" style="display: none;">
                <h3 class="md-title-medium md-mb-md" style="color: var(--md-primary);">Storage Breakdown</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="stat-item">
                        <span class="stat-label">From Deals:</span>
                        <span class="stat-data" id="dealStorageMB">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">From Subscriptions:</span>
                        <span class="stat-data" id="subscriptionStorageMB">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reputation Leaderboard -->
        <div class="section-card">
            <h2>‚≠ê Reputation Leaderboard</h2>
            <div id="reputationLoading" class="loading">Loading reputation data...</div>
            <div id="reputationContent" style="display: none;">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Relay Host</th>
                            <th>Score</th>
                            <th>Tier</th>
                            <th>Uptime %</th>
                            <th>Proofs</th>
                        </tr>
                    </thead>
                    <tbody id="reputationTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Deals Statistics -->
        <div class="section-card">
            <h2>üíº Storage Deals</h2>
            <div id="dealsLoading" class="loading">Loading deals statistics...</div>
            <div id="dealsContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Total Deals</div>
                        <div class="stat-value" id="totalDeals">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Active Deals</div>
                        <div class="stat-value" id="activeDeals">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Size</div>
                        <div class="stat-value" id="totalDealSize">-</div>
                        <div class="stat-unit">MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Revenue</div>
                        <div class="stat-value" id="totalRevenue">-</div>
                        <div class="stat-unit">USDC</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registry Information -->
        <div class="section-card">
            <h2>üìã Registry Information</h2>
            <div id="registryLoading" class="loading">Loading registry data...</div>
            <div id="registryContent" style="display: none;">
                <div class="stat-item">
                    <span class="stat-label">Chain ID:</span>
                    <span class="stat-data" id="registryChainId">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Registry Address:</span>
                    <span class="stat-data" id="registryAddress">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Min Stake:</span>
                    <span class="stat-data" id="minStake">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Registered Relays:</span>
                    <span class="stat-data" id="registeredRelays">-</span>
                </div>
            </div>
        </div>

        <div id="lastUpdated" class="md-body-small md-text-secondary md-text-center md-mt-lg"></div>

        <!-- Footer -->
        <footer class="md-footer">
            <p class="md-body-small">
                Shogun Network Stats ‚Äî Part of the <a href="https://github.com/scobru/shogun">Shogun Project</a>
            </p>
        </footer>
    </main>

    <script src="lib/admin-auth.js"></script>
    <script src="lib/admin-nav.js"></script>
    <script>
        let networkStatsData = null;

        function formatNumber(n) {
            if (n === null || n === undefined) return '-';
            if (typeof n === 'number') {
                if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
                return n.toLocaleString();
            }
            return n;
        }

        function getTierClass(score) {
            if (score >= 90) return 'tier-platinum';
            if (score >= 75) return 'tier-gold';
            if (score >= 60) return 'tier-silver';
            if (score >= 40) return 'tier-bronze';
            return 'tier-basic';
        }

        function getTierName(score) {
            if (score >= 90) return 'Platinum';
            if (score >= 75) return 'Gold';
            if (score >= 60) return 'Silver';
            if (score >= 40) return 'Bronze';
            return 'Basic';
        }

        async function fetchNetworkStats() {
            try {
                const response = await fetch('/api/v1/network/stats');
                const result = await response.json();
                networkStatsData = result;

                if (result.success && result.stats) {
                    const stats = result.stats;
                    document.getElementById('totalRelays').textContent = formatNumber(stats.totalRelays || 0);
                    document.getElementById('activeRelays').textContent = formatNumber(stats.activeRelays || 0);
                    document.getElementById('totalConnections').textContent = formatNumber(stats.totalConnections || 0);
                    document.getElementById('totalPins').textContent = formatNumber(stats.totalPins || 0);
                    document.getElementById('activeDealsCount').textContent = formatNumber(stats.totalActiveDeals || 0);

                    let totalStorageBytes = stats.totalStorageBytes || 0;
                    if (totalStorageBytes === 0 && stats.totalStorageMB) {
                        totalStorageBytes = stats.totalStorageMB * 1024 * 1024;
                    }
                    const storageGB = totalStorageBytes / (1024 * 1024 * 1024);
                    if (storageGB >= 1) {
                        document.getElementById('totalStorage').textContent = storageGB.toFixed(2);
                        document.getElementById('storageUnit').textContent = 'GB';
                    } else {
                        document.getElementById('totalStorage').textContent = formatNumber(Math.round(totalStorageBytes / (1024 * 1024)));
                        document.getElementById('storageUnit').textContent = 'MB';
                    }

                    const dealStorageMB = stats.totalDealStorageMB || 0;
                    const subscriptionStorageMB = stats.totalSubscriptionStorageMB || 0;
                    if (dealStorageMB > 0 || subscriptionStorageMB > 0) {
                        document.getElementById('storageBreakdown').style.display = 'block';
                        document.getElementById('dealStorageMB').textContent = formatNumber(dealStorageMB) + ' MB';
                        document.getElementById('subscriptionStorageMB').textContent = formatNumber(subscriptionStorageMB) + ' MB';
                    }
                }
            } catch (error) {
                console.error('Error fetching network stats:', error);
            }
        }

        async function fetchReputation() {
            try {
                document.getElementById('reputationLoading').style.display = 'block';
                document.getElementById('reputationContent').style.display = 'none';

                const response = await fetch('/api/v1/network/reputation?limit=50');
                const result = await response.json();

                if (result.success && result.leaderboard) {
                    const tbody = document.getElementById('reputationTableBody');
                    tbody.innerHTML = '';

                    result.leaderboard.forEach((relay, index) => {
                        const row = document.createElement('tr');
                        const score = relay.calculatedScore?.total || 0;
                        const uptime = relay.uptimePercent || 0;
                        const proofs = `${relay.proofsSuccessful || 0}/${relay.proofsTotal || 0}`;

                        row.innerHTML = `
                            <td>#${index + 1}</td>
                            <td>${relay.host || 'Unknown'}</td>
                            <td>
                                <div>${score.toFixed(2)}</div>
                                <div class="score-bar"><div class="score-bar-fill" style="width: ${score}%"></div></div>
                            </td>
                            <td><span class="tier-badge ${getTierClass(score)}">${getTierName(score)}</span></td>
                            <td>${uptime.toFixed(1)}%</td>
                            <td>${proofs}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    document.getElementById('reputationLoading').style.display = 'none';
                    document.getElementById('reputationContent').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('reputationLoading').textContent = 'Error loading reputation data';
            }
        }

        async function fetchDealsStats() {
            try {
                document.getElementById('dealsLoading').style.display = 'block';
                document.getElementById('dealsContent').style.display = 'none';

                let stats = { totalDeals: 0, activeDeals: 0, totalSizeMB: 0, totalRevenueUSDC: 0 };

                try {
                    const response = await fetch('/api/v1/deals/stats');
                    const result = await response.json();
                    if (result.success && result.stats) {
                        stats = result.stats;
                    }
                } catch (e) { }

                if (networkStatsData?.stats) {
                    if (stats.activeDeals === 0) stats.activeDeals = networkStatsData.stats.totalActiveDeals || 0;
                    if (stats.totalSizeMB === 0) stats.totalSizeMB = networkStatsData.stats.totalDealStorageMB || 0;
                }

                document.getElementById('totalDeals').textContent = formatNumber(stats.totalDeals || 0);
                document.getElementById('activeDeals').textContent = formatNumber(stats.activeDeals || 0);
                document.getElementById('totalDealSize').textContent = formatNumber(stats.totalSizeMB || 0);
                document.getElementById('totalRevenue').textContent = formatNumber(stats.totalRevenueUSDC || 0);

                document.getElementById('dealsLoading').style.display = 'none';
                document.getElementById('dealsContent').style.display = 'block';
            } catch (error) {
                document.getElementById('dealsLoading').textContent = 'Error loading deals';
            }
        }

        async function fetchRegistryInfo() {
            try {
                document.getElementById('registryLoading').style.display = 'block';
                document.getElementById('registryContent').style.display = 'none';

                const paramsResponse = await fetch('/api/v1/registry/params');
                const paramsResult = await paramsResponse.json();

                if (paramsResult.success) {
                    const params = paramsResult.params || {};
                    document.getElementById('registryChainId').textContent = paramsResult.chainId || '-';
                    document.getElementById('registryAddress').textContent = paramsResult.registryAddress ?
                        paramsResult.registryAddress.substring(0, 10) + '...' : '-';
                    document.getElementById('minStake').textContent = params.minStake ? formatNumber(params.minStake) : '-';
                }

                try {
                    const relaysResponse = await fetch('/api/v1/network/onchain/relays?chainId=84532');
                    const relaysResult = await relaysResponse.json();
                    if (relaysResult.success) {
                        document.getElementById('registeredRelays').textContent = formatNumber(relaysResult.relayCount || 0);
                    }
                } catch (e) { }

                document.getElementById('registryLoading').style.display = 'none';
                document.getElementById('registryContent').style.display = 'block';
            } catch (error) {
                document.getElementById('registryLoading').textContent = 'Error loading registry';
            }
        }

        async function refreshAll() {
            await fetchNetworkStats();
            fetchReputation();
            fetchDealsStats();
            fetchRegistryInfo();
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        refreshAll();
        setInterval(refreshAll, 30000);
    </script>
</body>

</html>